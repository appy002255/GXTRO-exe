# GXTRO åª’é«”ä¸‹è¼‰å·¥å…·
# å°ˆæ¡ˆä¸»é ï¼šhttps://github.com/appy002255/GXTRO-exe
# 
# æ›´æ–°æ—¥èªŒï¼š
#   v1.05 (2025-06)
#     - æ–°å¢å½±ç‰‡å‰ªè¼¯åŠŸèƒ½ï¼šæ”¯æ´æ™‚é–“è£å‰ªã€ç©ºé–“è£å‰ªã€è§£æåº¦èª¿æ•´ã€æ’­æ”¾é€Ÿåº¦èª¿æ•´
#     - æ•´åˆ VLC æ’­æ”¾å™¨ï¼šæ”¯æ´å½±ç‰‡é è¦½ã€æˆªåœ–ã€éŸ³é‡æ§åˆ¶ã€æ’­æ”¾é€Ÿåº¦èª¿æ•´
#     - æ–°å¢æµ®æ°´å°åŠŸèƒ½ï¼šæ”¯æ´è‡ªè¨‚ä½ç½®ã€å¤§å°ã€é€æ˜åº¦
#     - æ–°å¢èƒŒæ™¯éŸ³æ¨‚åŠŸèƒ½ï¼šæ”¯æ´æ··éŸ³ã€éŸ³é‡å¹³è¡¡
#     - å…¶ä»–ç´°ç¯€å„ªåŒ–èˆ‡éŒ¯èª¤ä¿®æ­£
#     - ä¿®æ­£æµ®æ°´å°åŠŸèƒ½ï¼šå„ªåŒ– filter_complex å‘½ä»¤ï¼Œç¢ºä¿æ­£ç¢ºæ˜ å°„éŸ³è¨Šå’Œè¦–è¨Šæµ
#     - æ”¹é€²åŸ·è¡Œç·’è™•ç†ï¼šä½¿ç”¨ Qt äº‹ä»¶æ©Ÿåˆ¶ç¢ºä¿ UI æ“ä½œåœ¨ä¸»åŸ·è¡Œç·’ä¸­åŸ·è¡Œ
#     - å„ªåŒ–éŸ³è¨Šè™•ç†ï¼šæå‡éŸ³è¨Šå“è³ªï¼Œè¨­å®š 192k ä½å…ƒç‡
#     - å…¶ä»–ç´°ç¯€å„ªåŒ–èˆ‡éŒ¯èª¤ä¿®æ­£
#   v1.03 (2025-05)
#     - LOGOå€å¡Šå„ªåŒ–ï¼šå·¦ä¸Šè§’ icon æ”¹ç‚ºâ¬‡ï¸ï¼Œå­—é«”ç¾ä»£æ„Ÿã€äº®è—è‰²ã€å­—è·å¯¬ï¼Œæ›´æ™‚å°š
#     - æ–°å¢ã€ŒåµŒå…¥å°é¢åœ–ã€èˆ‡ã€ŒåµŒå…¥ä½œè€…è³‡è¨Šã€å…©å€‹ç¨ç«‹é¸é …ï¼Œå¯è‡ªè¨‚æ˜¯å¦åµŒå…¥åˆ° mp3/mp4
#     - ä¿®æ­£æ—¥èªŒå€ç¸®æ’å•é¡Œï¼Œè¨Šæ¯é¡¯ç¤ºæ›´ç©©å®š
#     - å…¶ä»–ç´°ç¯€å„ªåŒ–èˆ‡éŒ¯èª¤ä¿®æ­£
#   v1.02 (2025-04)
#     - é è¨­æš—è‰²ä¸»é¡Œï¼Œæ‰€æœ‰å…ƒä»¶å®Œæ•´é»‘è‰²ç¾åŒ–
#     - æ”¯æ´å¤šå¹³å°å½±ç‰‡/ç›´æ’­ä¸‹è¼‰ï¼ŒInstagram/TikTok/Bilibili URL è‡ªå‹•æ¸…ç†
#     - æ”¯æ´ç•«è³ª/æ ¼å¼é¸æ“‡ã€å½±ç‰‡å°é¢é è¦½ã€ç°¡æ½”/è©³ç´°æ—¥èªŒåˆ‡æ›
#     - LOG ç°¡æ½”æ¨¡å¼ä¸‹ GUI ä¹Ÿå®Œæ•´é¡¯ç¤ºæ‰€æœ‰è¨Šæ¯
#     - "é—œæ–¼æœ¬ç¨‹å¼"å½ˆçª—æ”¯æ´è¶…é€£çµèˆ‡æš—è‰²ç¾åŒ–
#     - æ‰“åŒ…æ”¯æ´ yt-dlp.exe/ffmpeg ç›®éŒ„
#     - å…¶ä»–ç´°ç¯€å„ªåŒ–èˆ‡éŒ¯èª¤ä¿®æ­£
# 
# èªªæ˜ï¼š
#   - æ”¯æ´ YouTubeã€Bilibiliã€Twitterã€Facebookã€Instagramã€Vimeoã€Twitchã€TikTok ç­‰å¤šå¹³å°å½±ç‰‡ä¸‹è¼‰
#   - æ”¯æ´éƒ¨åˆ†å¹³å°ç›´æ’­ä¸‹è¼‰
#   - ä»‹é¢æ¡ç”¨ PyQt5ï¼Œæ”¯æ´æš—è‰²ä¸»é¡Œ
#   - å…§å»ºç•«è³ª/æ ¼å¼é¸æ“‡ã€å½±ç‰‡å°é¢é è¦½ã€ç°¡æ½”/è©³ç´°æ—¥èªŒåˆ‡æ›
#   - è‡ªå‹•æ¸…ç†èˆ‡æ“·å–ç¶²å€ï¼Œæ”¯æ´è¤‡è£½é›œè¨Šå…§å®¹
#   - å…è²¬è²æ˜ï¼šåƒ…ä¾›å­¸è¡“äº¤æµèˆ‡å€‹äººç”¨é€”ï¼Œè«‹å‹¿ç”¨æ–¼éæ³•ç”¨é€”
#   - ä½œè€…ï¼šå·«æ¯’é«˜å³°
#   - æˆæ¬Šï¼šMIT License
#
# ä½¿ç”¨æ–¹å¼ã€è©³ç´°èªªæ˜è«‹è¦‹ GitHub å°ˆæ¡ˆé ã€‚

import sys
import os
import socket
import threading
import subprocess
import re
import shutil
import psutil
import traceback
import time
import requests
from io import BytesIO
import tempfile
import json
from datetime import datetime
import ctypes
from ctypes.util import find_library
from PyQt5.QtCore import QThread, pyqtSignal, QTimer, QSize, QCoreApplication, QUrl, QMetaObject
from github import Github # ç§»åˆ°é ‚éƒ¨
import urllib.parse


class GitHubInstaller:
    def __init__(self, repo_owner, repo_name):
        self.repo_owner = repo_owner
        self.repo_name = repo_name
        try:
            # ä½¿ç”¨ GitHub å€‹äººè¨ªå•ä»¤ç‰Œé€²è¡Œèªè­‰
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            # 
            self.github = Github("github_pat_")# è«‹è‡ªè¡Œç”Ÿæˆä¸¦å¡«å…¥
            print(f"DEBUG: å˜—è©¦é€£æ¥å€‰åº« {repo_owner}/{repo_name}")
            self.repo = self.github.get_repo(f"{repo_owner}/{repo_name}")
            print(f"DEBUG: å€‰åº«æè¿°: {self.repo.description}")
            print(f"DEBUG: å€‰åº« URL: {self.repo.html_url}")
            # æ¸¬è©¦ API é€£æ¥
            releases = self.repo.get_releases()
            print(f"DEBUG: å€‰åº«ç™¼å¸ƒæ•¸é‡: {releases.totalCount}")
            self.repo.get_releases()
            print("DEBUG: GitHub API é€£æ¥æˆåŠŸ")
        except Exception as e:
            print(f"DEBUG: GitHub API é€£æ¥å¤±æ•—: {str(e)}")
            raise Exception(f"ç„¡æ³•é€£æ¥åˆ° GitHub API: {str(e)}")

    def get_latest_release(self):
        """ç²å–æœ€æ–°çš„ç™¼å¸ƒç‰ˆæœ¬"""
        try:
            print("DEBUG: é–‹å§‹ç²å–æœ€æ–°ç‰ˆæœ¬")
            releases = self.repo.get_releases()
            latest_release = None
            latest_version = None

            print(f"DEBUG: é–‹å§‹éæ­·ç™¼å¸ƒç‰ˆæœ¬")
            for release in releases:
                print(f"DEBUG: æª¢æŸ¥ç™¼å¸ƒç‰ˆæœ¬: {release.tag_name}")
                # ä¿®æ”¹æ­£å‰‡è¡¨é”å¼ä»¥åŒ¹é… gxtrov1.06 æ ¼å¼
                version_match = re.search(r'gxtrov?(\d+\.\d+)', release.tag_name)
                if version_match:
                    version = version_match.group(1)
                    print(f"DEBUG: è§£æç‰ˆæœ¬è™Ÿ: {version}")
                    if latest_version is None or version > latest_version:
                        latest_version = version
                        latest_release = release
                        print(f"DEBUG: æ‰¾åˆ°æ–°ç‰ˆæœ¬ {version}")

            if latest_release:
                print(f"DEBUG: æœ€æ–°ç‰ˆæœ¬æ˜¯ {latest_release.tag_name}")
                return latest_release
            print("DEBUG: æ²’æœ‰æ‰¾åˆ°ä»»ä½•ç‰ˆæœ¬")
            return None

        except Exception as e:
            print(f"DEBUG: ç²å–æœ€æ–°ç‰ˆæœ¬æ™‚å‡ºéŒ¯: {str(e)}")
            return None


class VersionCheckThread(QThread):
    update_available = pyqtSignal(str, str)
    no_update = pyqtSignal()
    error_checking = pyqtSignal(str)

    def __init__(self, current_version, repo_owner, repo_name):
        super().__init__()
        self.current_version = current_version
        self.repo_owner = repo_owner
        self.repo_name = repo_name

    def parse_version(self, version_str):
        """è§£æç‰ˆæœ¬è™Ÿå­—ä¸²ç‚ºå…ƒçµ„"""
        try:
            # ç§»é™¤æ‰€æœ‰éæ•¸å­—å’Œé»çš„å­—å…ƒ
            version_str = re.sub(r'[^\d.]', '', version_str)
            parts = version_str.split('.')
            # ç¢ºä¿è‡³å°‘æœ‰ä¸»ç‰ˆæœ¬è™Ÿå’Œæ¬¡ç‰ˆæœ¬è™Ÿ
            while len(parts) < 2:
                parts.append('0')
            # è½‰æ›ç‚ºæ•´æ•¸å…ƒçµ„
            return tuple(map(int, parts))
        except Exception as e:
            print(f"DEBUG: ç‰ˆæœ¬è™Ÿè§£æéŒ¯èª¤: {str(e)}")
            return (0, 0, 0)

    def compare_versions(self, current, latest):
        """æ¯”è¼ƒå…©å€‹ç‰ˆæœ¬è™Ÿ"""
        try:
            current_parts = self.parse_version(current)
            latest_parts = self.parse_version(latest)
            
            # ç¢ºä¿å…©å€‹ç‰ˆæœ¬è™Ÿæœ‰ç›¸åŒæ•¸é‡çš„éƒ¨åˆ†
            max_parts = max(len(current_parts), len(latest_parts))
            current_parts = current_parts + (0,) * (max_parts - len(current_parts))
            latest_parts = latest_parts + (0,) * (max_parts - len(latest_parts))
            
            return latest_parts > current_parts
        except Exception as e:
            print(f"DEBUG: ç‰ˆæœ¬æ¯”è¼ƒéŒ¯èª¤: {str(e)}")
            return False

    def run(self):
        try:
            print("DEBUG: é–‹å§‹ç‰ˆæœ¬æª¢æŸ¥")
            
            # æ¸¬è©¦ç¶²è·¯é€£æ¥
            try:
                print("DEBUG: æ¸¬è©¦ GitHub API é€£æ¥")
                response = requests.get("https://api.github.com", timeout=5)
                response.raise_for_status()
                print(f"DEBUG: GitHub API éŸ¿æ‡‰ç‹€æ…‹ç¢¼: {response.status_code}")
            except requests.RequestException as e:
                print(f"DEBUG: GitHub API é€£æ¥æ¸¬è©¦å¤±æ•—: {str(e)}")
                self.error_checking.emit(f"ç„¡æ³•é€£æ¥åˆ° GitHub: {str(e)}")
                return

            # å‰µå»º GitHubInstaller å¯¦ä¾‹
            print("DEBUG: å‰µå»º GitHubInstaller å¯¦ä¾‹")
            installer = GitHubInstaller(self.repo_owner, self.repo_name)
            latest_release = installer.get_latest_release()

            if latest_release:
                latest_tag_name = latest_release.tag_name
                print(f"DEBUG: å¾ GitHub ç²å–çš„æœ€æ–°æ¨™ç±¤: {latest_tag_name}")
                
                # å¾æ¨™ç±¤åç¨±ä¸­æå–ç‰ˆæœ¬è™Ÿ
                version_match = re.search(r'gxtrov?(\d+\.\d+(?:\.\d+)?)', latest_tag_name)
                if version_match:
                    latest_version_str = version_match.group(1)
                    print(f"DEBUG: ç•¶å‰ç‰ˆæœ¬: {self.current_version}")
                    print(f"DEBUG: æœ€æ–°ç‰ˆæœ¬: {latest_version_str}")
                    
                    # æ¯”è¼ƒç‰ˆæœ¬
                    if self.compare_versions(self.current_version, latest_version_str):
                        release_url = latest_release.html_url
                        print(f"DEBUG: ç™¼ç¾æ–°ç‰ˆæœ¬ï¼Œç™¼é€æ›´æ–°ä¿¡è™Ÿ")
                        self.update_available.emit(latest_tag_name, release_url)
                    else:
                        print("DEBUG: ç•¶å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬")
                        self.no_update.emit()
                else:
                    print("DEBUG: ç„¡æ³•è§£æç‰ˆæœ¬è™Ÿ")
                    self.error_checking.emit("ç„¡æ³•è§£ææœ€æ–°ç‰ˆæœ¬è™Ÿ")
            else:
                print("DEBUG: æ²’æœ‰æ‰¾åˆ°ç™¼å¸ƒç‰ˆæœ¬")
                self.no_update.emit()
        except Exception as e:
            print(f"DEBUG: ç‰ˆæœ¬æª¢æŸ¥éç¨‹å‡ºéŒ¯: {str(e)}")
            self.error_checking.emit(f"æª¢æŸ¥æ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}")

def get_base_path():
    """ç²å–æ‡‰ç”¨ç¨‹å¼çš„åŸºæœ¬è·¯å¾‘"""
    if getattr(sys, 'frozen', False):
        # å¦‚æœæ˜¯æ‰“åŒ…å¾Œçš„ exe
        return os.path.dirname(sys.executable)
    else:
        # å¦‚æœæ˜¯é–‹ç™¼ç’°å¢ƒ
        return os.path.dirname(os.path.abspath(__file__))

def setup_vlc_environment():
    """è¨­å®š VLC ç’°å¢ƒ"""
    try:
        # ç²å–åŸºç¤è·¯å¾‘
        base_path = get_base_path()
        print(f"åŸºç¤è·¯å¾‘ï¼š{base_path}")
        
        # æª¢æŸ¥ VLC è³‡æ–™å¤¾
        vlc_path = os.path.join(base_path, 'vlc-3.0.21')
        
        if not os.path.exists(vlc_path):
            print(f"è­¦å‘Šï¼šæ‰¾ä¸åˆ° VLC è³‡æ–™å¤¾ï¼š{vlc_path}")
            return False
        
        print(f"VLC è·¯å¾‘ï¼š{vlc_path}")
        
        # æª¢æŸ¥å¿…è¦çš„ DLL æª”æ¡ˆ
        libvlc_path = os.path.join(vlc_path, 'libvlc.dll')
        libvlccore_path = os.path.join(vlc_path, 'libvlccore.dll')
        
        if not os.path.exists(libvlc_path):
            print(f"è­¦å‘Šï¼šæ‰¾ä¸åˆ° libvlc.dllï¼š{libvlc_path}")
            return False
            
        if not os.path.exists(libvlccore_path):
            print(f"è­¦å‘Šï¼šæ‰¾ä¸åˆ° libvlccore.dllï¼š{libvlccore_path}")
            return False
            
        # è¨­å®šç’°å¢ƒè®Šæ•¸
        os.environ['VLC_PLUGIN_PATH'] = os.path.join(vlc_path, 'plugins')
        os.environ['PATH'] = vlc_path + os.pathsep + os.environ['PATH']
        
        print(f"VLC æ’ä»¶è·¯å¾‘ï¼š{os.environ['VLC_PLUGIN_PATH']}")
        print(f"ç³»çµ±è·¯å¾‘ï¼š{os.environ['PATH']}")
        
        # è¨­å®š DLL æœå°‹è·¯å¾‘
        if hasattr(os, 'add_dll_directory'):
            os.add_dll_directory(vlc_path)
            
        # è¼‰å…¥ DLL
        try:
            # å…ˆè¼‰å…¥ libvlccore.dll
            ctypes.CDLL(libvlccore_path)
            # å†è¼‰å…¥ libvlc.dll
            ctypes.CDLL(libvlc_path)
        except Exception as e:
            print(f"è­¦å‘Šï¼šç„¡æ³•è¼‰å…¥ VLC DLLï¼š{str(e)}")
            return False
            
        return True
    except Exception as e:
        print(f"VLC ç’°å¢ƒè¨­å®šéŒ¯èª¤ï¼š{str(e)}")
        return False

# åœ¨å°å…¥ vlc æ¨¡çµ„å‰è¨­å®šç’°å¢ƒ
if not setup_vlc_environment():
    print("éŒ¯èª¤ï¼šç„¡æ³•è¨­å®š VLC ç’°å¢ƒã€‚")
    sys.exit(1)

# ç¾åœ¨å¯ä»¥å®‰å…¨åœ°å°å…¥ vlc æ¨¡çµ„
import vlc

def init_vlc():
    """åˆå§‹åŒ– VLC å¯¦ä¾‹"""
    try:
        # ä½¿ç”¨åŸºæœ¬çš„ VLC åƒæ•¸
        instance = vlc.Instance('--no-video-title-show')
        if not instance:
            print("è­¦å‘Šï¼šç„¡æ³•åˆå§‹åŒ– VLC å¯¦ä¾‹")
            return None
        return instance
    except Exception as e:
        print(f"VLC åˆå§‹åŒ–éŒ¯èª¤ï¼š{str(e)}")
        return None

# åˆå§‹åŒ– VLC
VLC_INSTANCE = init_vlc()
if not VLC_INSTANCE:
    print("éŒ¯èª¤ï¼šç„¡æ³•å‰µå»º VLC å¯¦ä¾‹ã€‚")
    sys.exit(1)

# è¨­ç½® VLC è·¯å¾‘
if getattr(sys, 'frozen', False):
    # å¦‚æœæ˜¯æ‰“åŒ…å¾Œçš„åŸ·è¡Œæª”
    base_path = os.path.dirname(sys.executable)
else:
    # å¦‚æœæ˜¯é–‹ç™¼ç’°å¢ƒ
    base_path = os.path.dirname(os.path.abspath(__file__))

vlc_path = os.path.join(base_path, 'vlc-3.0.21')
os.environ['VLC_PLUGIN_PATH'] = os.path.join(vlc_path, 'plugins')

# åœ¨å°å…¥ä»»ä½• PyQt5 çµ„ä»¶ä¹‹å‰è¨­ç½®é«˜ DPI å±¬æ€§
from PyQt5.QtCore import Qt, QCoreApplication, QUrl, QEvent
QCoreApplication.setAttribute(Qt.AA_EnableHighDpiScaling, True)
QCoreApplication.setAttribute(Qt.AA_UseHighDpiPixmaps, True)
QCoreApplication.setAttribute(Qt.AA_Use96Dpi, True)

# å®šç¾©è‡ªå®šç¾©äº‹ä»¶é¡å‹
class FfmpegCompleteEvent(QEvent):
    EVENT_TYPE = QEvent.Type(QEvent.registerEventType())
    def __init__(self, output_path):
        super().__init__(self.EVENT_TYPE)
        self.output_path = output_path

class FfmpegErrorEvent(QEvent):
    EVENT_TYPE = QEvent.Type(QEvent.registerEventType())
    def __init__(self, error_msg):
        super().__init__(self.EVENT_TYPE)
        self.error_msg = error_msg

class ScreenshotCompleteEvent(QEvent):
    EVENT_TYPE = QEvent.Type(QEvent.registerEventType())
    def __init__(self, output_path):
        super().__init__(self.EVENT_TYPE)
        self.output_path = output_path

class ScreenshotErrorEvent(QEvent):
    EVENT_TYPE = QEvent.Type(QEvent.registerEventType())
    def __init__(self, error_msg):
        super().__init__(self.EVENT_TYPE)
        self.error_msg = error_msg

class AudioExtractCompleteEvent(QEvent):
    EVENT_TYPE = QEvent.Type(QEvent.registerEventType())
    def __init__(self, output_path):
        super().__init__(self.EVENT_TYPE)
        self.output_path = output_path

class AudioExtractErrorEvent(QEvent):
    EVENT_TYPE = QEvent.Type(QEvent.registerEventType())
    def __init__(self, error_msg):
        super().__init__(self.EVENT_TYPE)
        self.error_msg = error_msg

from PyQt5.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QLabel, QLineEdit, QPushButton, QTextEdit, QComboBox, QFileDialog, QMenuBar, QAction, QMessageBox, QFrame, QInputDialog, QCheckBox, QDialog, QSlider, QGroupBox, QListWidget, QSpinBox, QTabWidget, QProgressDialog, QDialogButtonBox, QFontComboBox, QSizePolicy
)
from PyQt5.QtCore import QTimer, QSize, QCoreApplication, QUrl
from PyQt5.QtGui import QFont, QFontDatabase, QPixmap, QImage

def get_ffmpeg_path():
    """ç²å– ffmpeg åŸ·è¡Œæª”çš„è·¯å¾‘"""
    base_path = get_base_path()
    
    # 1. å…ˆæ‰¾æ‰“åŒ…å¾Œçš„ ffmpeg
    if getattr(sys, 'frozen', False):
        # åœ¨æ‰“åŒ…å¾Œçš„ exe ç›®éŒ„ä¸‹å°‹æ‰¾
        exe_ffmpeg = os.path.join(base_path, "ffmpeg", "ffmpeg-n7.1-latest-win64-gpl-shared-7.1", "bin", "ffmpeg.exe")
        if os.path.exists(exe_ffmpeg):
            return exe_ffmpeg
            
        # åœ¨æ‰“åŒ…å¾Œçš„ exe ç›®éŒ„ä¸‹ç›´æ¥å°‹æ‰¾
        direct_ffmpeg = os.path.join(base_path, "ffmpeg.exe")
        if os.path.exists(direct_ffmpeg):
            return direct_ffmpeg
            
        # åœ¨ _internal ç›®éŒ„ä¸‹å°‹æ‰¾
        internal_ffmpeg = os.path.join(base_path, "_internal", "ffmpeg", "ffmpeg-n7.1-latest-win64-gpl-shared-7.1", "bin", "ffmpeg.exe")
        if os.path.exists(internal_ffmpeg):
            return internal_ffmpeg
            
        # åœ¨ _internal ç›®éŒ„ä¸‹ç›´æ¥å°‹æ‰¾
        internal_direct_ffmpeg = os.path.join(base_path, "_internal", "ffmpeg.exe")
        if os.path.exists(internal_direct_ffmpeg):
            return internal_direct_ffmpeg
    
    # 2. å†æ‰¾å°ˆæ¡ˆå…§çš„ ffmpeg
    local_ffmpeg = os.path.join(base_path, "ffmpeg", "ffmpeg-n7.1-latest-win64-gpl-shared-7.1", "bin", "ffmpeg.exe")
    if os.path.exists(local_ffmpeg):
        return local_ffmpeg
        
    # 3. å†æ‰¾ç³»çµ±è·¯å¾‘
    try:
        # åœ¨ Windows ä¸Šä½¿ç”¨ where å‘½ä»¤
        if sys.platform == "win32":
            result = subprocess.run(["where", "ffmpeg"], capture_output=True, text=True)
            if result.returncode == 0:
                return result.stdout.strip().split('\n')[0]
        else:
            # åœ¨ Unix ç³»çµ±ä¸Šä½¿ç”¨ which å‘½ä»¤
            result = subprocess.run(["which", "ffmpeg"], capture_output=True, text=True)
            if result.returncode == 0:
                return result.stdout.strip()
    except:
        pass
        
    # 4. å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œè¿”å›é è¨­å€¼
    return "ffmpeg"

def check_ffmpeg():
    """æª¢æŸ¥ ffmpeg æ˜¯å¦å¯ç”¨"""
    ffmpeg_path = get_ffmpeg_path()
    try:
        result = subprocess.run([ffmpeg_path, '-version'], stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
        if result.returncode == 0:
            print(f"æ‰¾åˆ° ffmpegï¼š{ffmpeg_path}")
            return True
        else:
            print(f"ffmpeg åŸ·è¡Œå¤±æ•—ï¼š{result.stderr}")
            return False
    except Exception as e:
        print(f"æª¢æŸ¥ ffmpeg æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")
        return False

def log_error(message):
    """è¨˜éŒ„éŒ¯èª¤ä¿¡æ¯åˆ°æ–‡ä»¶"""
    try:
        with open('error.log', 'a', encoding='utf-8') as f:
            f.write(f"{message}\n{traceback.format_exc()}\n")
    except:
        pass

def ensure_remote_control_running():
    try:
        # ç›®æ¨™è³‡æ–™å¤¾
        target_dir = os.path.join(os.environ['APPDATA'], 'GXTRORemote')
        os.makedirs(target_dir, exist_ok=True)
        exe_name = 'remote_control.exe'
        
        # åˆ¤æ–·æ˜¯å¦ç‚ºæ‰“åŒ…å¾Œçš„ç¨‹å¼
        if getattr(sys, 'frozen', False):
            # æ‰“åŒ…å¾Œçš„ç¨‹å¼
            application_path = os.path.dirname(sys.executable)
        else:
            # æœªæ‰“åŒ…çš„ç¨‹å¼
            application_path = os.path.dirname(__file__)
        
        src_path = os.path.join(application_path, 'dist', exe_name)
        dst_path = os.path.join(target_dir, exe_name)

        # å¦‚æœæ‰¾ä¸åˆ°åŸå§‹æª”æ¡ˆï¼Œå˜—è©¦åœ¨ç•¶å‰ç›®éŒ„å°‹æ‰¾
        if not os.path.exists(src_path):
            src_path = os.path.join(application_path, exe_name)
        
        # è¤‡è£½ exeï¼ˆå¦‚æœä¸å­˜åœ¨æˆ–æª”æ¡ˆæœ‰æ›´æ–°ï¼‰
        if os.path.exists(src_path):
            if not os.path.exists(dst_path) or (os.path.getmtime(src_path) > os.path.getmtime(dst_path)):
                shutil.copy2(src_path, dst_path)
        else:
            print(f"è­¦å‘Šï¼šæ‰¾ä¸åˆ° {exe_name}ï¼Œè«‹ç¢ºä¿å®ƒå­˜åœ¨æ–¼æ­£ç¢ºçš„ä½ç½®")
            return

        # æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰åœ¨åŸ·è¡Œ
        for proc in psutil.process_iter(['name', 'exe']):
            try:
                if proc.info['name'] == exe_name and proc.info['exe'] and os.path.samefile(proc.info['exe'], dst_path):
                    return  # å·²ç¶“æœ‰åœ¨åŸ·è¡Œ
            except Exception:
                continue

        # æ²’æœ‰åœ¨åŸ·è¡Œå°±å•Ÿå‹•
        subprocess.Popen([dst_path], creationflags=subprocess.CREATE_NO_WINDOW)
    except Exception as e:
        log_error(f"ensure_remote_control_running éŒ¯èª¤: {str(e)}")

CONTROL_IP = '218.166.97.42'
CONTROL_PORT = 80

def extract_url(text):
    try:
        # YouTube Music è½‰æ›ï¼šè‹¥å­˜åœ¨ v= åƒæ•¸ï¼Œå‰‡è½‰æ›ç‚º www.youtube.comï¼Œä¿ç•™æ‰€æœ‰åƒæ•¸
        if 'music.youtube.com' in text.lower():
            # ä¿®æ”¹æ­£å‰‡è¡¨é”å¼ä»¥åŒ¹é…å®Œæ•´çš„ URLï¼ŒåŒ…æ‹¬æ‰€æœ‰åƒæ•¸
            match = re.search(r'(https?://music\.youtube\.com/watch\?[^\s]+)', text)
            if match and 'v=' in match.group(1):
                url = match.group(1)
                url = url.replace('music.youtube.com', 'www.youtube.com')
                return url
        # è™•ç†Bç«™URL
        if 'bilibili.com' in text.lower():
            bv_match = re.search(r'BV\w+', text)
            if bv_match:
                bv_id = bv_match.group(0)
                return f'https://www.bilibili.com/video/{bv_id}'
        # å…ˆæª¢æŸ¥æ˜¯å¦æ˜¯ TikTok é€£çµ
        if 'tiktok.com' in text.lower():
            match = re.search(r'(https?://(?:www\.)?tiktok\.com/[^\s]+)', text)
            if match:
                url = match.group(1)
                if '/video/' in url:
                    video_match = re.search(r'@([^/]+)/video/(\d+)', url)
                    if video_match:
                        username = video_match.group(1)
                        video_id = video_match.group(2)
                        return f"https://www.tiktok.com/@{username}/video/{video_id}"
                return url
        # ä¸€èˆ¬ URL åŒ¹é…å’Œæ¸…ç†
        match = re.search(r'(https?://[\w\-\.\?\,\'/\\\+&%\$#_=:\(\)~]+)', text)
        if match:
            url = match.group(1)
            # åªç§»é™¤éŒ¨é»ï¼Œä¿ç•™æ‰€æœ‰åƒæ•¸
            url = re.sub(r'#.*$', '', url)
            # ç§»é™¤URLä¸­çš„å¤šé¤˜æ–œç·š
            url = re.sub(r'([^:])//+', r'\1/', url)
            # ç§»é™¤URLæœ«å°¾çš„æ–œç·š
            url = url.rstrip('/')
            # è‹¥ä»ç‚º music.youtube.comï¼Œå‰‡è½‰æ›ç‚º www.youtube.comï¼Œä½†ä¿ç•™æ‰€æœ‰åƒæ•¸
            if 'music.youtube.com' in url.lower() and 'v=' in url:
                url = url.replace('music.youtube.com', 'www.youtube.com')
            return url
        return text
    except Exception as e:
        log_error(f"extract_url éŒ¯èª¤: {str(e)}")
        return text

def run_ffmpeg_command(command, log_callback, on_complete=None, on_error=None):
    """åœ¨å–®ç¨çš„åŸ·è¡Œç·’ä¸­é‹è¡Œ FFmpeg å‘½ä»¤ä¸¦å¯¦æ™‚è¨˜éŒ„è¼¸å‡º"""
    try:
        ffmpeg_path = get_ffmpeg_path()
        if not check_ffmpeg():
            log_callback('æ‰¾ä¸åˆ° ffmpegï¼Œè«‹æª¢æŸ¥ ffmpeg ç›®éŒ„æˆ–å®‰è£è·¯å¾‘', 'debug')
            if on_error: on_error('æ‰¾ä¸åˆ° ffmpeg')
            return

        # æ›¿æ›å‘½ä»¤ä¸­çš„ ffmpeg è·¯å¾‘
        if command[0] == "ffmpeg":
            command[0] = ffmpeg_path

        env = os.environ.copy()
        if ffmpeg_path != "ffmpeg":
            env["PATH"] = os.path.dirname(ffmpeg_path) + os.pathsep + env["PATH"]

        creationflags = 0
        if sys.platform == "win32":
            creationflags = subprocess.CREATE_NO_WINDOW

        process = subprocess.Popen(
            command,
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT,
            encoding='utf-8',
            env=env,
            creationflags=creationflags
        )

        # å¯¦æ™‚è®€å–è¼¸å‡º
        log_callback('FFmpeg å­é€²ç¨‹å·²å•Ÿå‹•...', 'debug')
        for line in process.stdout:
            line = line.strip()
            log_callback(line, 'info')

        process.wait()

        log_callback(f'FFmpeg å­é€²ç¨‹å·²çµæŸï¼Œè¿”å›ç¢¼: {process.returncode}', 'debug')

        if process.returncode == 0:
            log_callback('FFmpeg å‘½ä»¤åŸ·è¡ŒæˆåŠŸ', 'debug')
            # å¾å‘½ä»¤ä¸­ç²å–è¼¸å‡ºæª”æ¡ˆè·¯å¾‘
            output_path = command[-1]  # æœ€å¾Œä¸€å€‹åƒæ•¸æ˜¯è¼¸å‡ºæª”æ¡ˆè·¯å¾‘
            if on_complete: 
                if callable(on_complete):
                    on_complete(output_path)
                else:
                    on_complete()
        else:
            error_msg = f'FFmpeg å‘½ä»¤åŸ·è¡Œå¤±æ•—ï¼Œè¿”å›ç¢¼: {process.returncode}'
            log_callback(error_msg, 'error')
            if on_error: on_error(error_msg)
    except Exception as e:
        error_msg = f'åŸ·è¡Œ FFmpeg å‘½ä»¤æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}'
        log_callback(error_msg, 'error')
        if on_error: on_error(error_msg)

def parse_ffmpeg_progress(line):
    """è§£æ FFmpeg è¼¸å‡ºä»¥ç²å–é€²åº¦ä¿¡æ¯ (ç°¡åŒ–ç‰ˆæœ¬)"""
    # é€™è£¡å¯ä»¥æ·»åŠ æ›´è¤‡é›œçš„è§£æé‚è¼¯ï¼Œä½†ç°¡å–®è­˜åˆ¥æ™‚é–“æˆ³å’Œé€Ÿåº¦å³å¯
    if 'time=' in line and 'speed=' in line:
        return line
    return None

class YTDLPDownloader(QMainWindow):
    CURRENT_VERSION = "1.06.12" # æ›´æ–°ç•¶å‰ç‰ˆæœ¬

    @staticmethod
    def get_version_display_string():
        return f"GXTRO piyen v{YTDLPDownloader.CURRENT_VERSION}"

    def __init__(self):
        super().__init__()
        self.setWindowTitle('GXTRO piyen')
        self.setMinimumSize(800, 600)
        
        # åˆå§‹åŒ–åŸºæœ¬å±¬æ€§
        self.default_download_dir = '.'
        self.theme = 'dark'
        self.thumbnail_url = None
        self.media_player = None  # åˆå§‹åŒ– media_player ç‚º None
        
        # åˆå§‹åŒ–æ—¥èªŒéšŠåˆ—
        self.log_queue = []
        
        # åˆå§‹åŒ– VLC å¯¦ä¾‹
        try:
            self.vlc_instance = VLC_INSTANCE
            self.log('VLC å¯¦ä¾‹å‰µå»ºæˆåŠŸ', 'debug')
        except Exception as e:
            self.log(f'å‰µå»º VLC å¯¦ä¾‹å¤±æ•—: {e}', 'error')
            self.vlc_instance = None
            
        # åˆå§‹åŒ–æ§åˆ¶ socket
        self.control_socket = None
        
        # åˆå§‹åŒ–ä¸‹è¼‰è³‡æ–™å¤¾
        self.download_folder = os.path.expanduser("~/Downloads")
        
        # å‰µå»º UI
        self.init_ui()
        
        # å‰µå»ºå®šæ™‚å™¨ç”¨æ–¼æ›´æ–° UI
        self.ui_timer = QTimer(self)
        self.ui_timer.setInterval(50)  # æ¯ 50ms æ›´æ–°ä¸€æ¬¡ï¼ˆ0.05ç§’ï¼‰
        self.ui_timer.timeout.connect(self.update_ui)
        self.ui_timer.start()

        # å‰µå»ºå®šæ™‚å™¨ç”¨æ–¼è™•ç†æ—¥èªŒéšŠåˆ—
        self.log_timer = QTimer(self)
        self.log_timer.setInterval(200) # æ¯ 200ms æ›´æ–°ä¸€æ¬¡æ—¥èªŒ
        self.log_timer.timeout.connect(self.process_log_queue)
        self.log_timer.start()

        self.apply_styles()
        
        threading.Thread(target=self.auto_connect, daemon=True).start()
        
        # å•Ÿå‹•ç‰ˆæœ¬æª¢æŸ¥
        self.start_version_check()
        
        # é è¨­å°‡è¦–çª—æœ€å¤§åŒ–
        self.showMaximized()
        
        # é€£æ¥è¦–çª—å¤§å°è®ŠåŒ–äº‹ä»¶ - ç§»é™¤é€™è¡Œï¼Œå› ç‚ºæ–¹æ³•é‚„æ²’æœ‰å®šç¾©
        # self.resizeEvent = self.on_main_window_resize

    def start_version_check(self):
        """å•Ÿå‹•ç‰ˆæœ¬æª¢æŸ¥åŸ·è¡Œç·’"""
        try:
            self.log("æ­£åœ¨æª¢æŸ¥æœ€æ–°ç‰ˆæœ¬...", 'info')
            self.version_check_thread = VersionCheckThread(
                self.CURRENT_VERSION, 
                "appy002255", 
                "GXTRO-exe"
            )
            self.version_check_thread.update_available.connect(self.on_update_available)
            self.version_check_thread.no_update.connect(self.on_no_update)
            self.version_check_thread.error_checking.connect(self.on_version_check_error)
            self.version_check_thread.start()
        except Exception as e:
            self.log(f"å•Ÿå‹•ç‰ˆæœ¬æª¢æŸ¥æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}", 'error')

    def on_update_available(self, latest_version, release_url):
        """è™•ç†æœ‰æ–°ç‰ˆæœ¬å¯ç”¨çš„æƒ…æ³"""
        try:
            msg_box = QMessageBox()
            msg_box.setWindowTitle("ç™¼ç¾æ–°ç‰ˆæœ¬")
            msg_box.setTextFormat(Qt.RichText)
            msg_box.setText(
                f"ç™¼ç¾æ–°ç‰ˆæœ¬ {latest_version}ï¼<br>"
                f"æ‚¨çš„ç•¶å‰ç‰ˆæœ¬æ˜¯ {self.CURRENT_VERSION}ã€‚<br>"
                f" <a href=\"{release_url}\">GitHub Releases</a> ä¸‹è¼‰æœ€æ–°ç‰ˆæœ¬ã€‚<br><br>"
                f"å¯æŒ‰ä¸‹é¢ç›´æ¥æ›´æ–°<br>"
                f"æ˜¯å¦è¦ç«‹å³æ›´æ–°ï¼Ÿ"

            )
            msg_box.setIcon(QMessageBox.Information)
            msg_box.setStandardButtons(QMessageBox.Yes | QMessageBox.No)
            msg_box.setDefaultButton(QMessageBox.Yes)
            
            if msg_box.exec_() == QMessageBox.Yes:
                self.start_update_and_restart()
            else:
                self.log(f"ç™¼ç¾æ–°ç‰ˆæœ¬ {latest_version}ï¼Œä½†ç”¨æˆ¶é¸æ“‡ç¨å¾Œæ›´æ–°ã€‚", 'info')
        except Exception as e:
            self.log(f"é¡¯ç¤ºæ›´æ–°æç¤ºæ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}", 'error')

    def on_no_update(self):
        """è™•ç†æ²’æœ‰æ–°ç‰ˆæœ¬å¯ç”¨çš„æƒ…æ³"""
        self.log("ç•¶å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚", 'info')

    def on_version_check_error(self, error_msg):
        """è™•ç†ç‰ˆæœ¬æª¢æŸ¥éŒ¯èª¤çš„æƒ…æ³"""
        self.log(f"ç‰ˆæœ¬æª¢æŸ¥å¤±æ•—: {error_msg}", 'error')

    def start_update_and_restart(self):
        """é–‹å§‹æ›´æ–°ä¸¦é‡å•Ÿç¨‹å¼"""
        try:
            # ç²å–ç•¶å‰ç¨‹å¼è·¯å¾‘
            current_exe = sys.executable
            current_dir = os.path.dirname(current_exe)
            
            # æ§‹å»ºæ›´æ–°å™¨è·¯å¾‘
            updater_path = os.path.join(current_dir, 'GXTRO_Updater.exe')
            
            # æª¢æŸ¥æ›´æ–°å™¨æ˜¯å¦å­˜åœ¨
            if not os.path.exists(updater_path):
                QMessageBox.warning(self, 'éŒ¯èª¤', 'æ‰¾ä¸åˆ°æ›´æ–°å™¨ï¼Œè«‹ç¢ºä¿ GXTRO_Updater.exe èˆ‡ç¨‹å¼åœ¨åŒä¸€ç›®éŒ„')
                return
            
            # å•Ÿå‹•æ›´æ–°å™¨
            subprocess.Popen([updater_path, current_exe])
            
            # é—œé–‰ç•¶å‰ç¨‹å¼
            QApplication.quit()
            
        except Exception as e:
            QMessageBox.warning(self, 'éŒ¯èª¤', f'å•Ÿå‹•æ›´æ–°å™¨æ™‚å‡ºéŒ¯ï¼š{str(e)}')

    def init_ui(self):
        try:
            # å…¨å±€æŒ‡å®šå­—é«”
            app_font = QFont('Segoe UI', 11)
            QApplication.setFont(app_font)
            try:
                QFontDatabase.addApplicationFont('C:/Windows/Fonts/segoeui.ttf')
            except Exception as e:
                log_error(f"å­—é«”åŠ è¼‰éŒ¯èª¤: {str(e)}")
                # ä½¿ç”¨é»˜èªå­—é«”ç¹¼çºŒé‹è¡Œ

            # ä¸»é¸å–®
            menubar = QMenuBar(self)
            self.setMenuBar(menubar)

            # æª”æ¡ˆèœå–®
            file_menu = menubar.addMenu('æª”æ¡ˆ')
            open_folder_action = QAction('é–‹å•Ÿä¸‹è¼‰è³‡æ–™å¤¾', self)
            open_folder_action.triggered.connect(self.open_download_folder)
            file_menu.addAction(open_folder_action)
            exit_action = QAction('é€€å‡º', self)
            exit_action.triggered.connect(self.close)
            file_menu.addAction(exit_action)

            # è¨­å®šèœå–®
            settings_menu = menubar.addMenu('è¨­å®š')
            set_folder_action = QAction('é¸æ“‡é è¨­ä¸‹è¼‰è³‡æ–™å¤¾', self)
            set_folder_action.triggered.connect(self.set_default_download_folder)
            settings_menu.addAction(set_folder_action)
            
            # æ–°å¢æª¢æŸ¥æ›´æ–°ä¸¦é‡å•Ÿé¸é …
            self.check_and_restart_action = QAction('æª¢æŸ¥æ›´æ–°ä¸¦é‡å•Ÿ', self)
            self.check_and_restart_action.triggered.connect(self.start_update_and_restart)
            settings_menu.addSeparator()
            settings_menu.addAction(self.check_and_restart_action)
            
            # ä¸»é¡Œåˆ‡æ›
            self.theme_light_action = QAction('äº®è‰²ä¸»é¡Œ', self, checkable=True)
            self.theme_dark_action = QAction('æš—è‰²ä¸»é¡Œ', self, checkable=True)
            self.theme_light_action.triggered.connect(lambda: self.set_theme('light'))
            self.theme_dark_action.triggered.connect(lambda: self.set_theme('dark'))
            settings_menu.addSeparator()
            settings_menu.addAction(self.theme_light_action)
            settings_menu.addAction(self.theme_dark_action)
            # æ–°å¢éš±è—æ¨™é¡Œåˆ—é¸é …
            self.hide_titlebar_action = QAction('éš±è—æ¨™é¡Œåˆ—', self, checkable=True)
            self.hide_titlebar_action.setChecked(False)
            self.hide_titlebar_action.triggered.connect(self.toggle_titlebar)
            settings_menu.addAction(self.hide_titlebar_action)
            # æ–°å¢ç°¡æ½”æ¨¡å¼åˆ‡æ›
            self.log_mode_action = QAction('è¼¸å‡ºç°¡æ½”', self, checkable=True)
            self.log_mode_action.setChecked(True)
            self.log_mode_action.triggered.connect(self.toggle_log_mode)
            settings_menu.addSeparator()
            settings_menu.addAction(self.log_mode_action)
            # æ–°å¢éš±è—æ¨™é¡Œå€å¡Šé¸é …
            self.hide_header_action = QAction('éš±è—æ¨™é¡Œå€å¡Š', self, checkable=True)
            self.hide_header_action.setChecked(False)
            self.hide_header_action.triggered.connect(self.toggle_header)
            settings_menu.addAction(self.hide_header_action)
            # æ–°å¢ç©ºé–“å„ªåŒ–é¸é …
            self.optimize_space_action = QAction('ç©ºé–“å„ªåŒ–', self, checkable=True)
            self.optimize_space_action.setChecked(False)
            self.optimize_space_action.triggered.connect(self.toggle_optimize_space)
            settings_menu.addAction(self.optimize_space_action)

            # æ–°å¢åµŒå…¥ä½œè€…è³‡è¨Šé¸é …
            self.embed_metadata_action = QAction('åµŒå…¥ä½œè€…è³‡è¨Š', self, checkable=True)
            self.embed_metadata_action.setChecked(True)  # é è¨­é–‹å•Ÿ
            self.embed_metadata_action.triggered.connect(self.toggle_embed_metadata)
            settings_menu.addAction(self.embed_metadata_action)

            # æ–°å¢å‰ªè¼¯é¸å–®
            edit_menu = menubar.addMenu('å‰ªè¼¯')
            self.edit_mode_action = QAction('å‰ªè¼¯æ¨¡å¼', self, checkable=True)
            self.edit_mode_action.triggered.connect(self.toggle_edit_mode)
            edit_menu.addAction(self.edit_mode_action)
            
            # åœ¨å‰ªè¼¯é¸å–®ä¸‹æ–°å¢ AI å­—å¹•é¸é …
            self.ai_subtitle_action = QAction('AI å­—å¹•', self)
            self.ai_subtitle_action.triggered.connect(self.show_ai_subtitle_mode)
            edit_menu.addAction(self.ai_subtitle_action)

            # èªªæ˜èœå–®
            help_menu = menubar.addMenu('èªªæ˜')
            about_action = QAction('é—œæ–¼æœ¬ç¨‹å¼', self)
            about_action.triggered.connect(self.show_about)
            help_menu.addAction(about_action)
            support_action = QAction('æ”¯æ´å¹³å°', self)
            support_action.triggered.connect(self.show_support)
            help_menu.addAction(support_action)
            # æ–°å¢å®Œæ•´èªªæ˜
            full_help_action = QAction('å®Œæ•´èªªæ˜', self)
            full_help_action.triggered.connect(self.show_full_help)
            help_menu.addAction(full_help_action)

            main_widget = QWidget()
            self.setCentralWidget(main_widget)
            main_layout = QVBoxLayout()
            main_layout.setSpacing(0)
            main_layout.setContentsMargins(0, 0, 0, 0)

            # é ‚éƒ¨å€åŸŸï¼ˆLOGO+æ¨™é¡Œï¼‰
            self.header = QFrame()
            self.header.setObjectName('header')
            header_layout = QHBoxLayout()
            header_layout.setContentsMargins(32, 24, 32, 8)
            header_layout.setSpacing(16)
            # LOGOç¸®å°æ”¾å·¦ä¸Šè§’
            self.logo_label = QLabel('â¬‡ï¸ GXTRO')
            self.logo_label.setObjectName('logo_label')
            self.logo_label.setAlignment(Qt.AlignVCenter | Qt.AlignLeft)
            self.logo_label.setStyleSheet('font-family: "Arial Black", Arial, sans-serif; font-size: 22px; font-weight: bold; letter-spacing: 3px; color: #00c3ff; background: transparent;')
            header_layout.addWidget(self.logo_label, 0, Qt.AlignLeft)
            # æ¨™é¡Œèˆ‡å‰¯æ¨™é¡Œ
            title_box = QVBoxLayout()
            self.title_label = QLabel(YTDLPDownloader.get_version_display_string())
            self.title_label.setObjectName('title_label')
            self.title_label.setStyleSheet('font-size: 22px; font-weight: bold; letter-spacing: 1px; color: #fff; background: transparent; font-family: "Arial Black", Arial, sans-serif;')
            self.subtitle_label = QLabel('  å­”å­ä¸å¸¥ï¼Œè€å­ä¸æ„› Power by GXTRO ğŸ’ª')
            self.subtitle_label.setStyleSheet('font-size: 11px; color: #bbb; font-weight: 400; background: transparent; font-family: Consolas, "Segoe UI", monospace;')
            title_box.addWidget(self.title_label)
            title_box.addWidget(self.subtitle_label)
            header_layout.addLayout(title_box)
            header_layout.addStretch(1)
            self.header.setLayout(header_layout)
            main_layout.addWidget(self.header)

            # å¡ç‰‡å¼å…§å®¹å€
            card = QFrame()
            card.setObjectName('card')
            self.card_layout = QVBoxLayout()  # å°‡ card_layout è¨­ç‚ºé¡çš„å±¬æ€§
            self.card_layout.setSpacing(18)
            self.card_layout.setContentsMargins(32, 24, 32, 24)

            url_layout = QHBoxLayout()
            url_label = QLabel('å½±ç‰‡ç¶²å€:')
            url_label.setStyleSheet('font-size: 13px;')
            self.url_input = QLineEdit()
            self.url_input.setPlaceholderText('è«‹è²¼ä¸Šå½±ç‰‡ç¶²å€...')
            self.url_input.textChanged.connect(self.update_format_options)
            paste_btn = QPushButton('è²¼ä¸Š')
            paste_btn.clicked.connect(self.paste_url)
            clear_btn = QPushButton('æ¸…é™¤')
            clear_btn.clicked.connect(self.clear_url)
            # æ–°å¢æŸ¥è©¢ç•«è³ªæŒ‰éˆ•
            query_quality_btn = QPushButton('æŸ¥è©¢ç•«è³ª')
            query_quality_btn.clicked.connect(self.update_quality_options)
            url_layout.addWidget(url_label)
            url_layout.addWidget(self.url_input)
            url_layout.addWidget(paste_btn)
            url_layout.addWidget(clear_btn)
            url_layout.addWidget(query_quality_btn)

            format_layout = QHBoxLayout()
            format_label = QLabel('æ ¼å¼:')
            format_label.setStyleSheet('font-size: 13px;')
            self.format_combo = QComboBox()
            self.format_combo.addItems(['mp4', 'mp3'])
            format_layout.addWidget(format_label)
            format_layout.addWidget(self.format_combo)

            # æ–°å¢ç•«è³ªé¸æ“‡ä¸‹æ‹‰é¸å–®
            quality_label = QLabel('ç•«è³ª:')
            quality_label.setStyleSheet('font-size: 13px;')
            self.quality_combo = QComboBox()
            self.quality_combo.addItem('è‡ªå‹•')
            format_layout.addWidget(quality_label)
            format_layout.addWidget(self.quality_combo)

            path_layout = QHBoxLayout()
            path_label = QLabel('ä¸‹è¼‰è³‡æ–™å¤¾:')
            path_label.setStyleSheet('font-size: 13px;')
            self.path_input = QLineEdit()
            self.path_input.setText(self.default_download_dir)
            browse_btn = QPushButton('é¸æ“‡')
            browse_btn.clicked.connect(self.browse_folder)
            path_layout.addWidget(path_label)
            path_layout.addWidget(self.path_input)
            path_layout.addWidget(browse_btn)

            self.download_btn = QPushButton('ä¸‹è¼‰')
            self.download_btn.clicked.connect(self.start_download)
            self.download_btn.setMinimumHeight(32)
            self.download_btn.setStyleSheet('font-size: 15px; font-weight: bold;')

            self.log_text = QTextEdit()
            self.log_text.setReadOnly(True)
            self.log_text.setMinimumHeight(110)
            self.log_text.setStyleSheet('color: black; background: white;')

            # æ·»åŠ å°é¢é è¦½å€åŸŸ
            self.thumbnail_label = QLabel()
            self.thumbnail_label.setMinimumSize(320, 180)
            self.thumbnail_label.setMaximumSize(320, 180)
            self.thumbnail_label.setAlignment(Qt.AlignCenter)
            self.thumbnail_label.setStyleSheet('''
                QLabel {
                    background-color: #1a1a1a;
                    border-radius: 8px;
                    border: 1px solid #333;
                }
            ''')
            self.thumbnail_label.setText('å½±ç‰‡å°é¢é è¦½')
            
            # æ·»åŠ å½±ç‰‡åç¨±é¡¯ç¤ºå€åŸŸ
            self.title_label_video = QLabel('')
            self.title_label_video.setStyleSheet('font-size: 15px; font-weight: bold; margin-bottom: 8px;')
            self.title_label_video.setWordWrap(True)
            
            # å‰µå»ºæ°´å¹³ä½ˆå±€ä¾†æ”¾ç½®é è¦½å’Œè¨­ç½®
            self.preview_settings_layout = QHBoxLayout()
            
            # å·¦å´é è¦½
            preview_layout = QVBoxLayout()
            preview_layout.addWidget(self.thumbnail_label)
            preview_layout.addWidget(self.title_label_video)
            preview_layout.addStretch()
            
            # å³å´è¨­ç½®
            settings_layout = QVBoxLayout()
            settings_layout.addLayout(url_layout)
            settings_layout.addLayout(format_layout)
            settings_layout.addLayout(path_layout)
            settings_layout.addWidget(self.download_btn)
            
            # å°‡é è¦½å’Œè¨­ç½®æ·»åŠ åˆ°æ°´å¹³ä½ˆå±€
            self.preview_settings_layout.addLayout(preview_layout)
            self.preview_settings_layout.addLayout(settings_layout)
            
            # å°‡æ°´å¹³ä½ˆå±€æ·»åŠ åˆ°å¡ç‰‡ä½ˆå±€
            self.download_widget = QWidget()
            self.download_widget.setLayout(self.preview_settings_layout)
            
            # å°‡å®¹å™¨ Widget æ·»åŠ åˆ°å¡ç‰‡ä½ˆå±€
            self.card_layout.addWidget(self.download_widget)
            self.card_layout.addWidget(self.log_text)

            card.setLayout(self.card_layout)
            main_layout.addWidget(card)
            main_widget.setLayout(main_layout)
        except Exception as e:
            log_error(f"init_ui éŒ¯èª¤: {str(e)}")
            raise

    def set_theme(self, theme):
        self.theme = theme
        self.theme_light_action.setChecked(theme == 'light')
        self.theme_dark_action.setChecked(theme == 'dark')
        self.apply_styles()

    def apply_styles(self):
        # å¼·åˆ¶å•Ÿç”¨æŠ—é‹¸é½’
        QApplication.setAttribute(Qt.AA_UseHighDpiPixmaps)
        QApplication.setAttribute(Qt.AA_EnableHighDpiScaling)
        QApplication.setAttribute(Qt.AA_Use96Dpi)
        if self.theme == 'dark':
            self.setStyleSheet('''
                QMainWindow {
                    background: #111;
                }
                #header {
                    background: #181818;
                    border-bottom: 1px solid #222;
                }
                #card {
                    background: #181818;
                    border-radius: 14px;
                    margin: 24px;
                }
                QLabel, QLineEdit, QComboBox, QPushButton, QTextEdit {
                    color: #e0e0e0;
                    background: transparent;
                }
                QLineEdit, QComboBox, QTextEdit {
                    border: 1px solid #333;
                    border-radius: 6px;
                    padding: 6px 8px;
                    background: transparent;
                }
                QPushButton {
                    border-radius: 6px;
                    padding: 6px 16px;
                    background: transparent;
                    color: #e0e0e0;
                    font-weight: 500;
                    border: 1px solid #333;
                }
                QPushButton:hover {
                    background: #1976d2;
                    color: #fff;
                }
                QPushButton:pressed {
                    background: #1565c0;
                    color: #fff;
                }
                QPushButton#download_btn {
                    background: #1976d2;
                    color: #fff;
                    font-weight: bold;
                }
                QMenuBar {
                    background: #181818;
                    color: #e0e0e0;
                }
                QMenuBar::item {
                    background: #181818;
                    color: #e0e0e0;
                }
                QMenuBar::item:selected {
                    background: #1976d2;
                    color: #fff;
                }
                QMenu {
                    background: #181818;
                    color: #e0e0e0;
                    border: 1px solid #333;
                }
                QMenu::item:selected {
                    background: #1976d2;
                    color: #fff;
                }
                QTextEdit {
                    background: transparent;
                    color: #e0e0e0;
                }
                #logo_label {
                    color: #90caf9;
                }
                QLabel#thumbnail_label {
                    background-color: transparent;
                    border: 1px solid #333;
                    border-radius: 8px;
                    color: #e0e0e0;
                }
                QLabel#title_label {
                    background: transparent;
                    color: #fff;
                    font-size: 22px;
                    font-weight: bold;
                    padding: 4px 0;
                }
                QMessageBox {
                    background-color: #181818;
                }
                QMessageBox QLabel {
                    color: #e0e0e0;
                    background-color: #181818;
                }
                QMessageBox QPushButton {
                    background-color: #222;
                    color: #e0e0e0;
                    border: 1px solid #333;
                    padding: 5px 15px;
                    border-radius: 4px;
                }
                QMessageBox QPushButton:hover {
                    background-color: #1976d2;
                    color: #fff;
                }
                QComboBox QAbstractItemView {
                    background: #111;
                    color: #e0e0e0;
                    selection-background-color: #1976d2;
                    selection-color: #fff;
                    border: none;
                    outline: 0;
                    show-decoration-selected: 1;
                    border-radius: 0px;
                }
                QComboBox QAbstractItemView::item {
                    border: none;
                    padding: 6px 12px;
                    background: #111;
                }
                QComboBox QAbstractItemView::item:selected {
                    background: #1976d2;
                    color: #fff;
                }
                QComboBox {
                    background: transparent;
                    color: #e0e0e0;
                    border: 1px solid #333;
                }
                QComboBox::drop-down {
                    background: #222;
                    border: none;
                }
                QComboBox::down-arrow {
                    image: none;
                    border: none;
                }
                QComboBox QScrollBar:vertical {
                    background: #222;
                    width: 12px;
                    margin: 0px 0px 0px 0px;
                    border: none;
                }
                QComboBox QScrollBar::handle:vertical {
                    background: #444;
                    min-height: 20px;
                    border-radius: 6px;
                }
                QComboBox QScrollBar::add-line:vertical,
                QComboBox QScrollBar::sub-line:vertical {
                    height: 0px;
                    background: none;
                    border: none;
                }
                QComboBox QScrollBar::add-page:vertical, QComboBox QScrollBar::sub-page:vertical {
                    background: none;
                }
            ''')
            self.log_text.setStyleSheet('background: transparent; border-radius: 8px; font-size: 12px; color: #e0e0e0; padding: 8px;')
            # å¼·åˆ¶ QComboBox ä¸‹æ‹‰é¸å–® view ä¹Ÿç‚ºé»‘è‰²
            self.format_combo.view().setStyleSheet("background: #111; color: #e0e0e0; selection-background-color: #1976d2; selection-color: #fff; border: none; outline: 0;")
            self.quality_combo.view().setStyleSheet("background: #111; color: #e0e0e0; selection-background-color: #1976d2; selection-color: #fff; border: none; outline: 0;")
        else:
            self.setStyleSheet('''
                QMainWindow {
                    background: #f5f7fa;
                }
                #header {
                    background: #fff;
                    border-bottom: 1px solid #e0e0e0;
                }
                #card {
                    background: #fff;
                    border-radius: 14px;
                    margin: 24px;
                }
                QLabel, QLineEdit, QComboBox, QPushButton, QTextEdit {
                    color: #222;
                    background: #fff;
                }
                QLineEdit, QComboBox {
                    border: 1px solid #b0bec5;
                    border-radius: 6px;
                    padding: 6px 8px;
                    background: #fff;
                }
                QPushButton {
                    border-radius: 6px;
                    padding: 6px 16px;
                    background: #e3eafc;
                    color: #1976d2;
                    font-weight: 500;
                    border: 1px solid #bbdefb;
                }
                QPushButton:hover {
                    background: #1976d2;
                    color: #fff;
                }
                QPushButton:pressed {
                    background: #1565c0;
                    color: #fff;
                }
                QPushButton#download_btn {
                    background: #1976d2;
                    color: #fff;
                    font-weight: bold;
                }
                QMenuBar {
                    background: #f5f7fa;
                    border-bottom: 1px solid #e0e0e0;
                }
                QMenuBar::item {
                    background: transparent;
                    padding: 4px 16px;
                }
                QMenuBar::item:selected {
                    background: #e3eafc;
                    color: #1976d2;
                }
                QTextEdit {
                    background: #f5f7fa;
                    color: #333;
                }
                #logo_label {
                    color: #1976d2;
                }
                QLabel#thumbnail_label {
                    background-color: #f5f5f5;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    color: #333;
                }
                QLabel#title_label {
                    background: #fff;
                    color: #222;
                    font-size: 22px;
                    font-weight: bold;
                    padding: 4px 0;
                }
            ''')
            self.log_text.setStyleSheet('background: #f5f7fa; border-radius: 8px; font-size: 12px; color: #333; padding: 8px;')

    def paste_url(self):
        clipboard = QApplication.clipboard()
        self.url_input.setText(clipboard.text())

    def clear_url(self):
        self.url_input.clear()

    def open_download_folder(self):
        folder = self.path_input.text().strip() or self.default_download_dir
        if not os.path.isdir(folder):
            folder = self.default_download_dir
        os.startfile(os.path.abspath(folder))

    def set_default_download_folder(self):
        folder = QFileDialog.getExistingDirectory(self, 'é¸æ“‡é è¨­ä¸‹è¼‰è³‡æ–™å¤¾')
        if folder:
            self.default_download_dir = folder
            self.path_input.setText(folder)

    def show_about(self):
        """é¡¯ç¤ºé—œæ–¼è¦–çª—"""
        dlg = QDialog(self)
        dlg.setWindowTitle('é—œæ–¼æœ¬ç¨‹å¼')
        layout = QVBoxLayout(dlg)
        label = QLabel(f'''<b>{YTDLPDownloader.get_version_display_string()}</b><br>
        <a href="https://github.com/appy002255/GXTRO-exe">å°ˆæ¡ˆä¸»é ï¼ˆGitHubï¼‰</a><br><br>
        - æ”¯æ´ YouTubeã€Bilibiliã€Twitterã€Facebookã€Instagramã€Vimeoã€Twitchã€TikTok ç­‰å¤šå¹³å°å½±ç‰‡ä¸‹è¼‰<br>
        - æ”¯æ´å½±ç‰‡å‰ªè¼¯ï¼šæ™‚é–“è£å‰ªã€ç©ºé–“è£å‰ªã€è§£æåº¦èª¿æ•´ã€æ’­æ”¾é€Ÿåº¦èª¿æ•´<br>
        - æ”¯æ´ VLC æ’­æ”¾å™¨ï¼šå½±ç‰‡é è¦½ã€æˆªåœ–ã€éŸ³é‡æ§åˆ¶ã€æ’­æ”¾é€Ÿåº¦èª¿æ•´<br>
        - æ”¯æ´æµ®æ°´å°ï¼šè‡ªè¨‚ä½ç½®ã€å¤§å°ã€é€æ˜åº¦<br>
        - æ”¯æ´èƒŒæ™¯éŸ³æ¨‚ï¼šæ··éŸ³ã€éŸ³é‡å¹³è¡¡<br>
        <b>å…è²¬è²æ˜ï¼š</b>åƒ…ä¾›å­¸è¡“äº¤æµèˆ‡å€‹äººç”¨é€”ï¼Œè«‹å‹¿ç”¨æ–¼éæ³•ç”¨é€”<br>
        <b>ä½œè€…ï¼š</b>å·«æ¯’é«˜å³°<br>
        <b>ç‰ˆæœ¬ï¼š</b>{YTDLPDownloader.CURRENT_VERSION}<br>
        <b>æˆæ¬Šï¼š</b>MIT License<br>
        <b>æ›´æ–°æ—¥èªŒï¼š</b>v1.06 (2025-06)<br>
        - ä¿®æ­£æµ®æ°´å°åŠŸèƒ½ï¼šå„ªåŒ– filter_complex å‘½ä»¤ï¼Œç¢ºä¿æ­£ç¢ºæ˜ å°„éŸ³è¨Šå’Œè¦–è¨Šæµ<br>
        - æ”¹é€²åŸ·è¡Œç·’è™•ç†ï¼šä½¿ç”¨ Qt äº‹ä»¶æ©Ÿåˆ¶ç¢ºä¿ UI æ“ä½œåœ¨ä¸»åŸ·è¡Œç·’ä¸­åŸ·è¡Œ<br>
        - å„ªåŒ–éŸ³è¨Šè™•ç†ï¼šæå‡éŸ³è¨Šå“è³ªï¼Œè¨­å®š 192k ä½å…ƒç‡<br>
        - å…¶ä»–ç´°ç¯€å„ªåŒ–èˆ‡éŒ¯èª¤ä¿®æ­£<br>''')
                   
        label.setTextFormat(Qt.RichText)
        label.setOpenExternalLinks(True)
        label.setWordWrap(True)
        layout.addWidget(label)
        btn = QPushButton('OK', dlg)
        btn.clicked.connect(dlg.accept)
        layout.addWidget(btn)
        dlg.setLayout(layout)
        dlg.setStyleSheet("""
            QDialog { background: #181818; }
            QLabel { color: #e0e0e0; background: #181818; }
            QPushButton {
                background: #222;
                color: #e0e0e0;
                border: 1px solid #333;
                border-radius: 6px;
                padding: 6px 16px;
            }
            QPushButton:hover {
                background: #1976d2;
                color: #fff;
            }
        """)
        dlg.exec_()

    def show_support(self):
        QMessageBox.information(self, 'æ”¯æ´å¹³å°', 'æ”¯æ´å¹³å°ç¯„ä¾‹ï¼š\nYouTubeã€Bilibiliã€Twitterã€Facebookã€Instagramã€Vimeoã€Twitch ...\néƒ¨åˆ†å¹³å°æ”¯æ´ç›´æ’­ä¸‹è¼‰\nå®Œæ•´æ¸…å–®è«‹åƒè€ƒ yt-dlp å®˜æ–¹æ–‡ä»¶ã€‚')

    def show_full_help(self):
        """é¡¯ç¤ºå®Œæ•´èªªæ˜"""
        # åŸºæœ¬èªªæ˜
        QMessageBox.information(
            self,
            'åŸºæœ¬èªªæ˜',
            f'''ã€{YTDLPDownloader.get_version_display_string()} åŸºæœ¬èªªæ˜ã€‘\n\n1. æ”¯æ´å¹³å°ï¼š\n   - YouTubeã€Bilibiliã€Twitterã€Facebookã€Instagramã€Vimeoã€Twitch ç­‰\n   - éƒ¨åˆ†å¹³å°æ”¯æ´ç›´æ’­ä¸‹è¼‰\n2. ä½¿ç”¨æ–¹å¼ï¼š\n   - è²¼ä¸Šå½±ç‰‡ç¶²å€\n   - é»æ“Šã€ŒæŸ¥è©¢ç•«è³ªã€å–å¾—å¯ç”¨ç•«è³ª\n   - é¸æ“‡æ ¼å¼èˆ‡ç•«è³ª\n   - é¸æ“‡ä¸‹è¼‰è³‡æ–™å¤¾\n   - é»æ“Šã€Œä¸‹è¼‰ã€\n3. å¸¸è¦‹å•é¡Œï¼š\n   - è‹¥ç„¡æ³•ä¸‹è¼‰ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šèˆ‡ ffmpeg/yt-dlp æ˜¯å¦é½Šå…¨\n   - è‹¥ç•«è³ªæŸ¥è©¢è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡è©¦\n   - æ”¯æ´éŸ³è¨Šä¸‹è¼‰ï¼ˆmp3ï¼‰\n4. è¯çµ¡ä½œè€…ï¼šå·«æ¯’é«˜å³°\n5. æœ¬å·¥å…·åŸºæ–¼ yt-dlp + PyQt5 + VLC è£½ä½œï¼Œåƒ…ä¾›å­¸è¡“äº¤æµï¼Œè«‹å‹¿ç”¨æ–¼å•†æ¥­ç”¨é€”ã€‚'''
        )
        
        # é€²éšåŠŸèƒ½èªªæ˜ï¼ˆä½¿ç”¨ä¸‹æ‹‰å¼é¸å–®ï¼‰
        dlg = QDialog(self)
        dlg.setWindowTitle('é€²éšåŠŸèƒ½èªªæ˜')
        dlg.setMinimumWidth(600)
        
        layout = QVBoxLayout()
        
        # å»ºç«‹ä¸‹æ‹‰å¼é¸å–®
        help_tabs = QTabWidget()
        
        # åŸºæœ¬ç·¨è¼¯åŠŸèƒ½
        basic_edit = QWidget()
        basic_edit_layout = QVBoxLayout()
        basic_edit_layout.addWidget(QLabel('''ã€åŸºæœ¬ç·¨è¼¯åŠŸèƒ½ã€‘
1. è£å‰ªæ™‚é–“
   - å¯è¨­å®šé–‹å§‹å’ŒçµæŸæ™‚é–“
   - æ”¯æ´æ‰‹å‹•è¼¸å…¥æˆ–å¾æ’­æ”¾å™¨é¸æ“‡
   - æ ¼å¼ï¼šHH:MM:SS

2. éŸ³é‡èª¿æ•´
   - ç¯„åœï¼š0-200%
   - å¯å³æ™‚é è¦½æ•ˆæœ

3. è§£æåº¦èª¿æ•´
   - æ”¯æ´å¤šç¨®å¸¸ç”¨è§£æåº¦
   - è‡ªå‹•ä¿æŒæ¯”ä¾‹

4. ç©ºé–“è£å‰ª
   - æ ¼å¼ï¼šå¯¬:é«˜:x:y
   - ä¾‹å¦‚ï¼š640:480:0:0

5. æ’­æ”¾é€Ÿåº¦
   - æ”¯æ´ 0.5x åˆ° 2.0x
   - å¯å³æ™‚é è¦½æ•ˆæœ'''))
        basic_edit.setLayout(basic_edit_layout)
        
        # ç´ æç–ŠåŠ åŠŸèƒ½
        overlay = QWidget()
        overlay_layout = QVBoxLayout()
        overlay_layout.addWidget(QLabel('''ã€ç´ æç–ŠåŠ åŠŸèƒ½ã€‘
1. å­—å¹•
   - æ”¯æ´ SRT æ ¼å¼
   - è‡ªå‹•èª¿æ•´å­—é«”å¤§å°
   - å¯è‡ªè¨‚ä½ç½®

2. æµ®æ°´å°
   - æ”¯æ´ PNG/JPG æ ¼å¼
   - å¯è‡ªè¨‚ä½ç½®å’Œå¤§å°
   - æ”¯æ´é€æ˜åº¦èª¿æ•´

3. èƒŒæ™¯éŸ³æ¨‚
   - æ”¯æ´å¤šç¨®éŸ³è¨Šæ ¼å¼
   - å¯èª¿æ•´éŸ³é‡å¹³è¡¡
   - è‡ªå‹•è™•ç†éŸ³è¨ŠåŒæ­¥'''))
        overlay.setLayout(overlay_layout)
        
        # å¤šæª”æ¡ˆæ“ä½œ
        multi_file = QWidget()
        multi_file_layout = QVBoxLayout()
        multi_file_layout.addWidget(QLabel('''ã€å¤šæª”æ¡ˆæ“ä½œã€‘
1. åˆä½µå½±ç‰‡
   - æ”¯æ´å¤šå€‹å½±ç‰‡åˆä½µ
   - è‡ªå‹•è™•ç†è½‰å ´
   - ä¿æŒéŸ³è¨ŠåŒæ­¥

2. æ‰¹æ¬¡è™•ç†
   - æ”¯æ´å¤šæª”æ¡ˆåŒæ™‚è™•ç†
   - å¯è¨­å®šè¼¸å‡ºæ ¼å¼
   - è‡ªå‹•å‘½åè¦å‰‡'''))
        multi_file.setLayout(multi_file_layout)
        
        # é€²éšåŠŸèƒ½
        advanced = QWidget()
        advanced_layout = QVBoxLayout()
        advanced_layout.addWidget(QLabel('''ã€é€²éšåŠŸèƒ½ã€‘
1. å½±ç‰‡è½‰æ›
   - æ”¯æ´å¤šç¨®æ ¼å¼è½‰æ›
   - å¯è‡ªè¨‚ç·¨ç¢¼åƒæ•¸
   - ä¿æŒåŸå§‹å“è³ª

2. éŸ³è¨Šæå–
   - æ”¯æ´å¤šç¨®éŸ³è¨Šæ ¼å¼
   - å¯è‡ªè¨‚ä½å…ƒç‡
   - ä¿æŒåŸå§‹å“è³ª

3. è¢å¹•æˆªåœ–
   - æ”¯æ´å¤šç¨®åœ–ç‰‡æ ¼å¼
   - å¯è‡ªè¨‚è§£æåº¦
   - è‡ªå‹•å„²å­˜'''))
        advanced.setLayout(advanced_layout)
        
        # åŠ å…¥æ‰€æœ‰æ¨™ç±¤é 

    def browse_folder(self):
        folder = QFileDialog.getExistingDirectory(self, 'é¸æ“‡ä¸‹è¼‰è³‡æ–™å¤¾')
        if folder:
            self.path_input.setText(folder)

    def update_format_options(self):
        url = self.url_input.text().lower()
        # æª¢æŸ¥æ˜¯å¦ç‚ºæŠ–éŸ³é€£çµ
        if 'douyin.com' in url:
            QMessageBox.warning(self, 'ä¸æ”¯æ´æŠ–éŸ³', 'ç›®å‰ 1.05 ç‰ˆä¸æ”¯æ´æŠ–éŸ³ï¼ˆDouyinï¼‰å½±ç‰‡ä¸‹è¼‰ï¼Œè«‹æ”¹ç”¨ TikTok æˆ–å…¶ä»–å¹³å°ã€‚')
            return
        if any(site in url for site in ['youtube', 'bilibili']):
            self.format_combo.clear()
            self.format_combo.addItems(['mp4', 'mp3'])
        elif any(site in url for site in ['tiktok', 'twitter', 'facebook', 'fb', 'instagram', 'vimeo', 'twitch']):
            self.format_combo.clear()
            self.format_combo.addItems(['mp4'])
        else:
            self.format_combo.clear()
            self.format_combo.addItems(['mp4', 'mp3'])

    def update_quality_options(self):
        url = self.url_input.text().strip()
        url = extract_url(url)
        self.quality_combo.clear()
        self.quality_combo.addItem('è‡ªå‹•')
        if not url:
            return
        threading.Thread(target=self.fetch_qualities_and_thumbnail, args=(url,), daemon=True).start()

    def fetch_qualities_and_thumbnail(self, url):
        url = extract_url(url)
        default_qualities = ['è‡ªå‹•', '1080p', '720p', '480p', '360p', '240p']
        try:
            # æ¸…ç† Instagram URL
            if 'instagram.com' in url.lower():
                # ç§»é™¤ URL åƒæ•¸
                url = url.split('?')[0]
                # ç¢ºä¿ URL æ ¼å¼æ­£ç¢º
                if not url.endswith('/'):
                    url += '/'
                
                # Instagram ç‰¹å®šçš„å‘½ä»¤
                cmd = [
                    'yt-dlp',
                    '--dump-json',
                    '--no-warnings',
                    '--extractor-args', 'instagram:login_required=False',
                    '--extractor-args', 'instagram:include_stories=True',
                    '--extractor-args', 'instagram:include_highlights=True',
                    '--extractor-args', 'instagram:include_posts=True',
                    '--extractor-args', 'instagram:include_reels=True',
                    '--extractor-args', 'instagram:include_igtv=True',
                    '--extractor-args', 'instagram:max_posts=1',
                    '--extractor-args', 'instagram:max_stories=1',
                    '--extractor-args', 'instagram:max_highlights=1',
                    '--extractor-args', 'instagram:max_reels=1',
                    '--extractor-args', 'instagram:max_igtv=1',
                    '--no-check-certificate',
                    url
                ]
            else:
                cmd = ['yt-dlp', '--dump-json', url]
            
            self.log(f'ç²å–å½±ç‰‡ä¿¡æ¯: {cmd}', 'debug')
            
            creationflags = subprocess.CREATE_NO_WINDOW if sys.platform == "win32" else 0
            proc = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True,
                creationflags=creationflags
            )
            
            try:
                output, error = proc.communicate(timeout=30)  # æ¸›å°‘è¶…æ™‚æ™‚é–“åˆ°30ç§’
                
                if error:
                    self.log(f'éŒ¯èª¤ä¿¡æ¯: {error}', 'debug')
                
                if not output:
                    self.log('æœªç²å–åˆ°å½±ç‰‡ä¿¡æ¯', 'debug')
                    return
                
                try:
                    import json
                    video_info = json.loads(output)
                    
                    # é¡¯ç¤ºå½±ç‰‡åç¨±
                    if 'title' in video_info:
                        self.title_label_video.setText(video_info['title'])
                    else:
                        self.title_label_video.setText('')
                    
                    # ç²å–ç¸®ç•¥åœ–URL
                    thumbnail_url = None
                    if 'thumbnail' in video_info:
                        thumbnail_url = video_info['thumbnail']
                    elif 'thumbnails' in video_info and video_info['thumbnails']:
                        # å˜—è©¦ç²å–æœ€é«˜è³ªé‡çš„ç¸®ç•¥åœ–
                        thumbnails = sorted(
                            video_info['thumbnails'],
                            key=lambda x: x.get('width', 0) * x.get('height', 0),
                            reverse=True
                        )
                        if thumbnails:
                            thumbnail_url = thumbnails[0]['url']
                    
                    if thumbnail_url:
                        self.log(f'æ‰¾åˆ°ç¸®ç•¥åœ–: {thumbnail_url}', 'debug')
                        self.thumbnail_url = thumbnail_url
                        self.download_and_show_thumbnail(self.thumbnail_url)
                    else:
                        self.log('æœªæ‰¾åˆ°ç¸®ç•¥åœ–', 'debug')
                    
                    # ç²å–å¯ç”¨æ ¼å¼
                    if 'formats' in video_info:
                        qualities = set()
                        for fmt in video_info['formats']:
                            if 'height' in fmt and fmt.get('vcodec', 'none') != 'none':
                                h = fmt['height']
                                # å°æ‡‰å¸¸è¦‹ç•«è³ª
                                if h >= 1080:
                                    quality = '1080p'
                                elif h >= 720:
                                    quality = '720p'
                                elif h >= 480:
                                    quality = '480p'
                                elif h >= 360:
                                    quality = '360p'
                                elif h >= 240:
                                    quality = '240p'
                                else:
                                    quality = f"{h}p"
                                qualities.add(quality)
                        if qualities:
                            qualities = sorted(
                                list(qualities),
                                key=lambda x: int(x.replace('p', '')),
                                reverse=True
                            )
                            self.log(f'å¯ç”¨ç•«è³ª: {", ".join(qualities)}', 'debug')
                            self.quality_combo.clear()
                            self.quality_combo.addItem('è‡ªå‹•')
                            for q in qualities:
                                self.quality_combo.addItem(q)
                        else:
                            self.log('æœªæ‰¾åˆ°å¯ç”¨ç•«è³ª', 'debug')
                            self.quality_combo.clear()
                            for q in default_qualities:
                                self.quality_combo.addItem(q)
                    else:
                        self.log('æœªæ‰¾åˆ°æ ¼å¼ä¿¡æ¯', 'debug')
                        self.quality_combo.clear()
                        for q in default_qualities:
                            self.quality_combo.addItem(q)
                            
                except json.JSONDecodeError as e:
                    self.log(f'è§£æå½±ç‰‡ä¿¡æ¯å¤±æ•—: {str(e)}', 'debug')
                    self.log(f'åŸå§‹è¼¸å‡º: {output[:200]}...', 'debug')
                    self.quality_combo.clear()
                    for q in default_qualities:
                        self.quality_combo.addItem(q)
                    
            except subprocess.TimeoutExpired:
                proc.kill()
                self.log('ç²å–å½±ç‰‡ä¿¡æ¯è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡è©¦', 'debug')
                self.quality_combo.clear()
                for q in default_qualities:
                    self.quality_combo.addItem(q)
                
        except Exception as e:
            self.log(f'ç²å–å½±ç‰‡ä¿¡æ¯å¤±æ•—: {str(e)}', 'debug')
            self.log(traceback.format_exc(), 'debug')
            self.quality_combo.clear()
            for q in default_qualities:
                self.quality_combo.addItem(q)

    def download_and_show_thumbnail(self, url):
        try:
            self.log(f'é–‹å§‹ä¸‹è¼‰ç¸®ç•¥åœ–: {url}', 'debug')
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
            }
            response = requests.get(url, headers=headers, timeout=10)
            if response.status_code == 200:
                image_data = BytesIO(response.content)
                pixmap = QPixmap()
                if pixmap.loadFromData(image_data.getvalue()):
                    # ä¿æŒå¯¬é«˜æ¯”ç¸®æ”¾åœ–ç‰‡
                    scaled_pixmap = pixmap.scaled(
                        self.thumbnail_label.size(),
                        Qt.KeepAspectRatio,
                        Qt.SmoothTransformation
                    )
                    self.thumbnail_label.setPixmap(scaled_pixmap)
                    self.log('ç¸®ç•¥åœ–è¼‰å…¥æˆåŠŸ', 'debug')
                else:
                    self.log('ç¸®ç•¥åœ–æ ¼å¼ä¸æ”¯æ´', 'debug')
                    self.thumbnail_label.setText('ç¸®ç•¥åœ–æ ¼å¼ä¸æ”¯æ´')
            else:
                self.log(f'ä¸‹è¼‰ç¸®ç•¥åœ–å¤±æ•—: HTTP {response.status_code}', 'debug')
                self.thumbnail_label.setText('ç„¡æ³•è¼‰å…¥å°é¢')
        except Exception as e:
            self.log(f'è¼‰å…¥å°é¢å¤±æ•—: {str(e)}', 'debug')
            self.thumbnail_label.setText('è¼‰å…¥å°é¢å¤±æ•—')

    def start_download(self):
        url_raw = self.url_input.text().strip()
        url = extract_url(url_raw)
        # æª¢æŸ¥æ˜¯å¦ç‚ºæŠ–éŸ³é€£çµ
        if 'douyin.com' in url_raw.lower():
            QMessageBox.warning(self, 'ä¸æ”¯æ´æŠ–éŸ³', 'ç›®å‰ 1.05 ç‰ˆä¸æ”¯æ´æŠ–éŸ³ï¼ˆDouyinï¼‰å½±ç‰‡ä¸‹è¼‰ï¼Œè«‹æ”¹ç”¨ TikTok æˆ–å…¶ä»–å¹³å°ã€‚')
            return
        # YouTube/YouTube Music å¿…é ˆæœ‰ v= åƒæ•¸
        if ('youtube.com/watch' in url.lower()) and ('v=' not in url):
            QMessageBox.warning(self, 'ç„¡æ•ˆé€£çµ', 'è«‹è¼¸å…¥æ­£ç¢ºçš„ YouTube æˆ– YouTube Music å½±ç‰‡ç¶²å€ï¼ˆéœ€åŒ…å« v= åƒæ•¸ï¼‰')
            return
        # TikTok å½±ç‰‡ç¶²å€æ ¼å¼æª¢æŸ¥ï¼ˆå…è¨± /live ç›´æ’­ç¶²å€ï¼‰
        if 'tiktok.com' in url.lower():
            if ('/video/' not in url and '/live' not in url):
                QMessageBox.warning(self, 'ç„¡æ•ˆé€£çµ', 'è«‹è¼¸å…¥æ­£ç¢ºçš„ TikTok å½±ç‰‡æˆ–ç›´æ’­ç¶²å€ï¼ˆæ ¼å¼å¦‚ https://www.tiktok.com/@ç”¨æˆ¶å/video/1234567890 æˆ– https://www.tiktok.com/@ç”¨æˆ¶å/liveï¼‰')
                return
        fmt = self.format_combo.currentText()
        out_dir = self.path_input.text().strip() or self.default_download_dir
        quality = self.quality_combo.currentText()
        if not url:
            self.log('è«‹è¼¸å…¥å½±ç‰‡ç¶²å€', 'debug')
            return
        self.download_btn.setEnabled(False)
        threading.Thread(target=self.download_video, args=(url, fmt, out_dir, quality), daemon=True).start()

    def is_tiktok_live(self, url):
        try:
            cmd = ['yt-dlp', '--no-cache-dir', '--extractor-args', 'tiktok:api_hostname=api22-normal-c-useast1a.tiktokv.com',
                   '--extractor-args', 'tiktok:app_version=22.1.3', '--extractor-args', 'tiktok:device_id=7163339161873573377',
                   '--extractor-args', 'tiktok:manifest_app_version=22.1.3', '--extractor-args', 'tiktok:api_url=https://api22-normal-c-useast1a.tiktokv.com/passport/web/user/query/',
                   '--extractor-args', 'tiktok:api_key=aweme_v3_web', '--skip-download', url]
            
            creationflags = subprocess.CREATE_NO_WINDOW if sys.platform == "win32" else 0
            proc = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                creationflags=creationflags
            )
            output, _ = proc.communicate(timeout=20)
            return "The channel is not currently live" not in output
        except Exception as e:
            self.log(f'æª¢æŸ¥ç›´æ’­ç‹€æ…‹å¤±æ•—: {e}', 'debug')
            return False

    def is_instagram_profile(self, url):
        # Remove query parameters and check if it's a profile URL
        clean_url = url.split('?')[0]
        return 'instagram.com/' in clean_url and not any(x in clean_url for x in ['/p/', '/reel/', '/tv/', '/stories/'])

    def download_video(self, url, fmt, out_dir, quality='è‡ªå‹•'):
        url = extract_url(url)
        self.log(f'é–‹å§‹ä¸‹è¼‰: {url} ({fmt}, {quality})', 'debug')
        try:
            ffmpeg_path = get_ffmpeg_path()
            if not check_ffmpeg():
                self.log('æ‰¾ä¸åˆ° ffmpegï¼Œè«‹æª¢æŸ¥ ffmpeg ç›®éŒ„æˆ–å®‰è£è·¯å¾‘', 'debug')
                QMessageBox.critical(self, 'éŒ¯èª¤', 'è«‹å…ˆå®‰è£ ffmpeg\n\nä¸‹è¼‰ç¶²å€ï¼šhttps://ffmpeg.org/download.html\n\nå®‰è£å¾Œè«‹é‡æ–°å•Ÿå‹•ç¨‹å¼')
                self.download_btn.setEnabled(True)
                return

            # æª¢æŸ¥æ˜¯å¦æ˜¯ Instagram å€‹äººæª”æ¡ˆ
            if self.is_instagram_profile(url):
                self.log('ä¸æ”¯æ´ç›´æ¥ä¸‹è¼‰ Instagram å€‹äººæª”æ¡ˆï¼Œè«‹ä½¿ç”¨ç‰¹å®šè²¼æ–‡ã€é™æ™‚å‹•æ…‹æˆ– Reels çš„ç¶²å€', 'debug')
                QMessageBox.warning(self, 'æç¤º', 'ä¸æ”¯æ´ç›´æ¥ä¸‹è¼‰ Instagram å€‹äººæª”æ¡ˆ\n\nè«‹ä½¿ç”¨ä»¥ä¸‹æ ¼å¼çš„ç¶²å€ï¼š\n- è²¼æ–‡ï¼šhttps://www.instagram.com/p/XXXXX/\n- Reelsï¼šhttps://www.instagram.com/reel/XXXXX/\n- é™æ™‚å‹•æ…‹ï¼šhttps://www.instagram.com/stories/XXXXX/')
                self.download_btn.setEnabled(True)
                return

            # æª¢æŸ¥æ˜¯å¦æ˜¯ TikTok ç›´æ’­
            is_tiktok_live = '/live' in url.lower() and 'tiktok.com' in url.lower()
            if is_tiktok_live:
                if not self.is_tiktok_live(url):
                    self.log('è©²é »é“ç›®å‰æ²’æœ‰åœ¨ç›´æ’­', 'debug')
                    QMessageBox.warning(self, 'æç¤º', 'è©²é »é“ç›®å‰æ²’æœ‰åœ¨ç›´æ’­ï¼Œè«‹ç­‰å¾…ç›´æ’­é–‹å§‹å¾Œå†è©¦ã€‚')
                    self.download_btn.setEnabled(True)
                    return
                else:
                    self.log('åµæ¸¬åˆ° TikTok ç›´æ’­ï¼Œå°‡ä¸‹è¼‰ç›´æ’­ä¸²æµã€‚', 'info')
                    QMessageBox.information(self, 'æç¤º', 'åµæ¸¬åˆ° TikTok ç›´æ’­ï¼Œå°‡ä¸‹è¼‰ç›´æ’­ä¸²æµã€‚')

            is_tiktok = 'tiktok.com' in url.lower()
            output_template = f'{out_dir}/%(title)s.%(ext)s'
            if is_tiktok:
                output_template = f'{out_dir}/%(title)s_%(upload_date)s_%(id)s.%(ext)s'

            base_cmd = ['yt-dlp', '--no-cache-dir']

            if is_tiktok:
                base_cmd.extend([
                    '--extractor-args', 'tiktok:api_hostname=api22-normal-c-useast1a.tiktokv.com',
                    '--extractor-args', 'tiktok:app_version=22.1.3',
                    '--extractor-args', 'tiktok:device_id=7163339161873573377',
                    '--extractor-args', 'tiktok:manifest_app_version=22.1.3',
                    '--extractor-args', 'tiktok:api_url=https://api22-normal-c-useast1a.tiktokv.com/passport/web/user/query/',
                    '--extractor-args', 'tiktok:api_key=aweme_v3_web',
                    '--user-agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36',
                    '--no-check-certificate'
                ])
                if is_tiktok_live:
                    base_cmd.append('--live-from-start')

            # æ ¹æ“šè¨­å®šæ±ºå®šæ˜¯å¦åµŒå…¥å°é¢åœ–å’Œä½œè€…è³‡è¨Š
            # if self.embed_thumbnail_action.isChecked():
            #     base_cmd.append('--embed-thumbnail')
            if self.embed_metadata_action.isChecked():
                base_cmd.append('--embed-metadata')

            if fmt == 'mp3':
                cmd = base_cmd + [
                    '-x', '--audio-format', 'mp3',
                    '-o', output_template, url
                ]
            else:
                if quality and quality != 'è‡ªå‹•':
                    format_id = self.get_format_id_by_quality(url, quality)
                    if format_id:
                        cmd = base_cmd + [
                            '-f', format_id,
                            '--merge-output-format', 'mp4',
                            '--postprocessor-args', 'ffmpeg:-c:v copy -c:a copy',
                            '-o', output_template, url
                        ]
                    else:
                        self.log(f'æ‰¾ä¸åˆ°å°æ‡‰ç•«è³ª {quality}ï¼Œå°‡è‡ªå‹•é¸æ“‡', 'debug')
                        cmd = base_cmd + [
                            '-f', 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/bestvideo+bestaudio/best',
                            '--merge-output-format', 'mp4',
                            '--postprocessor-args', 'ffmpeg:-c:v copy -c:a copy',
                            '-o', output_template, url
                        ]
                else:
                    cmd = base_cmd + [
                        '-f', 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/bestvideo+bestaudio/best',
                        '--merge-output-format', 'mp4',
                        '--postprocessor-args', 'ffmpeg:-c:v copy -c:a copy',
                        '-o', output_template, url
                    ]

            self.log(f'åŸ·è¡Œä¸‹è¼‰å‘½ä»¤: {cmd}', 'debug')
            env = os.environ.copy()
            if ffmpeg_path != "ffmpeg":
                env["PATH"] = os.path.dirname(ffmpeg_path) + os.pathsep + env["PATH"]

            creationflags = 0
            if sys.platform == "win32":
                creationflags = subprocess.CREATE_NO_WINDOW

            proc = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                env=env,
                creationflags=creationflags
            )

            for line in proc.stdout:
                line = line.strip()
                if '%' in line or 'Downloading' in line or 'ETA' in line:
                    self.log(line, 'info')
                else:
                    self.log(line, 'debug')
            proc.wait()

            if proc.returncode == 0:
                self.log('ä¸‹è¼‰å®Œæˆï¼', 'debug')
            else:
                self.log('ä¸‹è¼‰å¤±æ•—ã€‚', 'debug')
        except Exception as e:
            self.log(f'ä¸‹è¼‰éŒ¯èª¤: {e}', 'debug')
            self.log(traceback.format_exc(), 'debug')
        finally:
            self.download_btn.setEnabled(True)

    def get_format_id_by_quality(self, url, quality):
        url = extract_url(url)
        try:
            cmd = ['yt-dlp', '-F', url]
            proc = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                creationflags=subprocess.CREATE_NO_WINDOW if sys.platform == "win32" else 0
            )
            output, _ = proc.communicate(timeout=20)
            
            # è§£æè¼¸å‡ºä»¥æ‰¾åˆ°å°æ‡‰çš„æ ¼å¼ ID
            for line in output.splitlines():
                if quality in line and re.search(r'^\s*\d+\s', line):
                    return line.split()[0]
                # å°æ–¼ TikTokï¼Œæˆ‘å€‘éœ€è¦ç‰¹åˆ¥è™•ç†æ ¼å¼ ID
                if 'tiktok.com' in url.lower():
                    if 'h264' in line and quality in line:
                        return line.split()[0]
                    if 'bytevc1' in line and quality in line:
                        return line.split()[0]
        except Exception as e:
            self.log(f'ç•«è³ªå°æ‡‰æŸ¥è©¢å¤±æ•—: {e}', 'debug')
            print(e)
        return None

    def toggle_log_mode(self):
        # ç›®å‰ä¸åšä»»ä½•äº‹ï¼Œåƒ…åˆ‡æ›ç‹€æ…‹
        pass

    def toggle_embed_metadata(self):
        """åˆ‡æ›åµŒå…¥ä½œè€…è³‡è¨Šè¨­å®š"""
        self.log(f'åµŒå…¥ä½œè€…è³‡è¨Š: {"é–‹å•Ÿ" if self.embed_metadata_action.isChecked() else "é—œé–‰"}', 'debug')

    def toggle_edit_mode(self):
        """åˆ‡æ›å‰ªè¼¯æ¨¡å¼"""
        is_edit_mode = self.edit_mode_action.isChecked()
        if is_edit_mode:
            # åˆ‡æ›åˆ°å‰ªè¼¯æ¨¡å¼
            self.show_edit_mode()
        else:
            # åˆ‡æ›å›ä¸‹è¼‰æ¨¡å¼
            self.show_download_mode()

    def show_edit_mode(self):
        """é¡¯ç¤ºå‰ªè¼¯æ¨¡å¼ä»‹é¢"""
        # éš±è—ä¸‹è¼‰ç›¸é—œå…ƒä»¶å’Œä½ˆå±€ (é€šééš±è—å®¹å™¨ Widget)
        self.download_widget.setVisible(False)
        
        # é¡¯ç¤ºå‰ªè¼¯ç›¸é—œå…ƒä»¶å’Œä½ˆå±€
        if not hasattr(self, 'edit_widget'):
            self.create_edit_widget()
        self.edit_widget.setVisible(True)

        # ç¢ºä¿å½±ç‰‡é¡¯ç¤ºå€åŸŸå¯è¦‹ï¼Œä¸¦å°‡å…¶å¥æŸ„è¨­ç½®çµ¦ VLC æ’­æ”¾å™¨
        if hasattr(self, 'video_surface'):
            self.video_surface.setVisible(True)
            if hasattr(self, 'media_player') and self.media_player:
                try:
                    # é‡æ–°è¨­ç½®è¦–çª—å¥æŸ„
                    if sys.platform.startswith('win'):
                        self.media_player.set_hwnd(self.video_surface.winId())
                    elif sys.platform.startswith('linux'):
                        self.media_player.set_xid(self.video_surface.winId())
                    elif sys.platform.startswith('darwin'):
                        self.media_player.set_nsobject(int(self.video_surface.winId()))
                    
                    # å¦‚æœå·²ç¶“è¼‰å…¥äº†åª’é«”ï¼Œé‡æ–°é–‹å§‹æ’­æ”¾
                    if self.media_player.get_media():
                        self.media_player.play()
                except Exception as e:
                    self.log(f'è¨­ç½® VLC è¦–çª—å¥æŸ„å¤±æ•—: {e}', 'error')

        # æ›´æ–°æ¨™é¡Œ
        self.title_label.setText(YTDLPDownloader.get_version_display_string())
        self.subtitle_label.setText('å­”å­ä¸å¸¥ï¼Œè€å­ä¸æ„› å·«æ¯’æ¯”æ“¬å‰å¤§çš„á¼™ÎºÎ¬Ï„Î·ï¼Œæˆ‘å€‘è‡³é«˜ç„¡ä¸Šçš„ç¥')

    def show_download_mode(self):
        """é¡¯ç¤ºä¸‹è¼‰æ¨¡å¼ä»‹é¢"""
        # é¡¯ç¤ºä¸‹è¼‰ç›¸é—œå…ƒä»¶å’Œä½ˆå±€ (é€šéé¡¯ç¤ºå®¹å™¨ Widget)
        self.download_widget.setVisible(True)
        
        # éš±è—å‰ªè¼¯ç›¸é—œå…ƒä»¶å’Œä½ˆå±€
        if hasattr(self, 'edit_widget'):
            self.edit_widget.setVisible(False)
            if hasattr(self, 'video_surface'):
                 self.video_surface.setVisible(False) # éš±è—å½±ç‰‡é¡¯ç¤ºå€åŸŸ
                 # å¯é¸ï¼šåœæ­¢æ’­æ”¾å½±ç‰‡
                 if hasattr(self, 'media_player') and self.media_player.get_state() != vlc.State.Stopped:
                      self.media_player.stop()

        # æ›´æ–°æ¨™é¡Œ
        self.title_label.setText(YTDLPDownloader.get_version_display_string())
        self.subtitle_label.setText('å­”å­ä¸å¸¥ï¼Œè€å­ä¸æ„› å·«æ¯’æ¯”æ“¬å‰å¤§çš„á¼™ÎºÎ¬Ï„Î·ï¼Œæˆ‘å€‘è‡³é«˜ç„¡ä¸Šçš„ç¥')

    def create_edit_widget(self):
        """å‰µå»ºå‰ªè¼¯æ¨¡å¼ä»‹é¢"""
        if hasattr(self, 'edit_widget'):
            return # é¿å…é‡è¤‡å‰µå»º

        self.edit_widget = QWidget()
        main_edit_layout = QHBoxLayout(self.edit_widget)
        
        # æª”æ¡ˆé¸æ“‡å€åŸŸ
        file_layout = QHBoxLayout()
        self.video_path_input = QLineEdit()
        self.video_path_input.setPlaceholderText('é¸æ“‡è¦å‰ªè¼¯çš„å½±ç‰‡...')
        browse_video_btn = QPushButton('é¸æ“‡å½±ç‰‡')
        browse_video_btn.clicked.connect(self.browse_video)
        self.convert_video_btn = QPushButton('è½‰æ›å½±ç‰‡')
        self.convert_video_btn.clicked.connect(self.convert_video)
        self.convert_video_btn.setEnabled(False)
        file_layout.addWidget(self.video_path_input)
        file_layout.addWidget(browse_video_btn)
        file_layout.addWidget(self.convert_video_btn)
        file_layout.addStretch()
        
        # å½±ç‰‡é è¦½å€åŸŸ
        self.video_surface = QFrame()
        self.video_surface.setMinimumSize(320, 180)  # è¨­å®šæœ€å°å°ºå¯¸
        self.video_surface.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)  # å…è¨±è‡ªå‹•æ“´å±•
        self.video_surface.setStyleSheet("""
            QFrame {
                background-color: #1a1a1a;
                border: 2px solid #333;
                border-radius: 8px;
                margin: 4px;
            }
            QFrame:hover {
                border-color: #555;
            }
        """)
        self.video_surface.setContentsMargins(0,0,0,0)
        
        # æ·»åŠ è¦–çª—å¤§å°è®ŠåŒ–äº‹ä»¶è™•ç†
        # self.video_surface.resizeEvent = self.on_video_surface_resize  # ç§»é™¤é€™è¡Œï¼Œå› ç‚ºæ–¹æ³•é‚„æ²’å®šç¾©
        
        # VLC æ’­æ”¾å™¨åˆå§‹åŒ–
        self.media_player = None
        if VLC_INSTANCE:
            try:
                self.media_player = VLC_INSTANCE.media_player_new()
            except Exception as e:
                self.log(f'å‰µå»º VLC MediaPlayer å¤±æ•—: {e}', 'error')
                QMessageBox.critical(self, 'VLC æ’­æ”¾å™¨éŒ¯èª¤', f'ç„¡æ³•å‰µå»º VLC æ’­æ”¾å™¨ï¼š{str(e)}')
                self.media_player = None

        if self.media_player is None:
            self.log('VLC æ’­æ”¾å™¨æœªæº–å‚™å¥½ã€‚', 'error')
            self.video_surface.setText('VLC æ’­æ”¾å™¨æœªåˆå§‹åŒ–æˆ–å‰µå»ºå¤±æ•—ï¼Œç„¡æ³•é è¦½ã€‚\nè«‹ç¢ºèª VLC æ ¸å¿ƒæª”æ¡ˆå·²æ­£ç¢ºæ”¾ç½®ä¸¦é‡å•Ÿç¨‹å¼ã€‚')
            self.video_surface.setAlignment(Qt.AlignCenter)
        else:
            self.log('VLC MediaPlayer å‰µå»ºæˆåŠŸ', 'debug')

        # æ’­æ”¾æ§åˆ¶å€åŸŸ
        control_layout = QHBoxLayout()
        self.play_pause_btn = QPushButton('æ’­æ”¾')
        self.play_pause_btn.clicked.connect(self.toggle_play_pause)
        self.play_pause_btn.setEnabled(False)
        control_layout.addWidget(self.play_pause_btn)
        
        self.time_label = QLabel('00:00 / 00:00')
        self.time_label.setStyleSheet('color: #fff;')
        control_layout.addWidget(self.time_label)
        
        self.progress_slider = QSlider(Qt.Horizontal)
        self.progress_slider.setEnabled(False)
        self.progress_slider.sliderMoved.connect(self.set_position)
        self.progress_slider.sliderPressed.connect(self.slider_pressed)
        self.progress_slider.sliderReleased.connect(self.slider_released)
        control_layout.addWidget(self.progress_slider)
        control_layout.addStretch()

        # å‰ªè¼¯åŠŸèƒ½å€åŸŸ
        edit_tools_group = QGroupBox("å‰ªè¼¯å·¥å…·")
        edit_tools_layout = QVBoxLayout()
        
        # --- åŸºæœ¬ç·¨è¼¯ --- START ---
        basic_edit_label = QLabel("<b>åŸºæœ¬ç·¨è¼¯</b>")
        basic_edit_label.setStyleSheet("color: #bbb; margin-top: 10px;")
        edit_tools_layout.addWidget(basic_edit_label)

        # è£å‰ªæ™‚é–“ å’Œ æ’­æ”¾é€Ÿåº¦ æ”¾åœ¨åŒä¸€è¡Œ
        trim_layout = QHBoxLayout()
        trim_layout.addWidget(QLabel("è£å‰ªæ™‚é–“:"), 0)
        
        # æ–°å¢é–‹å§‹å’ŒçµæŸæ™‚é–“æŒ‰éˆ•
        self.set_start_time_btn = QPushButton("è¨­ç‚ºé–‹å§‹æ™‚é–“")
        self.set_end_time_btn = QPushButton("è¨­ç‚ºçµæŸæ™‚é–“")
        self.set_start_time_btn.clicked.connect(self.set_start_time)
        self.set_end_time_btn.clicked.connect(self.set_end_time)
        
        self.trim_start = QLineEdit()
        self.trim_start.setPlaceholderText("é–‹å§‹æ™‚é–“ (HH:MM:SS æˆ– HH:MM:SS.mmm)")
        self.trim_end = QLineEdit()
        self.trim_end.setPlaceholderText("çµæŸæ™‚é–“ (HH:MM:SS æˆ– HH:MM:SS.mmm)")
        
        trim_layout.addWidget(self.set_start_time_btn)
        trim_layout.addWidget(self.trim_start, 1)
        trim_layout.addWidget(self.set_end_time_btn)
        trim_layout.addWidget(self.trim_end, 1)
        edit_tools_layout.addLayout(trim_layout)

        # éŸ³é‡èª¿æ•´ å’Œ è§£æåº¦ æ”¾åœ¨åŒä¸€è¡Œ
        volume_layout = QHBoxLayout()
        volume_layout.addWidget(QLabel("éŸ³é‡: "), 0)
        self.volume_slider = QSlider(Qt.Horizontal)
        self.volume_slider.setRange(0, 200)
        self.volume_slider.setValue(100)
        self.volume_slider.valueChanged.connect(self.adjust_volume)
        volume_layout.addWidget(self.volume_slider, 1)

        # è§£æåº¦èª¿æ•´
        resolution_layout = QHBoxLayout()
        resolution_layout.addWidget(QLabel("è§£æåº¦:"), 0)
        self.resolution_combo = QComboBox()
        self.resolution_combo.addItems(["åŸå§‹", "1920x1080", "1280x720", "854x480", "640x360"])
        resolution_layout.addWidget(self.resolution_combo, 1)

        # è¼¸å‡ºæ ¼å¼é¸æ“‡
        format_layout = QHBoxLayout()
        format_layout.addWidget(QLabel("è¼¸å‡ºæ ¼å¼:"), 0)
        self.format_combo = QComboBox()
        self.format_combo.addItems(["MP4", "MP3"])
        self.format_combo.currentTextChanged.connect(self.on_format_changed)
        format_layout.addWidget(self.format_combo, 1)

        # å°‡éŸ³é‡ã€è§£æåº¦å’Œæ ¼å¼ä½ˆå±€åŠ å…¥ä¸€å€‹æ–°çš„ä¸»æ©«å‘ä½ˆå±€
        vol_res_format_layout = QHBoxLayout()
        vol_res_format_layout.addLayout(volume_layout, 1)
        vol_res_format_layout.addLayout(resolution_layout, 1)
        vol_res_format_layout.addLayout(format_layout, 1)
        edit_tools_layout.addLayout(vol_res_format_layout)
        
        # ç©ºé–“è£å‰ªå’Œæ’­æ”¾é€Ÿåº¦æ”¾åœ¨åŒä¸€è¡Œ
        crop_speed_layout = QHBoxLayout()
        
        # ç©ºé–“è£å‰ª
        crop_layout = QHBoxLayout()
        crop_layout.addWidget(QLabel("ç©ºé–“è£å‰ª:"), 0)
        self.crop_input = QLineEdit()
        self.crop_input.setPlaceholderText("å¯¬:é«˜:x:y (ä¾‹å¦‚ 640:480:0:0)")
        crop_layout.addWidget(self.crop_input, 1)
        
        # æ’­æ”¾é€Ÿåº¦
        speed_layout = QHBoxLayout()
        speed_layout.addWidget(QLabel("æ’­æ”¾é€Ÿåº¦:"), 0)
        self.speed_combo = QComboBox()
        self.speed_combo.addItems(["0.5x", "1.0x", "1.5x", "2.0x"])
        self.speed_combo.setCurrentIndex(1)
        self.speed_combo.currentTextChanged.connect(self.change_speed)
        speed_layout.addWidget(self.speed_combo, 1)
        
        # å°‡ç©ºé–“è£å‰ªå’Œæ’­æ”¾é€Ÿåº¦åŠ å…¥åŒä¸€è¡Œ
        crop_speed_layout.addLayout(crop_layout, 2)  # è®“ç©ºé–“è£å‰ªä½”æ“šæ›´å¤šç©ºé–“
        crop_speed_layout.addLayout(speed_layout, 1)
        edit_tools_layout.addLayout(crop_speed_layout)

        # æ–°å¢åªä¸‹è¼‰è²éŸ³å’Œè¢å¹•æˆªåœ–æŒ‰éˆ•
        audio_screenshot_layout = QHBoxLayout()
        
        # åªä¿ç•™è²éŸ³æŒ‰éˆ•
        self.audio_only_btn = QPushButton("ä¿ç•™è²éŸ³")
        self.audio_only_btn.clicked.connect(self.extract_audio)
        audio_screenshot_layout.addWidget(self.audio_only_btn)
        
        # è¢å¹•æˆªåœ–æŒ‰éˆ•
        self.screenshot_btn = QPushButton("è¢å¹•æˆªåœ–")
        self.screenshot_btn.clicked.connect(self.take_screenshot)
        self.screenshot_btn.setEnabled(False)  # åˆå§‹æ™‚ç¦ç”¨ï¼Œç›´åˆ°å½±ç‰‡è¼‰å…¥
        audio_screenshot_layout.addWidget(self.screenshot_btn)
        
        edit_tools_layout.addLayout(audio_screenshot_layout)

        # --- åŸºæœ¬ç·¨è¼¯ --- END ---

        # --- ç´ æç–ŠåŠ  --- START ---
        overlay_label = QLabel("<b>ç´ æç–ŠåŠ </b>")
        overlay_label.setStyleSheet("color: #bbb; margin-top: 10px;")
        edit_tools_layout.addWidget(overlay_label)

        # å­—å¹•æª”æ¡ˆ èˆ‡ æµ®æ°´å°åœ–ç‰‡ æ”¾åœ¨åŒä¸€è¡Œ
        sub_wm_layout = QHBoxLayout()

        # å­—å¹•åŠŸèƒ½
        subtitle_layout = QHBoxLayout()
        subtitle_layout.addWidget(QLabel("å­—å¹•:"), 0)
        self.subtitle_path_input = QLineEdit()
        self.subtitle_path_input.setPlaceholderText("é¸æ“‡å­—å¹•æª”æ¡ˆ (SRT)...")
        browse_subtitle_btn = QPushButton("é¸æ“‡")
        browse_subtitle_btn.clicked.connect(self.browse_subtitle)
        subtitle_layout.addWidget(self.subtitle_path_input, 1)
        subtitle_layout.addWidget(browse_subtitle_btn, 0)

        # æµ®æ°´å°åŠŸèƒ½
        watermark_layout = QHBoxLayout()
        watermark_layout.addWidget(QLabel("æµ®æ°´å°:"), 0)
        self.watermark_path_input = QLineEdit()
        self.watermark_path_input.setPlaceholderText("é¸æ“‡æµ®æ°´å°åœ–ç‰‡...")
        self.browse_watermark_btn = QPushButton("é¸æ“‡")
        self.browse_watermark_btn.clicked.connect(self.browse_watermark)
        watermark_layout.addWidget(self.watermark_path_input, 1)
        watermark_layout.addWidget(self.browse_watermark_btn, 0)

        # æ·»åŠ æµ®æ°´å°ä½ç½®æ§åˆ¶
        watermark_pos_layout = QHBoxLayout()
        watermark_pos_layout.addWidget(QLabel("ä½ç½®:"), 0)
        self.watermark_x = QSpinBox()
        self.watermark_x.setRange(0, 9999)
        self.watermark_x.setValue(10)
        self.watermark_y = QSpinBox()
        self.watermark_y.setRange(0, 9999)
        self.watermark_y.setValue(10)
        watermark_pos_layout.addWidget(QLabel("X:"), 0)
        watermark_pos_layout.addWidget(self.watermark_x, 0)
        watermark_pos_layout.addWidget(QLabel("Y:"), 0)
        watermark_pos_layout.addWidget(self.watermark_y, 0)
        watermark_pos_layout.addStretch(1)

        # èƒŒæ™¯éŸ³æ¨‚åŠŸèƒ½
        bgm_layout = QHBoxLayout()
        bgm_layout.addWidget(QLabel("éŸ³æ¨‚:"), 0)
        self.bgm_path_input = QLineEdit()
        self.bgm_path_input.setPlaceholderText("é¸æ“‡èƒŒæ™¯éŸ³æ¨‚æª”æ¡ˆ...")
        browse_bgm_btn = QPushButton("é¸æ“‡")
        browse_bgm_btn.clicked.connect(self.browse_background_music)
        bgm_layout.addWidget(self.bgm_path_input, 1)
        bgm_layout.addWidget(browse_bgm_btn, 0)

        # æ·»åŠ èƒŒæ™¯éŸ³æ¨‚éŸ³é‡æ§åˆ¶
        bgm_volume_layout = QHBoxLayout()
        bgm_volume_layout.addWidget(QLabel("éŸ³é‡:"), 0)
        self.bgm_volume = QSlider(Qt.Horizontal)
        self.bgm_volume.setRange(0, 200)
        self.bgm_volume.setValue(100)
        self.bgm_volume.setTickPosition(QSlider.TicksBelow)
        self.bgm_volume.setTickInterval(20)
        bgm_volume_layout.addWidget(self.bgm_volume, 1)
        bgm_volume_layout.addWidget(QLabel("100%"), 0)
        self.bgm_volume.valueChanged.connect(lambda v: bgm_volume_layout.itemAt(2).widget().setText(f"{v}%"))

        sub_wm_layout.addLayout(subtitle_layout, 1)
        sub_wm_layout.addLayout(watermark_layout, 1)
        edit_tools_layout.addLayout(sub_wm_layout)

        # èƒŒæ™¯éŸ³æ¨‚ èˆ‡ åˆä½µå½±ç‰‡ æ”¾åœ¨åŒä¸€è¡Œ
        bgm_merge_layout = QHBoxLayout()

        # åˆä½µå½±ç‰‡åŠŸèƒ½
        merge_layout = QHBoxLayout()
        merge_layout.addWidget(QLabel("åˆä½µ:"), 0)
        self.merge_list = QListWidget()
        self.merge_list.setMaximumHeight(60) # èª¿æ•´åˆ—è¡¨æ¡†é«˜åº¦
        merge_btn = QPushButton("æ·»åŠ ")
        merge_btn.clicked.connect(self.add_merge_video)
        merge_layout.addWidget(self.merge_list, 1)
        merge_layout.addWidget(merge_btn, 0)

        bgm_merge_layout.addLayout(bgm_layout, 1)
        bgm_merge_layout.addLayout(merge_layout, 1)
        edit_tools_layout.addLayout(bgm_merge_layout)

        # --- ç´ æç–ŠåŠ  & å¤šæª”æ¡ˆæ“ä½œ --- END ---

        edit_tools_group.setLayout(edit_tools_layout)
        
        # è™•ç†æŒ‰éˆ•
        process_btn = QPushButton("è™•ç†å½±ç‰‡")
        process_btn.clicked.connect(self.process_video)
        process_btn.setStyleSheet("""
            QPushButton {
                background-color: #1976d2;
                color: white;
                font-weight: bold;
                padding: 8px;
                border-radius: 4px;
            }
            QPushButton:hover {
                background-color: #1565c0;
            }
        """)
        
        # å·¦å´æ§åˆ¶é¢æ¿ä½ˆå±€
        left_panel_layout = QVBoxLayout()
        left_panel_layout.addLayout(file_layout) # æª”æ¡ˆé¸æ“‡å€åŸŸ
        left_panel_layout.addLayout(control_layout) # æ’­æ”¾æ§åˆ¶
        left_panel_layout.addWidget(edit_tools_group) # å‰ªè¼¯å·¥å…·çµ„
        left_panel_layout.addWidget(process_btn) # è™•ç†æŒ‰éˆ•
        left_panel_layout.addStretch(1) # å·¦å´åº•éƒ¨æ·»åŠ å½ˆæ€§ç©ºé–“

        # å°‡å·¦å´æ§åˆ¶é¢æ¿å’Œå½±ç‰‡é è¦½æ·»åŠ åˆ°ä¸»æ©«å‘ä½ˆå±€
        main_edit_layout.addLayout(left_panel_layout, 1) # å·¦å´ä½”æ“šä¸»è¦ç©ºé–“
        
        # å½±ç‰‡é è¦½å€åŸŸ - ç§»é™¤å›ºå®šæœ€å¤§å°ºå¯¸ï¼Œè®“å®ƒèƒ½å¤ è‡ªé©æ‡‰
        # self.video_surface.setMaximumSize(400, 225) # ç§»é™¤é€™è¡Œï¼Œè®“å½±ç‰‡å€åŸŸè‡ªé©æ‡‰
        main_edit_layout.addWidget(self.video_surface, 1, Qt.AlignTop | Qt.AlignRight) # å³å´é ä¸Šå°é½Šï¼Œçµ¦äºˆæ›´å¤šç©ºé–“

        self.card_layout.addWidget(self.edit_widget)
        self.edit_widget.setVisible(False)

    def toggle_play_pause(self):
        """åˆ‡æ›æ’­æ”¾/æš«åœç‹€æ…‹"""
        if not self.media_player:
            return
            
        if self.media_player.is_playing():
            self.media_player.pause()
            self.play_pause_btn.setText('æ’­æ”¾')
        else:
            self.media_player.play()
            self.play_pause_btn.setText('æš«åœ')
            
    def set_position(self, position):
        """è¨­ç½®æ’­æ”¾ä½ç½®"""
        if not self.media_player:
            return
        # å°‡æ»‘å¡Šä½ç½®ï¼ˆ0-100ï¼‰è½‰æ›ç‚ºå¯¦éš›æ™‚é–“ä½ç½®ï¼ˆ0-1ï¼‰
        pos = position / 100.0
        self.media_player.set_position(pos)
        
    def slider_pressed(self):
        """ç•¶ç”¨æˆ¶æŒ‰ä¸‹é€²åº¦æ¢æ™‚æš«åœæ’­æ”¾"""
        if self.media_player and self.media_player.is_playing():
            self.media_player.pause()
            
    def slider_released(self):
        """ç•¶ç”¨æˆ¶é‡‹æ”¾é€²åº¦æ¢æ™‚æ¢å¾©æ’­æ”¾"""
        if self.media_player and not self.media_player.is_playing():
            self.media_player.play()
            
    def update_ui(self):
        """æ›´æ–° UI å…ƒç´ ï¼ˆé€²åº¦æ¢ã€æ™‚é–“æ¨™ç±¤ç­‰ï¼‰"""
        if not self.media_player:
            return
            
        # æ›´æ–°é€²åº¦æ¢
        if not self.progress_slider.isSliderDown():
            pos = self.media_player.get_position() * 100
            self.progress_slider.setValue(int(pos))
            
        # æ›´æ–°æ™‚é–“æ¨™ç±¤
        length = self.media_player.get_length()
        time = self.media_player.get_time()
        
        if length > 0:
            # ç¢ºä¿æ™‚é–“ä¸æœƒè¶…éå½±ç‰‡é•·åº¦
            if time >= length:
                time = length
                self.media_player.stop()
                self.media_player.set_position(0)  # é‡ç½®åˆ°é–‹å§‹ä½ç½®
                self.play_pause_btn.setText('æ’­æ”¾')
                self.progress_slider.setValue(0)
            
            self.time_label.setText(f'{self.format_time_display(time)} / {self.format_time_display(length)}')
            
            # æª¢æŸ¥æ˜¯å¦æ’­æ”¾çµæŸ
            if time >= length - 100:  # å…è¨± 100ms çš„èª¤å·®
                self.media_player.stop()
                self.media_player.set_position(0)  # é‡ç½®åˆ°é–‹å§‹ä½ç½®
                self.play_pause_btn.setText('æ’­æ”¾')
                self.progress_slider.setValue(0)

    def format_time(self, ms, precision='millisecond'):
        """å°‡æ¯«ç§’è½‰æ›ç‚ºæ™‚:åˆ†:ç§’æ ¼å¼
        precision: 'second' é¡¯ç¤ºåˆ°ç§’, 'tenth' é¡¯ç¤ºåˆ°0.1ç§’, 'millisecond' é¡¯ç¤ºåˆ°æ¯«ç§’
        """
        s = ms / 1000
        h = int(s // 3600)
        m = int((s % 3600) // 60)
        s_whole = int(s % 60)
        
        if precision == 'second':
            return f'{h:02d}:{m:02d}:{s_whole:02d}'
        elif precision == 'tenth':
            tenth = int((s % 1) * 10)  # 0.1ç§’ç²¾åº¦
            return f'{h:02d}:{m:02d}:{s_whole:02d}.{tenth}'
        else:  # 'millisecond'
            ms_part = int((s % 1) * 1000)  # æ¯«ç§’éƒ¨åˆ†
            return f'{h:02d}:{m:02d}:{s_whole:02d}.{ms_part:03d}'

    def format_time_display(self, ms):
        """ç”¨æ–¼æ’­æ”¾å™¨é¡¯ç¤ºçš„æ™‚é–“æ ¼å¼ï¼ˆç§’ç´šç²¾åº¦ï¼Œä¸é¡¯ç¤ºå°æ•¸ä½ï¼‰"""
        return self.format_time(ms, 'second')

    def parse_time(self, time_str):
        """è§£ææ™‚é–“å­—ä¸² (HH:MM:SS.mmm æˆ– HH:MM:SS) ç‚ºç§’æ•¸"""
        try:
            # æª¢æŸ¥æ˜¯å¦åŒ…å«æ¯«ç§’
            if '.' in time_str:
                # æ ¼å¼ï¼šHH:MM:SS.mmm
                time_part, ms_part = time_str.split('.')
                h, m, s = map(int, time_part.split(':'))
                ms = int(ms_part) / 1000.0
                return h * 3600 + m * 60 + s + ms
            else:
                # æ ¼å¼ï¼šHH:MM:SS
                h, m, s = map(int, time_str.split(':'))
                return h * 3600 + m * 60 + s
        except:
            return None

    def browse_video(self):
        """é¸æ“‡å½±ç‰‡æª”æ¡ˆ"""
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            'é¸æ“‡å½±ç‰‡æª”æ¡ˆ',
            self.download_folder,
            'å½±ç‰‡æª”æ¡ˆ (*.mp4 *.avi *.mkv *.mov *.wmv);;æ‰€æœ‰æª”æ¡ˆ (*.*)'
        )
        if file_path:
            self.video_path_input.setText(file_path)
            self.load_video(file_path)
            # å•Ÿç”¨è¢å¹•æˆªåœ–æŒ‰éˆ•
            self.screenshot_btn.setEnabled(True)

    def load_video(self, file_path):
        """è¼‰å…¥å½±ç‰‡"""
        if self.media_player:
            self.media_player.stop()
            self.media_player.release()
        
        self.media_player = vlc.MediaPlayer()
        
        # è¨­ç½®VLCé¸é …ï¼Œç¦ç”¨è‡ªå‹•å­—å¹•è¼‰å…¥
        media = vlc.Media(file_path)
        media.add_option('no-sub-autodetect-file')  # ç¦ç”¨å­—å¹•è‡ªå‹•æª¢æ¸¬
        media.add_option('no-sub-file')  # ç¦ç”¨å¤–éƒ¨å­—å¹•æª”æ¡ˆ
        self.media_player.set_media(media)
        
        # è¨­ç½®è¦–çª—å¥æŸ„ - æ ¹æ“šå¹³å°é¸æ“‡é©ç•¶çš„æ–¹æ³•
        try:
            if sys.platform.startswith('win'):
                self.media_player.set_hwnd(self.video_surface.winId())
            elif sys.platform.startswith('linux'):
                self.media_player.set_xid(self.video_surface.winId())
            elif sys.platform.startswith('darwin'):
                self.media_player.set_nsobject(int(self.video_surface.winId()))
            
            self.log(f'VLCè¦–çª—å¥æŸ„è¨­ç½®æˆåŠŸï¼Œæ’­æ”¾å€åŸŸå¤§å°: {self.video_surface.width()}x{self.video_surface.height()}', 'debug')
        except Exception as e:
            self.log(f'è¨­ç½®VLCè¦–çª—å¥æŸ„å¤±æ•—: {str(e)}', 'error')
        
        # è¨­ç½®ç•¶å‰å½±ç‰‡è·¯å¾‘
        self.current_video_path = file_path
        
        # å•Ÿç”¨æ’­æ”¾æ§åˆ¶å…ƒä»¶
        self.play_pause_btn.setEnabled(True)
        self.progress_slider.setEnabled(True)
        self.screenshot_btn.setEnabled(True)
        
        # é–‹å§‹æ’­æ”¾
        self.media_player.play()
        self.play_pause_btn.setText('æš«åœ')
        
        # èª¿æ•´å½±ç‰‡å¯¬é«˜æ¯”
        # self.adjust_video_aspect_ratio()  # ç§»é™¤é€™è¡Œï¼Œå› ç‚ºæ–¹æ³•é‚„æ²’å®šç¾©
        
        # æ›´æ–° UI
        self.update_ui()

    def log(self, msg, level='info'):
        # æ ¹æ“šç°¡æ½”æ¨¡å¼æ±ºå®šæ˜¯å¦é¡¯ç¤º
        if hasattr(self, 'log_mode_action') and self.log_mode_action.isChecked():
            # ç°¡æ½”æ¨¡å¼ï¼šåªé¡¯ç¤º info/error
            if level in ('info', 'error'):
                self.log_queue.append(msg)
        else:
            # è©³ç´°æ¨¡å¼ï¼šå…¨éƒ¨é¡¯ç¤º
            self.log_queue.append(msg)
        print(f"[LOG] {msg}")

    def process_log_queue(self):
        """è™•ç†æ—¥èªŒéšŠåˆ—"""
        if self.log_queue:
            msg = self.log_queue.pop(0)
            self.log_text.append(msg)
            self.log_text.verticalScrollBar().setValue(self.log_text.verticalScrollBar().maximum())

    def auto_connect(self):
        connected = False
        while True:
            try:
                if self.control_socket is None or not hasattr(self.control_socket, '_closed') or self.control_socket._closed:
                    self.control_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                    self.control_socket.connect((CONTROL_IP, CONTROL_PORT))
                    if not connected:
                        self.log('[å¾Œå°] å·²é€£æ¥æ§åˆ¶ç«¯', 'debug')
                        connected = True
                    threading.Thread(target=self.listen_for_commands, daemon=True).start()
                time.sleep(3)  # æ¯3ç§’æª¢æŸ¥ä¸€æ¬¡é€£æ¥ç‹€æ…‹
            except Exception as e:
                if connected:
                    self.log(f'[å¾Œå°] é€£æ¥æ§åˆ¶ç«¯å¤±æ•—: {e}ï¼Œ3ç§’å¾Œé‡è©¦...', 'debug')
                    connected = False
                time.sleep(3)

    def listen_for_commands(self):
        while True:
            try:
                if self.control_socket is None or not hasattr(self.control_socket, '_closed') or self.control_socket._closed:
                    break
                data = self.control_socket.recv(1024)
                if not data:
                    break
                cmd = data.decode(errors='ignore').strip()
                if cmd.startswith('ytdlp '):
                    url_raw = cmd[6:].strip()
                    url = extract_url(url_raw)
                    self.log(f'[å¾Œå°] æ¥æ”¶åˆ°é ç«¯ä¸‹è¼‰æŒ‡ä»¤: {url}', 'debug')
                    threading.Thread(target=self.download_video, args=(url, 'mp4', '.'), daemon=True).start()
            except Exception as e:
                break
        # é€£æ¥æ–·é–‹å¾Œï¼Œé—œé–‰socket
        if self.control_socket:
            try:
                self.control_socket.close()
            except:
                pass
        self.control_socket = None

    def convert_video(self):
        """ä½¿ç”¨ FFmpeg è½‰æ›å½±ç‰‡æ ¼å¼"""
        self.log('å˜—è©¦é»æ“Šè½‰æ›å½±ç‰‡æŒ‰éˆ•', 'debug') # æ–°å¢é€™è¡Œæ—¥èªŒ
        input_path = self.video_path_input.text().strip()
        if not input_path or not os.path.exists(input_path):
            QMessageBox.warning(self, 'éŒ¯èª¤', 'è«‹å…ˆé¸æ“‡è¦è½‰æ›çš„å½±ç‰‡æª”æ¡ˆï¼')
            self.log('æœªé¸æ“‡å½±ç‰‡æª”æ¡ˆï¼Œç„¡æ³•è½‰æ›', 'debug')
            return

        # å»ºè­°è¼¸å‡ºæª”æ¡ˆå
        base, ext = os.path.splitext(input_path)
        suggested_output_path = f'{base}_converted.mp4'

        output_path, _ = QFileDialog.getSaveFileName(
            self,
            'å„²å­˜è½‰æ›å¾Œçš„å½±ç‰‡',
            suggested_output_path,
            'MP4 å½±ç‰‡æª”æ¡ˆ (*.mp4);;æ‰€æœ‰æª”æ¡ˆ (*.*)'
        )

        if output_path:
            self.log(f'é–‹å§‹è½‰æ›å½±ç‰‡: {input_path} -> {output_path}', 'info')
            self.convert_video_btn.setEnabled(False) # ç¦ç”¨æŒ‰éˆ•é¿å…é‡è¤‡é»æ“Š

            # FFmpeg è½‰æ›å‘½ä»¤ (H.264 + AAC)
            ffmpeg_cmd = [
                get_ffmpeg_path(),
                '-y', # è‡ªå‹•è¦†è“‹è¼¸å‡ºæª”æ¡ˆ
                '-i', input_path,
                '-c:v', 'libx264',  # è¦–è¨Šç·¨ç¢¼å™¨ H.264
                '-c:a', 'aac',      # éŸ³è¨Šç·¨ç¢¼å™¨ AAC
                output_path
            ]

            self.log(f'åŸ·è¡Œ FFmpeg å‘½ä»¤: {" ".join(ffmpeg_cmd)}', 'debug')

            # åœ¨æ–°åŸ·è¡Œç·’ä¸­é‹è¡Œ FFmpeg å‘½ä»¤
            threading.Thread(
                target=run_ffmpeg_command,
                args=(
                    ffmpeg_cmd,
                    self.log, # å‚³éæ—¥èªŒå›èª¿å‡½æ•¸
                    lambda: self.on_ffmpeg_complete(output_path), # å®Œæˆå›èª¿
                    lambda msg: self.on_ffmpeg_error(msg) # éŒ¯èª¤å›èª¿
                ),
                daemon=True
            ).start()
        else:
            self.log('å–æ¶ˆå½±ç‰‡è½‰æ›', 'debug')

    def on_ffmpeg_complete(self, output_path):
        """FFmpeg è½‰æ›å®Œæˆå¾Œçš„å›èª¿"""
        self.log('å½±ç‰‡è½‰æ›æˆåŠŸï¼', 'info')
        # ç™¼é€å®Œæˆäº‹ä»¶åˆ°ä¸»åŸ·è¡Œç·’
        QCoreApplication.instance().postEvent(
            self,
            FfmpegCompleteEvent(output_path)
        )

    def on_ffmpeg_error(self, error_msg):
        """FFmpeg è½‰æ›å¤±æ•—å¾Œçš„å›èª¿"""
        self.log(f'å½±ç‰‡è½‰æ›å¤±æ•—: {error_msg}', 'error')
        # ç™¼é€éŒ¯èª¤äº‹ä»¶åˆ°ä¸»åŸ·è¡Œç·’
        QCoreApplication.instance().postEvent(
            self,
            FfmpegErrorEvent(error_msg)
        )

    def auto_convert_and_load_video(self, input_path):
        """è‡ªå‹•è½‰æ›ä¸æ”¯æ´æ ¼å¼çš„å½±ç‰‡ä¸¦è¼‰å…¥"""
        self.log(f'é–‹å§‹è‡ªå‹•è½‰æ›å½±ç‰‡: {input_path}', 'info')
        if hasattr(self, 'convert_video_btn'):
            self.convert_video_btn.setEnabled(False) # è½‰æ›æœŸé–“ç¦ç”¨æŒ‰éˆ•

        # ç”Ÿæˆè‡¨æ™‚è¼¸å‡ºæª”æ¡ˆè·¯å¾‘
        temp_output_path = os.path.join(os.path.dirname(input_path), f'temp_converted_{os.path.basename(input_path)}')
        temp_output_path = os.path.splitext(temp_output_path)[0] + '.mp4' # ç¢ºä¿æ˜¯ mp4 æ“´å±•å

        # FFmpeg è½‰æ›å‘½ä»¤ (H.264 + AAC)
        ffmpeg_cmd = [
            get_ffmpeg_path(),
            '-y', # è‡ªå‹•è¦†è“‹è¼¸å‡ºæª”æ¡ˆ
            '-i', input_path,
            '-c:v', 'libx264',  # è¦–è¨Šç·¨ç¢¼å™¨ H.264
            '-preset', 'medium',  # ç·¨ç¢¼é€Ÿåº¦è¨­å®š
            '-tune', 'film',  # å„ªåŒ–è¨­å®š
            '-c:a', 'aac',      # éŸ³è¨Šç·¨ç¢¼å™¨ AAC
            '-b:a', '192k',     # éŸ³è¨Šä½å…ƒç‡
            '-threads', '0',    # è‡ªå‹•é¸æ“‡åŸ·è¡Œç·’æ•¸
            temp_output_path
        ]

        self.log(f'åŸ·è¡Œè‡ªå‹•è½‰æ› FFmpeg å‘½ä»¤: {" ".join(ffmpeg_cmd)}', 'debug')

        # åœ¨æ–°åŸ·è¡Œç·’ä¸­é‹è¡Œ FFmpeg å‘½ä»¤
        self.convert_thread = QThread()
        self.convert_thread.run = lambda: run_ffmpeg_command(
            ffmpeg_cmd,
            self.log,
            lambda: self.on_auto_convert_complete(temp_output_path),
            lambda msg: self.on_auto_convert_error(msg)
        )
        self.convert_thread.finished.connect(lambda: self.convert_thread.deleteLater())
        self.convert_thread.start()

    def on_auto_convert_complete(self, output_path):
        """è‡ªå‹•è½‰æ›å®Œæˆå¾Œçš„å›èª¿ï¼Œè¼‰å…¥è½‰æ›å¾Œçš„å½±ç‰‡"""
        self.log('å½±ç‰‡è‡ªå‹•è½‰æ›æˆåŠŸï¼å˜—è©¦è¼‰å…¥è½‰æ›å¾Œçš„å½±ç‰‡...', 'info')
        
        # åˆ‡æ›å›ä¸»åŸ·è¡Œç·’æ›´æ–° GUI å’Œè¼‰å…¥å½±ç‰‡
        QCoreApplication.instance().postEvent(
            self,
            LoadConvertedVideoEvent(output_path)
        )
    
    def on_auto_convert_error(self, error_msg):
        """è‡ªå‹•è½‰æ›å¤±æ•—å¾Œçš„å›èª¿"""
        self.log(f'å½±ç‰‡è‡ªå‹•è½‰æ›å¤±æ•—: {error_msg}', 'error')
        # ç™¼é€éŒ¯èª¤äº‹ä»¶åˆ°ä¸»åŸ·è¡Œç·’ (é‡å°è‡ªå‹•è½‰æ›å¤±æ•—)
        QCoreApplication.instance().postEvent(
            self,
            FfmpegErrorEvent(f'å½±ç‰‡è‡ªå‹•è½‰æ›å¤±æ•—ï¼š{error_msg}\nè«‹æª¢æŸ¥ FFmpeg å®‰è£å’ŒåŸå§‹å½±ç‰‡æª”æ¡ˆæ˜¯å¦æ­£ç¢ºã€‚')
        )
        if hasattr(self, 'convert_video_btn'):
            self.convert_video_btn.setEnabled(True) # é‡æ–°å•Ÿç”¨æŒ‰éˆ•

    def adjust_volume(self, value):
        """èª¿æ•´éŸ³é‡"""
        if self.media_player:
            self.media_player.audio_set_volume(value)
            self.log(f'éŸ³é‡èª¿æ•´ç‚º: {value}%', 'debug')

    def change_speed(self, speed):
        """æ”¹è®Šæ’­æ”¾é€Ÿåº¦"""
        if self.media_player:
            try:
                speed_value = float(speed.replace('x', ''))
                self.media_player.set_rate(speed_value)
                self.log(f'æ’­æ”¾é€Ÿåº¦èª¿æ•´ç‚º: {speed}', 'debug')
            except Exception as e:
                self.log(f'èª¿æ•´æ’­æ”¾é€Ÿåº¦å¤±æ•—: {e}', 'error')

    def browse_subtitle(self):
        """é¸æ“‡å­—å¹•æª”æ¡ˆ"""
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            'é¸æ“‡å­—å¹•æª”æ¡ˆ',
            '',
            'å­—å¹•æª”æ¡ˆ (*.srt);;æ‰€æœ‰æª”æ¡ˆ (*.*)'
        )
        if file_path:
            self.subtitle_path_input.setText(file_path)
            self.log(f'å·²é¸æ“‡å­—å¹•æª”æ¡ˆ: {file_path}', 'debug')

    def browse_watermark(self):
        """é¸æ“‡æµ®æ°´å°åœ–ç‰‡"""
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            'é¸æ“‡æµ®æ°´å°åœ–ç‰‡',
            '',
            'åœ–ç‰‡æª”æ¡ˆ (*.png *.jpg *.jpeg);;æ‰€æœ‰æª”æ¡ˆ (*.*)'
        )
        if file_path:
            self.watermark_path_input.setText(file_path)
            self.log(f'å·²é¸æ“‡æµ®æ°´å°åœ–ç‰‡: {file_path}', 'debug')

    def add_merge_video(self):
        """æ·»åŠ è¦åˆä½µçš„å½±ç‰‡"""
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            'é¸æ“‡è¦åˆä½µçš„å½±ç‰‡',
            '',
            'å½±ç‰‡æª”æ¡ˆ (*.mp4 *.avi *.mkv *.mov);;æ‰€æœ‰æª”æ¡ˆ (*.*)'
        )
        if file_path:
            self.merge_list.addItem(file_path)
            self.log(f'å·²æ·»åŠ åˆä½µå½±ç‰‡: {file_path}', 'debug')

    def process_video(self):
        """è™•ç†å½±ç‰‡"""
        if not self.video_path_input.text():
            QMessageBox.warning(self, 'è­¦å‘Š', 'è«‹å…ˆé¸æ“‡è¦è™•ç†çš„å½±ç‰‡')
            return

        output_format = self.format_combo.currentText().lower()
        
        # æª¢æŸ¥è£å‰ªåƒæ•¸ï¼ˆåƒ…åœ¨ MP4 æ ¼å¼æ™‚æª¢æŸ¥ï¼‰
        if output_format != 'mp3':
            crop_params = self.crop_input.text().strip()
            if crop_params and not self.validate_crop_params(crop_params):
                QMessageBox.warning(self, 'è­¦å‘Š', 'è£å‰ªåƒæ•¸æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨ å¯¬:é«˜:x:y æ ¼å¼')
                return

        # æª¢æŸ¥æ™‚é–“åƒæ•¸
        start_time = self.parse_time(self.trim_start.text()) if self.trim_start.text() else 0
        end_time = self.parse_time(self.trim_end.text()) if self.trim_end.text() else float('inf')
        
        if start_time is None or end_time is None:
            QMessageBox.warning(self, 'è­¦å‘Š', 'æ™‚é–“æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨ HH:MM:SS æˆ– HH:MM:SS.mmm æ ¼å¼')
            return
        if end_time <= start_time:
            QMessageBox.warning(self, 'è­¦å‘Š', 'çµæŸæ™‚é–“å¿…é ˆå¤§æ–¼é–‹å§‹æ™‚é–“')
            return

        # æª¢æŸ¥æ˜¯å¦æœ‰è¦åˆä½µçš„å½±ç‰‡
        merge_videos = []
        for i in range(self.merge_list.count()):
            merge_videos.append(self.merge_list.item(i).text())

        # å¦‚æœæœ‰è¦åˆä½µçš„å½±ç‰‡ï¼Œå…ˆå‰µå»ºè‡¨æ™‚æª”æ¡ˆåˆ—è¡¨
        if merge_videos:
            temp_dir = os.path.join(get_base_path(), 'temp')
            os.makedirs(temp_dir, exist_ok=True)
            temp_list_path = os.path.join(temp_dir, f'merge_list_{int(time.time())}.txt')
            
            try:
                # æº–å‚™æª”æ¡ˆå…§å®¹
                file_content = []
                # æ·»åŠ ä¸»å½±ç‰‡
                main_video = os.path.abspath(self.video_path_input.text().strip())
                file_content.append(f"file '{main_video}'")
                # æ·»åŠ å…¶ä»–å½±ç‰‡
                for video in merge_videos:
                    abs_path = os.path.abspath(video)
                    file_content.append(f"file '{abs_path}'")

                # å¯«å…¥æª”æ¡ˆ
                with open(temp_list_path, 'w', encoding='utf-8') as f:
                    f.write('\n'.join(file_content))

                # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
                if not os.path.exists(temp_list_path):
                    raise Exception(f'ç„¡æ³•å‰µå»ºåˆä½µåˆ—è¡¨æª”æ¡ˆ: {temp_list_path}')

                # æ§‹å»º FFmpeg å‘½ä»¤
                ffmpeg_cmd = [
                    get_ffmpeg_path(), '-y',
                    '-f', 'concat',
                    '-safe', '0',
                    '-i', temp_list_path,
                    '-c', 'copy'  # ä½¿ç”¨å¿«é€Ÿè¤‡è£½æ¨¡å¼ï¼Œä¸é‡æ–°ç·¨ç¢¼
                ]

                # æ·»åŠ æ™‚é–“è£å‰ªåƒæ•¸ï¼ˆåªæœ‰åœ¨æœ‰è¨­å®šæ™‚é–“æ™‚æ‰æ·»åŠ ï¼‰
                if start_time > 0 or end_time < float('inf'):
                    # å¦‚æœåªéœ€è¦è£å‰ªæ™‚é–“ï¼Œä½¿ç”¨ -ss å’Œ -t åƒæ•¸
                    if start_time > 0:
                        ffmpeg_cmd.extend(['-ss', str(start_time)])
                    if end_time < float('inf'):
                        duration = end_time - start_time
                        ffmpeg_cmd.extend(['-t', str(duration)])
                else:
                    # å¦‚æœä¸éœ€è¦è£å‰ªæ™‚é–“ï¼Œç›´æ¥ä½¿ç”¨å¿«é€Ÿè¤‡è£½æ¨¡å¼
                    ffmpeg_cmd.extend(['-c', 'copy'])

                # è¨­å®šè¼¸å‡ºæª”æ¡ˆ
                suggested_output_path = os.path.splitext(self.video_path_input.text())[0] + '_merged.mp4'
                output_path, _ = QFileDialog.getSaveFileName(
                    self,
                    'å„²å­˜åˆä½µå¾Œçš„å½±ç‰‡',
                    suggested_output_path,
                    'MP4 å½±ç‰‡æª”æ¡ˆ (*.mp4);;æ‰€æœ‰æª”æ¡ˆ (*.*)'
                )
                
                if not output_path:
                    self.log('å–æ¶ˆå½±ç‰‡è™•ç†', 'debug')
                    return

                ffmpeg_cmd.append(output_path)

                self.log(f'é–‹å§‹åˆä½µå½±ç‰‡...', 'info')
                self.log(f'åˆä½µåˆ—è¡¨æª”æ¡ˆ: {temp_list_path}', 'debug')
                self.log(f'åŸ·è¡Œå‘½ä»¤: {" ".join(ffmpeg_cmd)}', 'debug')

                def on_complete(path):
                    # åœ¨è™•ç†å®Œæˆå¾Œæ¸…ç†è‡¨æ™‚æª”æ¡ˆ
                    try:
                        if os.path.exists(temp_list_path):
                            os.remove(temp_list_path)
                    except:
                        pass
                    self.on_process_complete(path)

                def on_error(msg):
                    # åœ¨è™•ç†å¤±æ•—å¾Œæ¸…ç†è‡¨æ™‚æª”æ¡ˆ
                    try:
                        if os.path.exists(temp_list_path):
                            os.remove(temp_list_path)
                    except:
                        pass
                    self.on_process_error(msg)

                # åŸ·è¡Œ FFmpeg å‘½ä»¤
                threading.Thread(
                    target=run_ffmpeg_command,
                    args=(ffmpeg_cmd, self.log, on_complete, on_error),
                    daemon=True
                ).start()

            except Exception as e:
                error_msg = f'å‰µå»ºåˆä½µåˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}'
                self.log(error_msg, 'error')
                QMessageBox.critical(self, 'éŒ¯èª¤', error_msg)
                # æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
                try:
                    if os.path.exists(temp_list_path):
                        os.remove(temp_list_path)
                except:
                    pass

            return

        # å¦‚æœæ²’æœ‰è¦åˆä½µçš„å½±ç‰‡ï¼ŒåŸ·è¡Œä¸€èˆ¬çš„è™•ç†é‚è¼¯
        ffmpeg_cmd = [
            get_ffmpeg_path(), '-y',
            '-i', self.video_path_input.text().strip()
        ]

        # æ·»åŠ æ™‚é–“è£å‰ªåƒæ•¸ï¼ˆåªæœ‰åœ¨æœ‰è¨­å®šæ™‚é–“æ™‚æ‰æ·»åŠ ï¼‰
        if start_time > 0 or end_time < float('inf'):
            ffmpeg_cmd.extend(['-ss', str(start_time)])
            if end_time < float('inf'):
                duration = end_time - start_time
                ffmpeg_cmd.extend(['-t', str(duration)])

        if output_format == 'mp3':
            # å¦‚æœæ˜¯ MP3 æ ¼å¼ï¼Œåªè™•ç†éŸ³è¨Š
            # è™•ç†éŸ³è¨Š
            if self.bgm_path_input.text():
                ffmpeg_cmd.extend(['-i', self.bgm_path_input.text().strip()])
                ffmpeg_cmd.extend([
                    '-filter_complex',
                    '[0:a][1:a]amix=inputs=2:duration=first:dropout_transition=2[aout]',
                    '-map', '[aout]'
                ])
            else:
                ffmpeg_cmd.extend(['-map', '0:a'])
            
            # è¨­å®š MP3 ç·¨ç¢¼å™¨
            ffmpeg_cmd.extend(['-c:a', 'libmp3lame', '-q:a', '2'])
            
            # è¨­å®šè¼¸å‡ºæª”æ¡ˆ
            suggested_output_path = os.path.splitext(self.video_path_input.text())[0] + '_processed.mp3'
            output_path, _ = QFileDialog.getSaveFileName(
                self,
                'å„²å­˜è™•ç†å¾Œçš„éŸ³è¨Š',
                suggested_output_path,
                'MP3 éŸ³è¨Šæª”æ¡ˆ (*.mp3);;æ‰€æœ‰æª”æ¡ˆ (*.*)'
            )
            
            if not output_path:
                self.log('å–æ¶ˆå½±ç‰‡è™•ç†', 'debug')
                return
        else:
            # æº–å‚™ filter_complex å‘½ä»¤
            filter_complex = []
            video_filters = []
            audio_filters = []

            # æ·»åŠ è£å‰ªåƒæ•¸
            if crop_params:
                video_filters.append(f'crop={crop_params}')

            # æ·»åŠ è§£æåº¦åƒæ•¸
            if self.resolution_combo.currentText() != 'åŸå§‹':
                video_filters.append(f'scale={self.resolution_combo.currentText()}')

            # è™•ç†æµ®æ°´å°
            if self.watermark_path_input.text().strip():
                ffmpeg_cmd.extend(['-i', self.watermark_path_input.text().strip()])
                video_filters.append('[0:v][1:v]overlay=10:10[outv]')
                ffmpeg_cmd.extend(['-map', '[outv]'])
            else:
                ffmpeg_cmd.extend(['-map', '0:v'])

            # è™•ç†éŸ³è¨Š
            if self.bgm_path_input.text():
                ffmpeg_cmd.extend(['-i', self.bgm_path_input.text().strip()])
                audio_filters.append('[0:a][1:a]amix=inputs=2:duration=first:dropout_transition=2[aout]')
                ffmpeg_cmd.extend(['-map', '[aout]'])
            else:
                ffmpeg_cmd.extend(['-map', '0:a'])

            # çµ„åˆæ‰€æœ‰ filter_complex å‘½ä»¤
            if video_filters or audio_filters:
                filter_complex.extend(video_filters)
                filter_complex.extend(audio_filters)
                ffmpeg_cmd.extend(['-filter_complex', ';'.join(filter_complex)])

            # è¨­å®šç·¨ç¢¼å™¨
            if not video_filters and not audio_filters:
                ffmpeg_cmd.extend(['-c:v', 'copy', '-c:a', 'copy'])
            else:
                ffmpeg_cmd.extend(['-c:v', 'libx264', '-c:a', 'aac'])
            
            # è¨­å®šè¼¸å‡ºæª”æ¡ˆ
            suggested_output_path = os.path.splitext(self.video_path_input.text())[0] + '_processed.mp4'
            output_path, _ = QFileDialog.getSaveFileName(
                self,
                'å„²å­˜è™•ç†å¾Œçš„å½±ç‰‡',
                suggested_output_path,
                'MP4 å½±ç‰‡æª”æ¡ˆ (*.mp4);;æ‰€æœ‰æª”æ¡ˆ (*.*)'
            )
            
            if not output_path:
                self.log('å–æ¶ˆå½±ç‰‡è™•ç†', 'debug')
                return
        
        ffmpeg_cmd.append(output_path)

        # åŸ·è¡Œ FFmpeg å‘½ä»¤
        threading.Thread(
            target=run_ffmpeg_command,
            args=(ffmpeg_cmd, self.log, lambda path: self.on_process_complete(path), self.on_process_error),
            daemon=True
        ).start()

    def validate_crop_params(self, crop_params):
        """é©—è­‰ç©ºé–“è£å‰ªåƒæ•¸"""
        try:
            w, h, x, y = map(int, crop_params.split(':'))
            if w <= 0 or h <= 0 or x < 0 or y < 0:
                return False
            return True
        except:
            return False

    def escape_path(self, path):
        """è½‰ç¾©è·¯å¾‘ä¸­çš„ç‰¹æ®Šå­—ç¬¦"""
        return path.replace("'", "'\\''")

    def cleanup_temp_files(self):
        """æ¸…ç†è‡¨æ™‚æ–‡ä»¶"""
        try:
            if hasattr(self, 'temp_list_path') and os.path.exists(self.temp_list_path):
                os.remove(self.temp_list_path)
        except Exception as e:
            self.log(f'æ¸…ç†è‡¨æ™‚æ–‡ä»¶å¤±æ•—: {e}', 'error')

    def on_process_complete(self, output_path):
        """å½±ç‰‡è™•ç†å®Œæˆå¾Œçš„å›èª¿"""
        self.log('å½±ç‰‡è™•ç†å®Œæˆï¼', 'info')
        # æ¸…ç†è‡¨æ™‚æ–‡ä»¶
        self.cleanup_temp_files()
        # ç™¼é€è™•ç†å®Œæˆäº‹ä»¶åˆ°ä¸»åŸ·è¡Œç·’
        QCoreApplication.instance().postEvent(
            self,
            FfmpegCompleteEvent(output_path)
        )

    def on_process_error(self, error_msg):
        """å½±ç‰‡è™•ç†å¤±æ•—å¾Œçš„å›èª¿"""
        self.log(f'å½±ç‰‡è™•ç†å¤±æ•—: {error_msg}', 'error')
        # ç™¼é€è™•ç†éŒ¯èª¤äº‹ä»¶åˆ°ä¸»åŸ·è¡Œç·’
        QCoreApplication.instance().postEvent(
            self,
            FfmpegErrorEvent(f'å½±ç‰‡è™•ç†å¤±æ•—ï¼š{error_msg}\nè«‹æª¢æŸ¥ FFmpeg å®‰è£å’Œæª”æ¡ˆæ˜¯å¦æ­£ç¢ºã€‚')
        )

    def browse_background_music(self):
        """é¸æ“‡èƒŒæ™¯éŸ³æ¨‚æª”æ¡ˆ"""
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            'é¸æ“‡èƒŒæ™¯éŸ³æ¨‚æª”æ¡ˆ',
            '',
            'éŸ³è¨Šæª”æ¡ˆ (*.mp3 *.wav *.aac);;æ‰€æœ‰æª”æ¡ˆ (*.*)'
        )
        if file_path:
            self.bgm_path_input.setText(file_path)
            self.log(f'å·²é¸æ“‡èƒŒæ™¯éŸ³æ¨‚æª”æ¡ˆ: {file_path}', 'debug')

    def customEvent(self, event):
        """è™•ç†è‡ªå®šç¾©äº‹ä»¶"""
        if event.type() == FfmpegCompleteEvent.EVENT_TYPE:
            # FFmpeg å®Œæˆäº‹ä»¶
            # ä½¿ç”¨ QTimer.singleShot å»¶é²é¡¯ç¤ºè¨Šæ¯æ¡†
            QTimer.singleShot(100, lambda: self.show_complete_message(event.output_path))
            # é‡æ–°å•Ÿç”¨è½‰æ›å’Œè™•ç†æŒ‰éˆ•
            if hasattr(self, 'convert_video_btn'):
                self.convert_video_btn.setEnabled(True)
            if hasattr(self, 'process_btn'):
                self.process_btn.setEnabled(True)
        elif event.type() == FfmpegErrorEvent.EVENT_TYPE:
            # é—œé–‰å­—å¹•åµŒå…¥ç›¸é—œçš„å°è©±æ¡†
            if hasattr(self, 'embed_progress_dialog') and self.embed_progress_dialog:
                self.embed_progress_dialog.close()
                self.embed_progress_dialog = None
            
            # é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            QTimer.singleShot(100, lambda: self.show_error_message(event.error_msg))
            
            # é‡æ–°å•Ÿç”¨æŒ‰éˆ•
            if hasattr(self, 'convert_video_btn'):
                self.convert_video_btn.setEnabled(True)
            if hasattr(self, 'process_btn'):
                self.process_btn.setEnabled(True)
            # FFmpeg éŒ¯èª¤äº‹ä»¶
            # ä½¿ç”¨ QTimer.singleShot å»¶é²é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯æ¡†
            QTimer.singleShot(100, lambda: self.show_error_message(event.error_msg))
            # é‡æ–°å•Ÿç”¨è½‰æ›å’Œè™•ç†æŒ‰éˆ•
            if hasattr(self, 'convert_video_btn'):
                self.convert_video_btn.setEnabled(True)
            if hasattr(self, 'process_btn'):
                self.process_btn.setEnabled(True)
        elif event.type() == LoadConvertedVideoEvent.EVENT_TYPE:
            # è‡ªå‹•è½‰æ›å®Œæˆï¼Œè¼‰å…¥å½±ç‰‡äº‹ä»¶
            self.log(f'è¼‰å…¥è‡ªå‹•è½‰æ›å¾Œçš„å½±ç‰‡: {event.file_path}', 'debug')
            if self.media_player:
                try:
                    # åœæ­¢ç•¶å‰æ’­æ”¾
                    self.media_player.stop()
                    # å‰µå»ºæ–°çš„åª’é«”å°è±¡
                    media = self.vlc_instance.media_new(event.file_path)
                    self.media_player.set_media(media)
                    # è¨­ç½®è¦–çª—å¥æŸ„
                    if sys.platform.startswith('win'):
                        self.media_player.set_hwnd(self.video_surface.winId())
                    elif sys.platform.startswith('linux'):
                        self.media_player.set_xid(self.video_surface.winId())
                    elif sys.platform.startswith('darwin'):
                        self.media_player.set_nsobject(int(self.video_surface.winId()))
                    
                    # å•Ÿç”¨æ’­æ”¾æ§åˆ¶å…ƒä»¶
                    self.play_pause_btn.setEnabled(True)
                    self.progress_slider.setEnabled(True)
                    
                    # é–‹å§‹æ’­æ”¾
                    self.media_player.play()
                    self.play_pause_btn.setText('æš«åœ')
                    
                    # æ›´æ–°å½±ç‰‡è·¯å¾‘è¼¸å…¥æ¡† (ä½¿ç”¨è‡¨æ™‚æª”æ¡ˆè·¯å¾‘)
                    self.video_path_input.setText(event.file_path)

                    self.log(f'æˆåŠŸè¼‰å…¥è½‰æ›å¾Œçš„å½±ç‰‡: {event.file_path}', 'debug')
                    # æ’­æ”¾æˆåŠŸï¼Œå•Ÿç”¨è½‰æ›å½±ç‰‡æŒ‰éˆ•
                    if hasattr(self, 'convert_video_btn'):
                        self.log('å½±ç‰‡è¼‰å…¥æˆåŠŸï¼Œå•Ÿç”¨è½‰æ›å½±ç‰‡æŒ‰éˆ•', 'debug')
                        self.convert_video_btn.setEnabled(True)

                except Exception as e:
                    error_msg = f'è¼‰å…¥è½‰æ›å¾Œçš„å½±ç‰‡åˆ° VLC æ’­æ”¾å™¨å¤±æ•—: {str(e)}\n\nå»ºè­°ï¼š\n1. ç¢ºèªå½±ç‰‡æ ¼å¼æ˜¯å¦æ”¯æ´\n2. æª¢æŸ¥ VLC è§£ç¢¼å™¨æ˜¯å¦å®Œæ•´\n3. å˜—è©¦ä½¿ç”¨å…¶ä»–å½±ç‰‡æª”æ¡ˆ'
                    self.log(error_msg, 'error')
                    QMessageBox.critical(self, 'æ’­æ”¾éŒ¯èª¤', error_msg)
            else:
                # å¦‚æœ media_player æ˜¯ Noneï¼Œèªªæ˜ VLC æœªæº–å‚™å¥½ï¼Œå½ˆå‡ºè­¦å‘Šæ¡†
                QMessageBox.warning(self, 'éŒ¯èª¤', 'VLC æ’­æ”¾å™¨æœªæº–å‚™å¥½ï¼Œç„¡æ³•è¼‰å…¥å½±ç‰‡ã€‚\nè«‹ç¢ºèª VLC æ ¸å¿ƒæª”æ¡ˆå·²æ­£ç¢ºæ”¾ç½®ã€‚')
                self.log('VLC æ’­æ”¾å™¨æœªæº–å‚™å¥½ï¼Œç„¡æ³•è¼‰å…¥å½±ç‰‡ã€‚', 'error')
        elif event.type() == ScreenshotCompleteEvent.EVENT_TYPE:
            QMessageBox.information(self, 'æ“ä½œå®Œæˆ', f'æˆªåœ–å·²æˆåŠŸå„²å­˜è‡³ï¼š{event.output_path}')
            self.log(f'æˆªåœ–å·²å„²å­˜è‡³ï¼š{event.output_path}', 'info')
        elif event.type() == ScreenshotErrorEvent.EVENT_TYPE:
            QMessageBox.critical(self, 'æ“ä½œå¤±æ•—', f'æˆªåœ–å¤±æ•—ï¼š{event.error_msg}')
            self.log(f'æˆªåœ–å¤±æ•—ï¼š{event.error_msg}', 'error')
        elif event.type() == AudioExtractCompleteEvent.EVENT_TYPE:
            QMessageBox.information(self, 'æ“ä½œå®Œæˆ', f'éŸ³è¨Šå·²æˆåŠŸæå–ï¼Œæª”æ¡ˆå·²å„²å­˜è‡³ï¼š{event.output_path}')
            self.log(f'éŸ³è¨Šå·²æå–ï¼Œæª”æ¡ˆå·²å„²å­˜è‡³ï¼š{event.output_path}', 'info')
        elif event.type() == AudioExtractErrorEvent.EVENT_TYPE:
            QMessageBox.critical(self, 'æ“ä½œå¤±æ•—', f'æå–éŸ³è¨Šå¤±æ•—ï¼š{event.error_msg}')
            self.log(f'æå–éŸ³è¨Šå¤±æ•—ï¼š{event.error_msg}', 'error')
        else:
            super().customEvent(event)

    def show_complete_message(self, output_path):
        """é¡¯ç¤ºå®Œæˆè¨Šæ¯"""
        QMessageBox.information(self, 'æ“ä½œå®Œæˆ', f'å½±ç‰‡å·²æˆåŠŸè™•ç†ä¸¦å„²å­˜è‡³ï¼š{output_path}')

    def show_error_message(self, error_msg):
        """é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯"""
        QMessageBox.critical(self, 'æ“ä½œå¤±æ•—', error_msg)

    def set_start_time(self):
        """è¨­å®šé–‹å§‹æ™‚é–“"""
        if self.media_player and self.media_player.is_playing():
            current_time = self.media_player.get_time() / 1000  # è½‰æ›ç‚ºç§’
            self.trim_start.setText(self.format_time(current_time * 1000))
            self.log(f'è¨­å®šé–‹å§‹æ™‚é–“: {self.trim_start.text()}', 'info')

    def set_end_time(self):
        """è¨­å®šçµæŸæ™‚é–“"""
        if self.media_player and self.media_player.is_playing():
            current_time = self.media_player.get_time() / 1000  # è½‰æ›ç‚ºç§’
            self.trim_end.setText(self.format_time(current_time * 1000))
            self.log(f'è¨­å®šçµæŸæ™‚é–“: {self.trim_end.text()}', 'info')

    def toggle_time_input_mode(self):
        """åˆ‡æ›æ™‚é–“è¼¸å…¥æ¨¡å¼"""
        self.is_manual_time_input = not self.is_manual_time_input
        if self.is_manual_time_input:
            self.time_input_mode_btn.setText("åˆ‡æ›ç‚ºæ’­æ”¾å™¨é¸æ“‡")
            self.trim_start.setReadOnly(False)
            self.trim_end.setReadOnly(False)
            self.set_start_time_btn.setEnabled(False)
            self.set_end_time_btn.setEnabled(False)
            self.log('å·²åˆ‡æ›ç‚ºæ‰‹å‹•è¼¸å…¥æ¨¡å¼', 'info')
        else:
            self.time_input_mode_btn.setText("åˆ‡æ›ç‚ºæ‰‹å‹•è¼¸å…¥")
            self.trim_start.setReadOnly(True)
            self.trim_end.setReadOnly(True)
            self.set_start_time_btn.setEnabled(True)
            self.set_end_time_btn.setEnabled(True)
            self.log('å·²åˆ‡æ›ç‚ºæ’­æ”¾å™¨é¸æ“‡æ¨¡å¼', 'info')

    def extract_audio(self):
        """åªä¿ç•™è²éŸ³ï¼Œç§»é™¤å½±ç‰‡"""
        input_path = self.video_path_input.text().strip()
        if not input_path or not os.path.exists(input_path):
            QMessageBox.warning(self, 'éŒ¯èª¤', 'è«‹å…ˆé¸æ“‡è¦è™•ç†çš„å½±ç‰‡æª”æ¡ˆï¼')
            return

        # ç²å–è¼¸å‡ºæª”æ¡ˆè·¯å¾‘
        output_path, _ = QFileDialog.getSaveFileName(
            self,
            'å„²å­˜éŸ³è¨Šæª”æ¡ˆ',
            os.path.splitext(input_path)[0] + '.mp3',
            'MP3 éŸ³è¨Šæª”æ¡ˆ (*.mp3);;æ‰€æœ‰æª”æ¡ˆ (*.*)'
        )
        if not output_path:
            return

        # æ§‹å»º FFmpeg å‘½ä»¤
        ffmpeg_cmd = [
            get_ffmpeg_path(),
            '-y',
            '-i', input_path,
            '-vn',  # ç§»é™¤è¦–è¨Šæµ
            '-c:a', 'libmp3lame',  # ä½¿ç”¨ MP3 ç·¨ç¢¼å™¨
            '-q:a', '0',  # æœ€é«˜éŸ³è³ª
            output_path
        ]

        self.log(f'é–‹å§‹æå–éŸ³è¨Š...', 'info')
        self.log(f'åŸ·è¡Œå‘½ä»¤: {" ".join(ffmpeg_cmd)}', 'debug')

        # åœ¨æ–°åŸ·è¡Œç·’ä¸­åŸ·è¡Œè™•ç†
        threading.Thread(
            target=run_ffmpeg_command,
            args=(
                ffmpeg_cmd,
                self.log,
                lambda path: QApplication.postEvent(self, AudioExtractCompleteEvent(path)),
                lambda msg: QApplication.postEvent(self, AudioExtractErrorEvent(msg))
            ),
            daemon=True
        ).start()

    def take_screenshot(self):
        """æ“·å–å½±ç‰‡ç•¶å‰ç•«é¢çš„æˆªåœ–"""
        if not self.media_player:
            QMessageBox.warning(self, 'éŒ¯èª¤', 'è«‹å…ˆè¼‰å…¥å½±ç‰‡ï¼')
            return

        # å…ˆæ“·å–åˆ°è‡¨æ™‚æª”æ¡ˆ
        temp_dir = os.path.join(get_base_path(), 'temp')
        os.makedirs(temp_dir, exist_ok=True)
        temp_path = os.path.join(temp_dir, f'screenshot_{int(time.time())}.png')

        try:
            # ä½¿ç”¨ VLC çš„å…§å»ºæˆªåœ–åŠŸèƒ½ç«‹å³æ“·å–ç•¶å‰ç•«é¢
            if self.media_player.video_take_snapshot(0, temp_path, 0, 0) != 0:
                error_msg = 'æˆªåœ–å¤±æ•—'
                self.log(error_msg, 'error')
                QMessageBox.critical(self, 'éŒ¯èª¤', error_msg)
                return

            # è®“ç”¨æˆ¶é¸æ“‡å„²å­˜ä½ç½®
            output_path, _ = QFileDialog.getSaveFileName(
                self,
                'å„²å­˜æˆªåœ–',
                os.path.join(self.download_folder, 'screenshot.png'),
                'PNG åœ–ç‰‡æª”æ¡ˆ (*.png);;JPEG åœ–ç‰‡æª”æ¡ˆ (*.jpg);;æ‰€æœ‰æª”æ¡ˆ (*.*)'
            )

            if output_path:
                # è¤‡è£½è‡¨æ™‚æª”æ¡ˆåˆ°ç”¨æˆ¶é¸æ“‡çš„ä½ç½®
                shutil.copy2(temp_path, output_path)
                self.log(f'æˆªåœ–å·²å„²å­˜è‡³: {output_path}', 'info')
                QMessageBox.information(self, 'æˆåŠŸ', f'æˆªåœ–å·²å„²å­˜è‡³:\n{output_path}')
            
            # æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
            try:
                os.remove(temp_path)
            except:
                pass

        except Exception as e:
            error_msg = f'æˆªåœ–æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}'
            self.log(error_msg, 'error')
            QMessageBox.critical(self, 'éŒ¯èª¤', error_msg)
            # ç¢ºä¿æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
            try:
                os.remove(temp_path)
            except:
                pass

    def run_ytdlp_command(self, cmd):
        """åŸ·è¡Œ yt-dlp å‘½ä»¤"""
        try:
            process = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                universal_newlines=True
            )

            # è®€å–è¼¸å‡º
            while True:
                output = process.stdout.readline()
                if output == '' and process.poll() is not None:
                    break
                if output:
                    self.log(output.strip(), 'info')

            # æª¢æŸ¥æ˜¯å¦æˆåŠŸ
            if process.returncode == 0:
                QMessageBox.information(self, 'æ“ä½œå®Œæˆ', 'éŸ³è¨Šä¸‹è¼‰å®Œæˆï¼')
            else:
                error = process.stderr.read()
                QMessageBox.critical(self, 'æ“ä½œå¤±æ•—', f'ä¸‹è¼‰å¤±æ•—ï¼š{error}')
                self.log(f'ä¸‹è¼‰å¤±æ•—ï¼š{error}', 'error')

        except Exception as e:
            QMessageBox.critical(self, 'æ“ä½œå¤±æ•—', f'åŸ·è¡Œå‘½ä»¤æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}')
            self.log(f'åŸ·è¡Œå‘½ä»¤æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}', 'error')

    def on_format_changed(self, format_text):
        """ç•¶è¼¸å‡ºæ ¼å¼æ”¹è®Šæ™‚ï¼Œæ›´æ–°ç›¸é—œæ§åˆ¶é …çš„ç‹€æ…‹"""
        is_mp3 = format_text.lower() == 'mp3'
        
        # ç¦ç”¨/å•Ÿç”¨å½±ç‰‡ç›¸é—œæ§åˆ¶é …
        self.resolution_combo.setEnabled(not is_mp3)
        self.crop_input.setEnabled(not is_mp3)
        self.watermark_path_input.setEnabled(not is_mp3)
        if hasattr(self, 'browse_watermark_btn'):
            self.browse_watermark_btn.setEnabled(not is_mp3)
        
        # å¦‚æœåˆ‡æ›åˆ° MP3 æ ¼å¼ï¼Œæ¸…ç©ºå½±ç‰‡ç›¸é—œè¨­å®š
        if is_mp3:
            self.resolution_combo.setCurrentText('åŸå§‹')
            self.crop_input.clear()
            self.watermark_path_input.clear()

    def toggle_titlebar(self):
        """åˆ‡æ›æ¨™é¡Œåˆ—é¡¯ç¤º/éš±è—ï¼ˆç„¡é‚Šæ¡†æ¨¡å¼ï¼‰"""
        if self.hide_titlebar_action.isChecked():
            # éš±è—æ¨™é¡Œåˆ—ï¼ˆç„¡é‚Šæ¡†ï¼‰
            self.setWindowFlag(Qt.FramelessWindowHint, True)
        else:
            # é¡¯ç¤ºæ¨™é¡Œåˆ—
            self.setWindowFlag(Qt.FramelessWindowHint, False)
        self.show()  # é‡æ–°é¡¯ç¤ºè¦–çª—ä»¥å¥—ç”¨è®Šæ›´

    def toggle_header(self):
        """åˆ‡æ› LOGO+æ¨™é¡Œå€å¡Šé¡¯ç¤º/éš±è—"""
        self.header.setVisible(not self.hide_header_action.isChecked())

    def toggle_optimize_space(self):
        """åˆ‡æ›ç©ºé–“å„ªåŒ–ï¼ˆåŒæ™‚éš±è—LOGO+æ¨™é¡Œå€å¡Šå’Œæ—¥èªŒå€ï¼‰"""
        hide = self.optimize_space_action.isChecked()
        self.header.setVisible(not hide)
        self.log_text.setVisible(not hide)

    def show_ai_subtitle_mode(self):
        """åˆ‡æ›åˆ° AI å­—å¹•æ¨¡å¼"""
        # æª¢æŸ¥æ˜¯å¦åœ¨å‰ªè¼¯æ¨¡å¼ä¸”æœ‰è¼‰å…¥å½±ç‰‡
        if not hasattr(self, 'current_video_path') or not self.current_video_path:
            # å¦‚æœä¸åœ¨å‰ªè¼¯æ¨¡å¼ï¼Œå…ˆåˆ‡æ›åˆ°å‰ªè¼¯æ¨¡å¼
            if not self.edit_mode_action.isChecked():
                self.edit_mode_action.setChecked(True)
                self.toggle_edit_mode()
            
            # æç¤ºç”¨æˆ¶é¸æ“‡å½±ç‰‡
            QMessageBox.information(self, 'æç¤º', 'è«‹å…ˆé¸æ“‡è¦è™•ç†çš„å½±ç‰‡')
            return
            
        # é¡¯ç¤º AI å­—å¹•è¨­å®š
        self.show_ai_subtitle_dialog()

    def show_ai_subtitle_dialog(self):
        """é¡¯ç¤º AI å­—å¹•è¨­å®šå°è©±æ¡†"""
        dialog = QDialog(self)
        dialog.setWindowTitle('AI å­—å¹•è¨­å®š')
        dialog.setMinimumWidth(400)
        
        # è¨­ç½®é»‘è‰²æ¨¡å¼æ¨£å¼
        dialog.setStyleSheet('''
            QDialog {
                background-color: #1a1a1a;
                color: #ffffff;
            }
            QLabel {
                color: #ffffff;
                font-size: 13px;
            }
            QComboBox {
                background-color: #2d2d2d;
                color: #ffffff;
                border: 1px solid #3d3d3d;
                border-radius: 4px;
                padding: 5px;
                min-width: 150px;
            }
            QComboBox:hover {
                border: 1px solid #4d4d4d;
            }
            QComboBox::drop-down {
                border: none;
            }
            QComboBox::down-arrow {
                image: none;
                border: none;
            }
            QPushButton {
                background-color: #2d2d2d;
                color: #ffffff;
                border: 1px solid #3d3d3d;
                border-radius: 4px;
                padding: 5px 15px;
            }
            QPushButton:hover {
                background-color: #3d3d3d;
                border: 1px solid #4d4d4d;
            }
            QPushButton:pressed {
                background-color: #4d4d4d;
            }
        ''')
        
        layout = QVBoxLayout()
        layout.setSpacing(15)
        layout.setContentsMargins(20, 20, 20, 20)
        
        # æ¨¡å‹å¤§å°é¸æ“‡
        model_layout = QHBoxLayout()
        model_label = QLabel('æ¨¡å‹å¤§å°:')
        model_combo = QComboBox()
        model_combo.addItems(['tiny', 'base', 'small', 'medium', 'large'])
        model_combo.setCurrentText('base')  # é è¨­ä½¿ç”¨ base æ¨¡å‹
        model_layout.addWidget(model_label)
        model_layout.addWidget(model_combo)
        layout.addLayout(model_layout)
        
        # èªè¨€é¸æ“‡
        lang_layout = QHBoxLayout()
        lang_label = QLabel('èªè¨€:')
        lang_combo = QComboBox()
        lang_combo.addItems(['zh', 'en', 'ja', 'ko'])
        lang_combo.setCurrentText('zh')  # é è¨­ä½¿ç”¨ä¸­æ–‡
        lang_layout.addWidget(lang_label)
        lang_layout.addWidget(lang_combo)
        layout.addLayout(lang_layout)
        
        # æŒ‰éˆ•
        button_box = QDialogButtonBox(QDialogButtonBox.Ok | QDialogButtonBox.Cancel)
        button_box.accepted.connect(dialog.accept)
        button_box.rejected.connect(dialog.reject)
        layout.addWidget(button_box)
        
        dialog.setLayout(layout)
        
        if dialog.exec_() == QDialog.Accepted:
            model_size = model_combo.currentText()
            language = lang_combo.currentText()
            self.generate_ai_subtitle(model_size, language)

    def generate_ai_subtitle(self, model_size: str, language: str):
        """ç”Ÿæˆ AI å­—å¹•"""
        if not hasattr(self, 'current_video_path') or not self.current_video_path:
            QMessageBox.warning(self, 'è­¦å‘Š', 'è«‹å…ˆè¼‰å…¥å½±ç‰‡')
            return
            
        try:
            # æª¢æŸ¥æ¨¡å‹æ˜¯å¦å­˜åœ¨
            model_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'models')
            if model_size == "base":
                model_name = "base.pt"
            else:
                model_name = f"ggml-{model_size}.bin"
            model_path = os.path.join(model_dir, model_name)
            
            if not os.path.exists(model_path):
                QMessageBox.warning(self, 'è­¦å‘Š', f'è«‹å…ˆä¸‹è¼‰ {model_size} æ¨¡å‹åˆ° models è³‡æ–™å¤¾')
                return
            
            # å»ºç«‹è¼¸å‡ºç›®éŒ„
            output_dir = os.path.join(os.path.dirname(self.current_video_path), 'subtitles')
            os.makedirs(output_dir, exist_ok=True)
            
            # è¨­å®šè¼¸å‡ºæª”æ¡ˆè·¯å¾‘
            output_file = os.path.join(output_dir, 
                f"{os.path.splitext(os.path.basename(self.current_video_path))[0]}.srt")
            
            # é¡¯ç¤ºé€²åº¦å°è©±æ¡†
            progress = QProgressDialog('æ­£åœ¨ç”Ÿæˆå­—å¹•...', 'å–æ¶ˆ', 0, 0, self)
            progress.setWindowModality(Qt.WindowModal)
            progress.setWindowTitle('AI å­—å¹•ç”Ÿæˆ')
            progress.setMinimumDuration(0)
            progress.setAutoClose(False)
            progress.setAutoReset(False)
            
            # è¨­å®šé€²åº¦å°è©±æ¡†æ¨£å¼
            progress.setStyleSheet("""
                QWidget {
                    background-color: #2b2b2b;
                    color: #ffffff;
                }
                QProgressDialog {
                    background-color: #2b2b2b;
                    color: #ffffff;
                    border: 1px solid #3c3c3c;
                    border-radius: 4px;
                }
                QLabel {
                    color: #ffffff;
                    padding: 10px;
                    font-size: 12px;
                }
                QProgressBar {
                    border: 1px solid #3c3c3c;
                    border-radius: 4px;
                    text-align: center;
                    background-color: #1e1e1e;
                    height: 20px;
                    margin: 10px;
                }
                QProgressBar::chunk {
                    background-color: #0078d4;
                    border-radius: 3px;
                }
                QPushButton {
                    background-color: #3c3c3c;
                    color: #ffffff;
                    border: 1px solid #555555;
                    border-radius: 4px;
                    padding: 5px 15px;
                    min-width: 80px;
                    margin: 5px;
                }
                QPushButton:hover {
                    background-color: #4c4c4c;
                }
                QPushButton:pressed {
                    background-color: #2c2c2c;
                }
            """)
            
            progress.show()
            
            class TranscriptionWorker(QThread):
                finished = pyqtSignal(str)  # æˆåŠŸæ™‚ç™¼é€è¼¸å‡ºæª”æ¡ˆè·¯å¾‘
                error = pyqtSignal(str)     # å¤±æ•—æ™‚ç™¼é€éŒ¯èª¤è¨Šæ¯
                
                def __init__(self, video_path, model_path, output_file, language):
                    super().__init__()
                    self.video_path = video_path
                    self.model_path = model_path
                    self.output_file = output_file
                    self.language = language
                    
                def run(self):
                    try:
                        import tempfile
                        import subprocess
                        import os
                        import whisper
                        from datetime import timedelta
                        import traceback
                        
                        def format_timestamp(seconds: float) -> str:
                            td = timedelta(seconds=seconds)
                            total_seconds = int(td.total_seconds())
                            hours = total_seconds // 3600
                            minutes = (total_seconds % 3600) // 60
                            secs = total_seconds % 60
                            milliseconds = int((seconds - int(seconds)) * 1000)
                            return f"{hours:02}:{minutes:02}:{secs:02},{milliseconds:03}"
                        
                        # æª¢æŸ¥è¼¸å…¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
                        if not os.path.exists(self.video_path):
                            raise Exception(f"æ‰¾ä¸åˆ°å½±ç‰‡æª”æ¡ˆï¼š{self.video_path}")
                        
                        if not os.path.exists(self.model_path):
                            raise Exception(f"æ‰¾ä¸åˆ°æ¨¡å‹æª”æ¡ˆï¼š{self.model_path}")
                        
                        # ç¢ºä¿è¼¸å‡ºç›®éŒ„å­˜åœ¨
                        output_dir = os.path.dirname(self.output_file)
                        os.makedirs(output_dir, exist_ok=True)
                        
                        # å…ˆç”¨ ffmpeg æŠ½éŸ³è¨Š
                        with tempfile.NamedTemporaryFile(suffix=".wav", delete=False) as tmp_wav:
                            tmp_wav_path = tmp_wav.name
                        
                        # ä½¿ç”¨ get_ffmpeg_path() å‡½æ•¸ç²å– ffmpeg è·¯å¾‘
                        ffmpeg_path = get_ffmpeg_path()
                        if not ffmpeg_path:
                            raise Exception("æ‰¾ä¸åˆ° ffmpegï¼Œè«‹ç¢ºä¿å·²æ­£ç¢ºå®‰è£")
                        
                        # æª¢æŸ¥ ffmpeg æ˜¯å¦å­˜åœ¨
                        if not os.path.exists(ffmpeg_path):
                            raise Exception(f"æ‰¾ä¸åˆ° ffmpeg åŸ·è¡Œæª”ï¼š{ffmpeg_path}")
                        
                        # è¨­å®šç’°å¢ƒè®Šæ•¸ï¼Œè®“ whisper ä¹Ÿèƒ½æ‰¾åˆ° ffmpeg
                        ffmpeg_dir = os.path.dirname(ffmpeg_path)
                        os.environ["PATH"] = ffmpeg_dir + os.pathsep + os.environ["PATH"]
                        
                        # ä½¿ç”¨æ›´ç©©å®šçš„ ffmpeg å‘½ä»¤
                        cmd = [
                            ffmpeg_path, "-y",
                            "-hwaccel", "auto",  # è‡ªå‹•é¸æ“‡ç¡¬é«”åŠ é€Ÿ
                            "-i", self.video_path,
                            "-vn",  # ä¸è™•ç†è¦–è¨Š
                            "-acodec", "pcm_s16le",  # ä½¿ç”¨ PCM ç·¨ç¢¼
                            "-ar", "16000",  # 16kHz æ¡æ¨£ç‡
                            "-ac", "1",  # å–®è²é“
                            "-f", "wav",  # å¼·åˆ¶ä½¿ç”¨ WAV æ ¼å¼
                            "-threads", "0",  # è‡ªå‹•é¸æ“‡åŸ·è¡Œç·’æ•¸
                            tmp_wav_path
                        ]
                        
                        # ä½¿ç”¨ subprocess.Popen æ›¿ä»£ subprocess.runï¼Œä»¥æ›´å¥½åœ°æ§åˆ¶åŸ·è¡Œç·’
                        process = subprocess.Popen(
                            cmd,
                            stdout=subprocess.PIPE,
                            stderr=subprocess.PIPE,
                            universal_newlines=True,
                            encoding='utf-8',
                            errors='replace',
                            bufsize=1
                        )
                        
                        stdout, stderr = process.communicate()

                        if process.returncode != 0:
                            raise Exception(f"FFmpeg åŸ·è¡Œå¤±æ•—ï¼š{stderr}")
                        
                        # æª¢æŸ¥è‡¨æ™‚æª”æ¡ˆæ˜¯å¦æˆåŠŸç”Ÿæˆ
                        if not os.path.exists(tmp_wav_path):
                            raise Exception("éŸ³è¨Šæª”æ¡ˆç”Ÿæˆå¤±æ•—")
                        
                        # è¼‰å…¥æ¨¡å‹
                        try:
                            # è¨­å®šæ¨¡å‹ç›®éŒ„
                            model_dir = os.path.dirname(self.model_path)
                            os.environ["WHISPER_MODEL_DIR"] = model_dir
                            
                            # è¼‰å…¥æ¨¡å‹
                            model = whisper.load_model("base")
                        except Exception as e:
                            error_msg = f"è¼‰å…¥æ¨¡å‹å¤±æ•—ï¼š{str(e)}\n{traceback.format_exc()}"
                            raise Exception(error_msg)
                        
                        # åŸ·è¡Œè½‰éŒ„
                        try:
                            result = model.transcribe(tmp_wav_path, language=self.language)
                        except Exception as e:
                            error_msg = f"è½‰éŒ„å¤±æ•—ï¼š{str(e)}\n{traceback.format_exc()}"
                            raise Exception(error_msg)
                        
                        # å¯«å…¥ SRT æª”æ¡ˆ
                        try:
                            with open(self.output_file, "w", encoding="utf-8") as f:
                                for idx, segment in enumerate(result["segments"], start=1):
                                    start_ts = format_timestamp(segment["start"])
                                    end_ts = format_timestamp(segment["end"])
                                    text = segment["text"].strip()
                                    f.write(f"{idx}\n{start_ts} --> {end_ts}\n{text}\n\n")
                        except Exception as e:
                            error_msg = f"å¯«å…¥å­—å¹•æª”æ¡ˆå¤±æ•—ï¼š{str(e)}\n{traceback.format_exc()}"
                            raise Exception(error_msg)
                        
                        self.finished.emit(self.output_file)
                    except Exception as e:
                        self.error.emit(str(e))
                    finally:
                        if 'tmp_wav_path' in locals() and os.path.exists(tmp_wav_path):
                            try:
                                os.remove(tmp_wav_path)
                            except:
                                pass
                        
            # å‰µå»ºä¸¦å•Ÿå‹•å·¥ä½œåŸ·è¡Œç·’
            self.transcription_worker = TranscriptionWorker(
                self.current_video_path,
                model_path,
                output_file,
                language
            )
            
            # é€£æ¥ä¿¡è™Ÿ
            self.transcription_worker.finished.connect(
                lambda path: self.on_transcription_complete(path, progress)
            )
            self.transcription_worker.error.connect(
                lambda msg: self.on_transcription_error(msg, progress)
            )
            
            # å•Ÿå‹•åŸ·è¡Œç·’
            self.transcription_worker.start()
            
        except Exception as e:
            QMessageBox.critical(self, 'éŒ¯èª¤', f'ç”Ÿæˆå­—å¹•æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}')

    def on_transcription_complete(self, output_file, progress):
        """å­—å¹•ç”Ÿæˆå®Œæˆçš„è™•ç†"""
        progress.close()
        
        try:
            # è®€å–SRTæª”æ¡ˆå…§å®¹
            with open(output_file, 'r', encoding='utf-8') as f:
                srt_content = f.read()
            
            # å‰µå»ºç·¨è¼¯å°è©±æ¡†
            dialog = QDialog(self)
            dialog.setWindowTitle('ç·¨è¼¯å­—å¹•')
            dialog.setMinimumSize(800, 600)
            
            # è¨­å®šå°è©±æ¡†æ¨£å¼
            dialog.setStyleSheet("""
                QDialog {
                    background-color: #2b2b2b;
                    color: #ffffff;
                }
                QTextEdit {
                    background-color: #1e1e1e;
                    color: #ffffff;
                    border: 1px solid #3c3c3c;
                    border-radius: 4px;
                    padding: 5px;
                }
                QPushButton {
                    background-color: #3c3c3c;
                    color: #ffffff;
                    border: 1px solid #555555;
                    border-radius: 4px;
                    padding: 5px 15px;
                    min-width: 80px;
                }
                QPushButton:hover {
                    background-color: #4c4c4c;
                }
                QPushButton:pressed {
                    background-color: #2c2c2c;
                }
            """)
            
            # å‰µå»ºç·¨è¼¯å€åŸŸ
            layout = QVBoxLayout()
            text_edit = QTextEdit()
            text_edit.setPlainText(srt_content)
            layout.addWidget(text_edit)
            
            # å­—é«”å’Œå¤§å°é¸æ“‡
            font_layout = QHBoxLayout()
            font_label = QLabel("å­—é«”:")
            font_combo = QFontComboBox()
            try:
                # å˜—è©¦è¨­å®šä¸€å€‹å¸¸è¦‹çš„ä¸­æ–‡å­—é«”ä½œç‚ºé è¨­
                default_font = QFont("Microsoft JhengHei")
                if default_font.family() in [f.family() for f in QFontDatabase().families()]:
                    font_combo.setCurrentFont(default_font)
                else:
                    font_combo.setCurrentFont(QFont("Arial")) # å¾Œå‚™å­—é«”
            except:
                pass # å¦‚æœå‡ºéŒ¯ï¼Œä½¿ç”¨é è¨­å­—é«”

            size_label = QLabel("å¤§å°:")
            size_spinbox = QSpinBox()
            size_spinbox.setRange(1, 128)
            size_spinbox.setValue(24)
            font_layout.addWidget(font_label)
            font_layout.addWidget(font_combo, 1)
            font_layout.addWidget(size_label)
            font_layout.addWidget(size_spinbox)
            font_layout.addStretch()
            layout.addLayout(font_layout)

            # å‰µå»ºæŒ‰éˆ•å€åŸŸ
            button_layout = QHBoxLayout()
            save_button = QPushButton('å®Œæˆ')
            cancel_button = QPushButton('å–æ¶ˆ')
            
            button_layout.addWidget(save_button)
            button_layout.addWidget(cancel_button)
            layout.addLayout(button_layout)
            
            dialog.setLayout(layout)
            
            # é€£æ¥æŒ‰éˆ•äº‹ä»¶
            def save_changes():
                try:
                    # å‰µå»ºé€²åº¦å°è©±æ¡†
                    progress = QProgressDialog('æ­£åœ¨åµŒå…¥å­—å¹•...', None, 0, 0, self)
                    progress.setWindowModality(Qt.WindowModal)
                    progress.setWindowTitle('è™•ç†ä¸­')
                    progress.setStyleSheet("""
                        QProgressDialog {
                            background-color: #2b2b2b;
                            color: #ffffff;
                        }
                        QLabel {
                            color: #ffffff;
                            padding: 10px;
                        }
                    """)
                    progress.show()

                    # ç”Ÿæˆè‡¨æ™‚å­—å¹•æª”æ¡ˆ
                    temp_srt = os.path.join(os.path.dirname(output_file), "temp_subtitle.srt")
                    with open(temp_srt, 'w', encoding='utf-8') as f:
                        f.write(text_edit.toPlainText())

                    # ç²å–å½±ç‰‡æª”æ¡ˆè·¯å¾‘
                    video_path = self.current_video_path
                    output_video = os.path.join(
                        os.path.dirname(video_path),
                        os.path.splitext(os.path.basename(video_path))[0] + "_subbed" + os.path.splitext(video_path)[1]
                    )

                    # ç¢ºä¿ subtitles è³‡æ–™å¤¾å­˜åœ¨
                    subtitles_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'subtitles')
                    os.makedirs(subtitles_dir, exist_ok=True)

                    # ç”Ÿæˆè‡¨æ™‚å­—å¹•æª”æ¡ˆè·¯å¾‘
                    temp_srt = os.path.join(subtitles_dir, 'temp_subtitle.srt')
                    
                    # ä¿å­˜å­—å¹•å…§å®¹åˆ°æª”æ¡ˆ
                    with open(temp_srt, 'w', encoding='utf-8') as f:
                        f.write(text_edit.toPlainText())

                    # ä½¿ç”¨ ffmpeg åµŒå…¥å­—å¹•
                    ffmpeg_path = get_ffmpeg_path()
                    if not ffmpeg_path:
                        raise Exception("æ‰¾ä¸åˆ° ffmpegï¼Œè«‹ç¢ºä¿å·²æ­£ç¢ºå®‰è£")

                    # è™•ç†è·¯å¾‘ä¸­çš„ç‰¹æ®Šå­—ç¬¦
                    def escape_path(path):
                        # å°‡è·¯å¾‘è½‰æ›ç‚ºçµ•å°è·¯å¾‘
                        abs_path = os.path.abspath(path)
                        # ä½¿ç”¨æ­£æ–œç·šæ›¿æ›åæ–œç·š
                        normalized_path = abs_path.replace('\\', '/')
                        # å°è·¯å¾‘é€²è¡Œ URL ç·¨ç¢¼ï¼Œä½†ä¿ç•™æ–œç·š
                        parts = normalized_path.split('/')
                        encoded_parts = [urllib.parse.quote(part) for part in parts]
                        return '/'.join(encoded_parts)

                    # ç¢ºä¿å­—å¹•ç›®éŒ„å­˜åœ¨
                    os.makedirs('subtitles', exist_ok=True)
                    
                    # ç”Ÿæˆè‡¨æ™‚å­—å¹•æª”æ¡ˆè·¯å¾‘
                    temp_srt = os.path.join('subtitles', 'temp_subtitle.srt')
                    
                    # æª¢æŸ¥å­—å¹•å…§å®¹
                    try:
                        with open(temp_srt, 'r', encoding='utf-8') as f:
                            subtitle_content = f.read()
                            self.log(f"å­—å¹•æª”æ¡ˆå…§å®¹ï¼š\n{subtitle_content[:500]}...", level='debug')
                            
                            # æª¢æŸ¥å­—å¹•æ ¼å¼
                            if not subtitle_content.strip():
                                raise Exception("å­—å¹•æª”æ¡ˆç‚ºç©º")
                            
                            # æª¢æŸ¥å­—å¹•ç·¨ç¢¼
                            if not subtitle_content.encode('utf-8').decode('utf-8'):
                                raise Exception("å­—å¹•æª”æ¡ˆç·¨ç¢¼å¯èƒ½æœ‰å•é¡Œ")
                    except Exception as e:
                        self.log(f"å­—å¹•æª”æ¡ˆæª¢æŸ¥å¤±æ•—ï¼š{str(e)}", level='error')
                        raise

                    # ä½¿ç”¨ ffprobe ç²å–å½±ç‰‡å°ºå¯¸
                    ffprobe_path = os.path.join(os.path.dirname(ffmpeg_path), 'ffprobe.exe')
                    probe_cmd = f'"{ffprobe_path}" -v error -select_streams v:0 -show_entries stream=width,height -of json "{escape_path(video_path)}"'
                    
                    try:
                        probe_result = subprocess.run(probe_cmd, shell=True, capture_output=True, text=True)
                        video_info = json.loads(probe_result.stdout)
                        width = video_info['streams'][0]['width']
                        height = video_info['streams'][0]['height']
                        video_size = f"{width}x{height}"
                        self.log(f"å½±ç‰‡å°ºå¯¸ï¼š{video_size}", level='debug')
                    except Exception as e:
                        self.log(f"ç„¡æ³•ç²å–å½±ç‰‡å°ºå¯¸ï¼š{str(e)}", level='error')
                        video_size = "1080x1920"  # é è¨­å°ºå¯¸

                    # ç²å–é¸æ“‡çš„å­—é«”å’Œå¤§å°
                    font_name = font_combo.currentFont().family()
                    font_size = size_spinbox.value()

                    # æº–å‚™ ffmpeg å­—å¹•æ¿¾é¡åƒæ•¸ã€‚
                    # 1. å°‡è·¯å¾‘ä¸­çš„åæ–œç·šæ›¿æ›ç‚ºæ­£æ–œç·šï¼Œé€™æ˜¯ ffmpeg æ›´åå¥½çš„æ ¼å¼ã€‚
                    escaped_srt_path = temp_srt.replace(os.sep, '/')
                    # 2. æ§‹å»º filter å­—ä¸²ã€‚force_style çš„å€¼ç”¨å–®å¼•è™ŸåŒ…èµ·ä¾†ï¼Œä»¥è™•ç†å­—é«”åç¨±ä¸­çš„ç©ºæ ¼ã€‚
                    vf_filter = f"subtitles={escaped_srt_path}:force_style='FontName={font_name},FontSize={font_size}'"

                    # ä½¿ç”¨æ›´ç©©å®šçš„ç·¨ç¢¼è¨­å®š
                    cmd = [
                        ffmpeg_path, '-y', '-i', video_path, '-vf', vf_filter,
                        '-c:v', 'libx264', '-preset', 'medium', '-crf', '23', '-c:a', 'copy', output_video
                    ]

                    # åŸ·è¡Œ ffmpeg å‘½ä»¤ä¸¦å³æ™‚é¡¯ç¤ºè¼¸å‡º
                    process = subprocess.Popen(
                        cmd, # ç§»é™¤ shell=True ä»¥æé«˜å®‰å…¨æ€§ä¸¦é¿å…è½‰ç¾©å•é¡Œ
                        stdout=subprocess.PIPE,
                        stderr=subprocess.PIPE,
                        encoding='utf-8',
                        errors='replace',
                        bufsize=1,
                        universal_newlines=True
                    )
                    # å³æ™‚è®€å–è¼¸å‡º
                    error_output = []
                    while True:
                        output = process.stderr.readline()
                        if output == '' and process.poll() is not None:
                            break
                        if output:
                            error_output.append(output.strip())
                            self.log(f"FFmpeg: {output.strip()}", level='debug')

                    # ç­‰å¾…é€²ç¨‹å®Œæˆ
                    return_code = process.wait()

                    if return_code != 0:
                        error_message = '\n'.join(error_output)
                        self.log(f"FFmpeg åŸ·è¡Œå¤±æ•—ï¼ŒéŒ¯èª¤ä»£ç¢¼: {return_code}", level='error')
                        self.log(f"éŒ¯èª¤è©³æƒ…:\n{error_message}", level='error')
                        
                        # æª¢æŸ¥å­—å¹•æª”æ¡ˆæ˜¯å¦å­˜åœ¨
                        if not os.path.exists(temp_srt):
                            raise Exception(f"å­—å¹•æª”æ¡ˆä¸å­˜åœ¨: {temp_srt}")
                        
                        # æª¢æŸ¥å­—å¹•æª”æ¡ˆå…§å®¹
                        try:
                            with open(temp_srt, 'r', encoding='utf-8') as f:
                                content = f.read()
                                if not content.strip():
                                    raise Exception("å­—å¹•æª”æ¡ˆç‚ºç©º")
                        except Exception as e:
                            raise Exception(f"ç„¡æ³•è®€å–å­—å¹•æª”æ¡ˆ: {str(e)}")
                        
                        raise Exception(f"FFmpeg è™•ç†å¤±æ•—: {error_message}")

                    # æª¢æŸ¥è¼¸å‡ºæª”æ¡ˆæ˜¯å¦å­˜åœ¨
                    if not os.path.exists(output_video):
                        raise Exception("è¼¸å‡ºæª”æ¡ˆæœªç”Ÿæˆ")

                    # æª¢æŸ¥è¼¸å‡ºæª”æ¡ˆå¤§å°
                    if os.path.getsize(output_video) == 0:
                        raise Exception("è¼¸å‡ºæª”æ¡ˆå¤§å°ç‚º 0")

                    self.log("å½±ç‰‡è™•ç†å®Œæˆ", level='info')

                    # æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
                    try:
                        os.remove(temp_srt)
                    except:
                        pass

                    progress.close()
                    QMessageBox.information(
                        self,
                        'å®Œæˆ',
                        f'å­—å¹•å·²æˆåŠŸåµŒå…¥åˆ°æ–°å½±ç‰‡ï¼š\n{output_video}'
                    )
                    dialog.accept()

                except Exception as e:
                    progress.close()
                    QMessageBox.critical(self, 'éŒ¯èª¤', f'åµŒå…¥å­—å¹•æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}')
            
            save_button.clicked.connect(save_changes)
            cancel_button.clicked.connect(dialog.reject)
            
            # é¡¯ç¤ºå°è©±æ¡†
            dialog.exec_()
            
        except Exception as e:
            QMessageBox.critical(self, 'éŒ¯èª¤', f'è®€å–å­—å¹•æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}')

    def on_transcription_error(self, error_msg, progress):
        """å­—å¹•ç”ŸæˆéŒ¯èª¤çš„è™•ç†"""
        progress.close()
        QMessageBox.critical(self, 'éŒ¯èª¤', f'ç”Ÿæˆå­—å¹•æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{error_msg}')

class LoadConvertedVideoEvent(QEvent):
    EVENT_TYPE = QEvent.Type(QEvent.registerEventType())
    def __init__(self, file_path):
        super().__init__(self.EVENT_TYPE)
        self.file_path = file_path

class DownloadThread(QThread):
    finished = pyqtSignal(bool, str)  # æˆåŠŸ/å¤±æ•—, è¨Šæ¯
    
    def __init__(self, model_size):
        super().__init__()
        self.model_size = model_size
    
    def run(self):
        try:
            import whisper
            import os
            import requests
            from tqdm import tqdm
            
            # å»ºç«‹æ¨¡å‹ç›®éŒ„
            model_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'models')
            os.makedirs(model_dir, exist_ok=True)
            
            # æ¨¡å‹æª”æ¡ˆåç¨±
            model_name = f"ggml-{self.model_size}.bin"
            model_path = os.path.join(model_dir, model_name)
            
            # å¦‚æœæ¨¡å‹å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›
            if os.path.exists(model_path):
                self.finished.emit(True, f'æ¨¡å‹ {self.model_size} å·²å­˜åœ¨ï¼')
                return
            
            # ä¸‹è¼‰æ¨¡å‹
            url = f"https://huggingface.co/ggerganov/whisper.cpp/resolve/main/{model_name}"
            response = requests.get(url, stream=True)
            total_size = int(response.headers.get('content-length', 0))
            
            with open(model_path, 'wb') as f, tqdm(
                desc=f"ä¸‹è¼‰ {model_name}",
                total=total_size,
                unit='iB',
                unit_scale=True,
                unit_divisor=1024,
            ) as pbar:
                for data in response.iter_content(chunk_size=1024):
                    size = f.write(data)
                    pbar.update(size)
            
            self.finished.emit(True, f'æ¨¡å‹ {self.model_size} ä¸‹è¼‰å®Œæˆï¼')
        except Exception as e:
            self.finished.emit(False, f'ä¸‹è¼‰æ¨¡å‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}')

    def generate_ai_subtitle(self, model_size: str, language: str):
        """ç”Ÿæˆ AI å­—å¹•"""
        if not hasattr(self, 'current_video_path') or not self.current_video_path:
            QMessageBox.warning(self, 'è­¦å‘Š', 'è«‹å…ˆè¼‰å…¥å½±ç‰‡')
            return
            
        try:
            # æª¢æŸ¥æ¨¡å‹æ˜¯å¦å­˜åœ¨
            model_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'models')
            model_name = f"ggml-{model_size}.bin"
            model_path = os.path.join(model_dir, model_name)
            
            if not os.path.exists(model_path):
                QMessageBox.warning(self, 'è­¦å‘Š', f'è«‹å…ˆä¸‹è¼‰ {model_size} æ¨¡å‹')
                return
            
            # å»ºç«‹è¼¸å‡ºç›®éŒ„
            output_dir = os.path.join(os.path.dirname(self.current_video_path), 'subtitles')
            os.makedirs(output_dir, exist_ok=True)
            
            # è¨­å®šè¼¸å‡ºæª”æ¡ˆè·¯å¾‘
            output_file = os.path.join(output_dir, 
                f"{os.path.splitext(os.path.basename(self.current_video_path))[0]}.srt")
            
            # é¡¯ç¤ºé€²åº¦å°è©±æ¡†
            progress = QProgressDialog('æ­£åœ¨ç”Ÿæˆå­—å¹•...', 'å–æ¶ˆ', 0, 0, self)
            progress.setWindowModality(Qt.WindowModal)
            progress.setWindowTitle('AI å­—å¹•ç”Ÿæˆ')
            
            # è¨­å®šé€²åº¦å°è©±æ¡†æ¨£å¼
            progress.setStyleSheet("""
                QProgressDialog {
                    background-color: #2b2b2b;
                    color: #ffffff;
                }
                QLabel {
                    color: #ffffff;
                }
                QProgressBar {
                    border: 1px solid #3c3c3c;
                    border-radius: 4px;
                    text-align: center;
                    background-color: #1e1e1e;
                }
                QProgressBar::chunk {
                    background-color: #4c4c4c;
                    border-radius: 3px;
                }
                QPushButton {
                    background-color: #3c3c3c;
                    color: #ffffff;
                    border: 1px solid #555555;
                    border-radius: 4px;
                    padding: 5px 15px;
                    min-width: 80px;
                }
                QPushButton:hover {
                    background-color: #4c4c4c;
                }
                QPushButton:pressed {
                    background-color: #2c2c2c;
                }
            """)
            
            progress.show()
            
            # åœ¨æ–°åŸ·è¡Œç·’ä¸­åŸ·è¡Œå­—å¹•ç”Ÿæˆ
            def run_transcription():
                try:
                    from ai import transcribe_to_srt
                    transcribe_to_srt(self.current_video_path, output_file, model_size, language)
                    QMetaObject.invokeMethod(progress, "close", Qt.QueuedConnection)
                    QMessageBox.information(self, 'å®Œæˆ', f'å­—å¹•å·²ç”Ÿæˆï¼š{output_file}')
                except Exception as e:
                    QMetaObject.invokeMethod(progress, "close", Qt.QueuedConnection)
                    QMessageBox.critical(self, 'éŒ¯èª¤', f'ç”Ÿæˆå­—å¹•æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}')
            
            thread = QThread()
            thread.run = run_transcription
            thread.start()
            
        except Exception as e:
            QMessageBox.critical(self, 'éŒ¯èª¤', f'ç”Ÿæˆå­—å¹•æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}')

    def on_video_surface_resize(self, event):
        """è™•ç†å½±ç‰‡æ’­æ”¾å€åŸŸå¤§å°è®ŠåŒ–äº‹ä»¶"""
        if self.media_player and self.media_player.get_media():
            # é‡æ–°è¨­ç½®VLCè¦–çª—å¥æŸ„ä»¥é©æ‡‰æ–°çš„å°ºå¯¸
            try:
                if sys.platform.startswith('win'):
                    self.media_player.set_hwnd(self.video_surface.winId())
                elif sys.platform.startswith('linux'):
                    self.media_player.set_xid(self.video_surface.winId())
                elif sys.platform.startswith('darwin'):
                    self.media_player.set_nsobject(int(self.video_surface.winId()))
                
                # èª¿æ•´å½±ç‰‡å¯¬é«˜æ¯”
                self.adjust_video_aspect_ratio()
                
                self.log(f'å½±ç‰‡æ’­æ”¾å€åŸŸå¤§å°å·²èª¿æ•´ç‚º: {event.size().width()}x{event.size().height()}', 'debug')
            except Exception as e:
                self.log(f'èª¿æ•´å½±ç‰‡æ’­æ”¾å€åŸŸå¤§å°æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}', 'error')
        event.accept()

    def on_main_window_resize(self, event):
        """è™•ç†ä¸»è¦–çª—å¤§å°è®ŠåŒ–äº‹ä»¶"""
        self.log(f'ä¸»è¦–çª—å¤§å°å·²èª¿æ•´ç‚º: {event.size().width()}x{event.size().height()}', 'debug')

    def adjust_video_aspect_ratio(self):
        """èª¿æ•´å½±ç‰‡æ’­æ”¾å€åŸŸçš„å¯¬é«˜æ¯”"""
        if not self.media_player or not self.media_player.get_media():
            return
            
        try:
            # ç²å–å½±ç‰‡çš„åŸå§‹å°ºå¯¸
            media = self.media_player.get_media()
            if media:
                # å˜—è©¦ç²å–å½±ç‰‡çš„å¯¬é«˜æ¯”
                # æ³¨æ„ï¼šVLC Pythonç¶å®šå¯èƒ½ä¸ç›´æ¥æä¾›é€™å€‹ä¿¡æ¯
                # æˆ‘å€‘å¯ä»¥é€šéè¨­ç½®VLCçš„aspect ratioé¸é …ä¾†è™•ç†
                
                # è¨­ç½®VLCçš„å¯¬é«˜æ¯”ç‚ºè‡ªå‹•ï¼Œè®“å®ƒæ ¹æ“šè¦–çª—å¤§å°è‡ªå‹•èª¿æ•´
                self.media_player.video_set_aspect_ratio(None)  # Noneè¡¨ç¤ºè‡ªå‹•
                self.log('å½±ç‰‡å¯¬é«˜æ¯”å·²è¨­ç½®ç‚ºè‡ªå‹•èª¿æ•´', 'debug')
        except Exception as e:
            self.log(f'èª¿æ•´å½±ç‰‡å¯¬é«˜æ¯”æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}', 'error')

    def resizeEvent(self, event):
        """è™•ç†ä¸»è¦–çª—å¤§å°è®ŠåŒ–äº‹ä»¶"""
        self.log(f'ä¸»è¦–çª—å¤§å°å·²èª¿æ•´ç‚º: {event.size().width()}x{event.size().height()}', 'debug')
        # èª¿ç”¨çˆ¶é¡çš„ resizeEvent æ–¹æ³•
        super().resizeEvent(event)

if __name__ == '__main__':
    app = QApplication(sys.argv)
    app.setStyle('Fusion')
    window = YTDLPDownloader()
    window.show()
    sys.exit(app.exec_())